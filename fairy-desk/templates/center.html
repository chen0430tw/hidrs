<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIRY-DESK - ä¸­å± Â· æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
    .center-layout {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 32px);
    }

    /* ä»ªè¡¨ç›˜åŒºåŸŸ */
    .dashboard-section {
      flex-shrink: 0;
      padding: 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
    }

    .metric-card {
      position: relative;
    }

    .metric-card .metric-extra {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ç»ˆç«¯åŒºåŸŸ */
    .terminal-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .terminal-header {
      height: 32px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      flex-shrink: 0;
    }

    .terminal-header .title {
      font-size: 12px;
      color: var(--neon-cyan);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .terminal-tabs {
      display: flex;
      gap: 2px;
    }

    .terminal-tabs button {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 4px 12px;
      font-size: 11px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .terminal-tabs button:hover {
      color: var(--text-primary);
    }

    .terminal-tabs button.active {
      color: var(--neon-cyan);
      border-bottom-color: var(--neon-cyan);
    }

    .terminal-body {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .terminal-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .terminal-content {
      flex: 1;
      overflow: auto;
      background: #0d1117;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-terminal);
      padding: 12px;
    }

    /* AI Agent ä¾§è¾¹æ  */
    .agent-sidebar {
      width: 300px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .agent-header {
      height: 40px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
    }

    .agent-header .agent-avatar {
      font-size: 20px;
    }

    .agent-header .agent-name {
      font-size: 13px;
      color: var(--neon-cyan);
      font-weight: bold;
    }

    .agent-header .agent-status {
      font-size: 10px;
      color: var(--status-success);
      margin-left: auto;
    }

    .agent-body {
      flex: 1;
      overflow: auto;
      padding: 12px;
    }

    .agent-message {
      margin-bottom: 12px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 13px;
    }

    .agent-message.system {
      background: rgba(0, 240, 255, 0.1);
      border-left: 3px solid var(--neon-cyan);
    }

    .agent-input {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    .agent-input input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .agent-input input:focus {
      outline: none;
      border-color: var(--neon-cyan);
    }

    .agent-input button {
      background: var(--neon-cyan);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    /* HIDRS æŒ‡æ ‡ï¼ˆå¦‚æœè¿æ¥ï¼‰ */
    .hidrs-metrics {
      display: none;
    }

    .hidrs-metrics.connected {
      display: grid;
    }
  </style>
</head>
<body data-page="center">
  <div class="screen-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="title">
        ğŸ–¥ï¸ æ§åˆ¶å°
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span id="hidrs-status" class="hidrs-status disconnected">ğŸ”´ HIDRS</span>
        <div class="clock" id="clock">--:--:--</div>
      </div>
    </div>

    <div class="center-layout">
      <!-- ä»ªè¡¨ç›˜ -->
      <div class="dashboard-section">
        <div class="dashboard-grid">
          <!-- ç³»ç»ŸæŒ‡æ ‡ -->
          <div class="metric-card" id="metric-cpu">
            <div class="metric-icon">ğŸ’»</div>
            <div class="metric-value">--%</div>
            <div class="metric-label">CPU</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>

          <div class="metric-card" id="metric-memory">
            <div class="metric-icon">ğŸ§ </div>
            <div class="metric-value">--%</div>
            <div class="metric-label">å†…å­˜</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">--/-- GB</div>
          </div>

          <div class="metric-card" id="metric-gpu">
            <div class="metric-icon">ğŸ®</div>
            <div class="metric-value">--%</div>
            <div class="metric-label">GPU</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">--/-- MB</div>
          </div>

          <div class="metric-card" id="metric-network">
            <div class="metric-icon">ğŸŒ</div>
            <div class="metric-value">--</div>
            <div class="metric-label">ç½‘ç»œ</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">-- è¿æ¥</div>
          </div>

          <!-- HIDRS æŒ‡æ ‡ï¼ˆä»…åœ¨è¿æ¥æ—¶æ˜¾ç¤ºï¼‰ -->
          <div class="metric-card hidrs-metrics" id="metric-nodes">
            <div class="metric-icon">ğŸ”—</div>
            <div class="metric-value">--</div>
            <div class="metric-label">èŠ‚ç‚¹æ•°</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>

          <div class="metric-card hidrs-metrics" id="metric-fiedler">
            <div class="metric-icon">ğŸ“Š</div>
            <div class="metric-value">--</div>
            <div class="metric-label">Fiedler</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>
        </div>
      </div>

      <!-- ç»ˆç«¯ + Agent -->
      <div class="terminal-section">
        <div class="terminal-header">
          <div class="title">ç³»ç»Ÿæ—¥å¿—</div>
          <div class="terminal-tabs">
            <button class="active" onclick="switchTerminalTab('logs')">æ—¥å¿—</button>
            <button onclick="switchTerminalTab('terminal')">ç»ˆç«¯</button>
            <button onclick="switchTerminalTab('claude')" style="color: #00f0ff;">ğŸ§š Claude</button>
          </div>
        </div>

        <div class="terminal-body">
          <div class="terminal-main">
            <div class="terminal-content" id="system-logs">
              <!-- æ—¥å¿—ç”± JS åŠ¨æ€æ¸²æŸ“ -->
            </div>
            <!-- Claude Code ç»ˆç«¯ iframe -->
            <iframe id="claude-terminal" src="" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
          </div>

          <!-- AI Agent ä¾§è¾¹æ  -->
          <div class="agent-sidebar">
            <div class="agent-header">
              <span class="agent-avatar">ğŸ§š</span>
              <span class="agent-name">AI AGENT</span>
              <span class="agent-status">â— ACTIVE</span>
            </div>
            <div class="agent-body" id="agent-messages">
              <div class="agent-message system">
                <strong>FAIRY ASSISTANT</strong><br>
                ç³»ç»Ÿå·²å°±ç»ªã€‚Claude Code ä½¿ç”¨æ–¹å¼ï¼š
              </div>
              <div class="agent-message" style="background: var(--bg-panel); font-size: 12px;">
                <strong style="color: var(--neon-cyan);">ğŸ–¥ï¸ ç»ˆç«¯æ¨¡å¼</strong><br>
                åœ¨ç³»ç»Ÿç»ˆç«¯è¿è¡Œï¼š<code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude</code><br><br>
                <strong style="color: var(--neon-cyan);">ğŸŒ Web æ¨¡å¼</strong><br>
                è®¿é—® <a href="https://claude.ai/code" target="_blank" style="color: var(--neon-cyan);">claude.ai/code</a> æˆ–ä½¿ç”¨ <code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude &</code> å‰ç¼€å‘é€ä»»åŠ¡<br><br>
                <strong style="color: var(--neon-cyan);">ğŸ”— Chrome é›†æˆ</strong><br>
                å®‰è£… Claude in Chrome æ‰©å±•åè¿è¡Œï¼š<code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude --chrome</code>
              </div>
            </div>
            <div class="agent-input">
              <input type="text" id="agent-input" placeholder="è¾“å…¥å‘½ä»¤æˆ–é—®é¢˜..." onkeypress="if(event.key==='Enter')sendAgentMessage()">
              <button onclick="sendAgentMessage()">å‘é€</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/core.js"></script>
  <script>
    // ä¸­å±ç‰¹å®šé€»è¾‘

    let currentTerminalTab = 'logs';

    function switchTerminalTab(tab) {
      currentTerminalTab = tab;

      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.terminal-tabs button').forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        const isActive = (tab === 'logs' && btnText.includes('æ—¥å¿—')) ||
                         (tab === 'terminal' && btnText.includes('ç»ˆç«¯') && !btnText.includes('claude')) ||
                         (tab === 'claude' && btnText.includes('claude'));
        btn.classList.toggle('active', isActive);
      });

      const content = document.getElementById('system-logs');
      const claudeFrame = document.getElementById('claude-terminal');

      if (tab === 'claude') {
        // Claude Code ç»ˆç«¯
        content.style.display = 'none';
        claudeFrame.style.display = 'block';
        if (!claudeFrame.src || claudeFrame.src === '' || claudeFrame.src === 'about:blank') {
          claudeFrame.src = '/widget/terminal';
        }
      } else if (tab === 'terminal') {
        // æ¨¡æ‹Ÿç»ˆç«¯
        content.style.display = 'block';
        claudeFrame.style.display = 'none';
        content.innerHTML = `
          <div class="terminal-line" style="color: var(--neon-cyan);">
            FAIRY-DESK Terminal v1.0.0
          </div>
          <div class="terminal-line" style="color: var(--text-muted);">
            è¾“å…¥ 'claude' åˆ‡æ¢åˆ° Claude Code ç»ˆç«¯
          </div>
          <div class="terminal-line" style="color: var(--text-muted);">
            è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤
          </div>
          <div class="terminal-input">
            <span class="prompt">$</span>
            <input type="text" id="terminal-input" onkeypress="if(event.key==='Enter')executeCommand(this.value)">
          </div>
        `;
        document.getElementById('terminal-input')?.focus();
      } else {
        // æ—¥å¿—
        content.style.display = 'block';
        claudeFrame.style.display = 'none';
        content.innerHTML = '';
        initSystemLogs();
      }
    }

    function executeCommand(cmd) {
      const content = document.getElementById('system-logs');
      const input = document.getElementById('terminal-input');

      // æ·»åŠ å‘½ä»¤åˆ°è¾“å‡º
      const cmdLine = document.createElement('div');
      cmdLine.className = 'terminal-line';
      cmdLine.innerHTML = `<span style="color: var(--neon-green);">$ ${escapeHtml(cmd)}</span>`;
      content.insertBefore(cmdLine, content.lastElementChild);

      // å¤„ç†å‘½ä»¤
      let output = '';
      const cmdLower = cmd.toLowerCase().trim();

      if (cmdLower === 'help') {
        output = `å¯ç”¨å‘½ä»¤:
  claude    - å¯åŠ¨ Claude Code
  clear     - æ¸…å±
  status    - ç³»ç»ŸçŠ¶æ€
  hidrs     - HIDRS è¿æ¥çŠ¶æ€
  help      - æ˜¾ç¤ºå¸®åŠ©`;
      } else if (cmdLower === 'clear') {
        switchTerminalTab('terminal');
        return;
      } else if (cmdLower === 'status') {
        output = `FAIRY-DESK è¿è¡Œä¸­
CPU: ${document.querySelector('#metric-cpu .metric-value')?.textContent || '--'}
å†…å­˜: ${document.querySelector('#metric-memory .metric-value')?.textContent || '--'}
HIDRS: ${FairyDesk.hidrsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`;
      } else if (cmdLower === 'hidrs') {
        output = FairyDesk.hidrsConnected
          ? 'HIDRS å·²è¿æ¥ï¼Œå…¨éƒ¨åŠŸèƒ½å¯ç”¨'
          : 'HIDRS æœªè¿æ¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™\nè¿è¡Œ HIDRS åå¯è·å¾—ç½‘ç»œæ‹“æ‰‘ç›‘æ§ã€å…¨æ¯æœç´¢ç­‰åŠŸèƒ½';
      } else if (cmdLower === 'claude') {
        output = 'æ­£åœ¨åˆ‡æ¢åˆ° Claude Code ç»ˆç«¯...';
        showNotification('åˆ‡æ¢åˆ° Claude Code ç»ˆç«¯', 'info');
        setTimeout(() => switchTerminalTab('claude'), 500);
      } else if (cmd.trim()) {
        output = `å‘½ä»¤æœªæ‰¾åˆ°: ${cmd}\nè¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤`;
      }

      if (output) {
        const outputLine = document.createElement('div');
        outputLine.className = 'terminal-line';
        outputLine.style.whiteSpace = 'pre-wrap';
        outputLine.textContent = output;
        content.insertBefore(outputLine, content.lastElementChild);
      }

      input.value = '';
      content.scrollTop = content.scrollHeight;
    }

    function sendAgentMessage() {
      const input = document.getElementById('agent-input');
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById('agent-messages');

      // ç”¨æˆ·æ¶ˆæ¯
      const userMsg = document.createElement('div');
      userMsg.className = 'agent-message';
      userMsg.style.textAlign = 'right';
      userMsg.style.background = 'var(--bg-panel)';
      userMsg.textContent = message;
      container.appendChild(userMsg);

      // æ¨¡æ‹Ÿ Agent å“åº”
      setTimeout(() => {
        const agentMsg = document.createElement('div');
        agentMsg.className = 'agent-message system';

        let response = '';
        const msgLower = message.toLowerCase();

        if (msgLower.includes('claude') || msgLower.includes('code')) {
          response = `Claude Code ä½¿ç”¨æŒ‡å—ï¼š<br><br>
            <b>1. ç»ˆç«¯æ¨¡å¼</b> - åœ¨ç³»ç»Ÿç»ˆç«¯è¿è¡Œ <code>claude</code><br>
            <b>2. Web æ¨¡å¼</b> - è®¿é—® <a href="https://claude.ai/code" target="_blank">claude.ai/code</a><br>
            <b>3. åå°ä»»åŠ¡</b> - è¾“å…¥ <code>& ä½ çš„ä»»åŠ¡</code> å‘é€åˆ° Web æ‰§è¡Œ<br>
            <b>4. Chrome é›†æˆ</b> - è¿è¡Œ <code>claude --chrome</code> è¿æ¥æµè§ˆå™¨<br>
            <b>5. ä¼šè¯ä¼ é€</b> - è¿è¡Œ <code>/teleport</code> æ‹‰å– Web ä¼šè¯åˆ°æœ¬åœ°`;
        } else if (msgLower.includes('hidrs') || msgLower.includes('è¿æ¥')) {
          response = FairyDesk.hidrsConnected
            ? 'âœ… HIDRS å·²è¿æ¥ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚'
            : 'âš ï¸ HIDRS æœªè¿æ¥ã€‚å¯åŠ¨ HIDRS å¯è·å¾—:\nâ€¢ ç½‘ç»œæ‹“æ‰‘ç›‘æ§\nâ€¢ Fiedler å€¼æ£€æµ‹\nâ€¢ å…¨æ¯æœç´¢\nâ€¢ å†³ç­–åé¦ˆ';
        } else if (msgLower.includes('help') || msgLower.includes('å¸®åŠ©')) {
          response = 'æˆ‘å¯ä»¥å¸®ä½ :\nâ€¢ æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€\nâ€¢ å¯åŠ¨ Claude Code\nâ€¢ æ£€æŸ¥ HIDRS è¿æ¥\nâ€¢ è§£ç­”ä½¿ç”¨é—®é¢˜\n\næœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„ï¼Ÿ';
        } else {
          response = 'æ”¶åˆ°ï¼æˆ‘ä¼šå°½åŠ›å¸®åŠ©ä½ ã€‚å¦‚æœéœ€è¦æ‰§è¡Œå‘½ä»¤ï¼Œè¯·åˆ‡æ¢åˆ°ç»ˆç«¯æ ‡ç­¾é¡µã€‚';
        }

        agentMsg.innerHTML = `<strong>ğŸ§š FAIRY</strong><br>${response}`;
        container.appendChild(agentMsg);
        container.scrollTop = container.scrollHeight;
      }, 500);

      input.value = '';
      container.scrollTop = container.scrollHeight;
    }

    // æ›´æ–° HIDRS æŒ‡æ ‡æ˜¾ç¤º
    function updateHIDRSMetrics() {
      if (!FairyDesk.hidrsConnected) return;

      document.querySelectorAll('.hidrs-metrics').forEach(el => {
        el.classList.add('connected');
      });

      // è·å– HIDRS æ•°æ®
      fetch('/api/hidrs/proxy/api/network/metrics')
        .then(resp => resp.json())
        .then(data => {
          if (data.current_metrics) {
            updateMetric('nodes', data.current_metrics.node_count || 0, '');
            updateMetric('fiedler', (data.current_metrics.fiedler_value || 0).toFixed(3), '');
          }
        })
        .catch(() => {});
    }

    // å®šæœŸæ£€æŸ¥ HIDRS
    setInterval(() => {
      if (FairyDesk.hidrsConnected) {
        updateHIDRSMetrics();
      }
    }, 10000);
  </script>
</body>
</html>
