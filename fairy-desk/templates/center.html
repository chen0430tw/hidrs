<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='.9em' font-size='90'&gt;ğŸ§¿&lt;/text&gt;&lt;/svg&gt;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIRY-DESK - ä¸­å± Â· æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
    .center-layout {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 32px);
    }

    /* ä»ªè¡¨ç›˜åŒºåŸŸ */
    .dashboard-section {
      flex-shrink: 0;
      padding: 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
    }

    .metric-card {
      position: relative;
    }

    .metric-card .metric-extra {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ç»ˆç«¯åŒºåŸŸ */
    .terminal-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .terminal-header {
      height: 32px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      flex-shrink: 0;
    }

    .terminal-header .title {
      font-size: 12px;
      color: var(--neon-cyan);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .terminal-tabs {
      display: flex;
      gap: 2px;
    }

    .terminal-tabs button {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 4px 12px;
      font-size: 11px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .terminal-tabs button:hover {
      color: var(--text-primary);
    }

    .terminal-tabs button.active {
      color: var(--neon-cyan);
      border-bottom-color: var(--neon-cyan);
    }

    .terminal-body {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .terminal-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .terminal-content {
      flex: 1;
      overflow: auto;
      background: #0d1117;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-terminal);
      padding: 12px;
    }

    /* AI Agent ä¾§è¾¹æ  */
    .agent-sidebar {
      width: 300px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .agent-header {
      height: 40px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
    }

    .agent-header .agent-avatar {
      font-size: 20px;
    }

    .agent-header .agent-name {
      font-size: 13px;
      color: var(--neon-cyan);
      font-weight: bold;
    }

    .agent-header .agent-status {
      font-size: 10px;
      color: var(--status-success);
      margin-left: auto;
    }

    .agent-body {
      flex: 1;
      overflow: auto;
      padding: 12px;
    }

    .agent-message {
      margin-bottom: 12px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 13px;
    }

    .agent-message.system {
      background: rgba(0, 240, 255, 0.1);
      border-left: 3px solid var(--neon-cyan);
    }

    .agent-input {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    .agent-input input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .agent-input input:focus {
      outline: none;
      border-color: var(--neon-cyan);
    }

    .agent-input button {
      background: var(--neon-cyan);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    /* HIDRS æŒ‡æ ‡ï¼ˆå¦‚æœè¿æ¥ï¼‰ */
    .hidrs-metrics {
      display: none;
    }

    .hidrs-metrics.connected {
      display: grid;
    }
  </style>
</head>
<body data-page="center">
  <div class="screen-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="title">
        ğŸ–¥ï¸ æ§åˆ¶å°
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span id="hidrs-status" class="hidrs-status disconnected">ğŸ”´ HIDRS</span>
        <div class="clock" id="clock">--:--:--</div>
      </div>
    </div>

    <div class="center-layout">
      <!-- ä»ªè¡¨ç›˜ -->
      <div class="dashboard-section">
        <div class="dashboard-grid">
          <!-- ç³»ç»ŸæŒ‡æ ‡ -->
          <div class="metric-card" id="metric-cpu">
            <div class="metric-icon">ğŸ’»</div>
            <div class="metric-value">--%</div>
            <div class="metric-label">CPU</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>

          <div class="metric-card" id="metric-memory">
            <div class="metric-icon">ğŸ§ </div>
            <div class="metric-value">--%</div>
            <div class="metric-label">å†…å­˜</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">--/-- GB</div>
          </div>

          <div class="metric-card" id="metric-gpu">
            <div class="metric-icon">ğŸ®</div>
            <div class="metric-value">--%</div>
            <div class="metric-label">GPU</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">--/-- MB</div>
          </div>

          <div class="metric-card" id="metric-network">
            <div class="metric-icon">ğŸŒ</div>
            <div class="metric-value">--</div>
            <div class="metric-label">ç½‘ç»œ</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
            <div class="metric-extra">-- è¿æ¥</div>
          </div>

          <!-- HIDRS æŒ‡æ ‡ï¼ˆä»…åœ¨è¿æ¥æ—¶æ˜¾ç¤ºï¼‰ -->
          <div class="metric-card hidrs-metrics" id="metric-nodes">
            <div class="metric-icon">ğŸ”—</div>
            <div class="metric-value">--</div>
            <div class="metric-label">èŠ‚ç‚¹æ•°</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>

          <div class="metric-card hidrs-metrics" id="metric-fiedler">
            <div class="metric-icon">ğŸ“Š</div>
            <div class="metric-value">--</div>
            <div class="metric-label">Fiedler</div>
            <div class="metric-bar"><div class="metric-bar-fill" style="width: 0%"></div></div>
          </div>
        </div>
      </div>

      <!-- ç»ˆç«¯ + Agent -->
      <div class="terminal-section">
        <div class="terminal-header">
          <div class="title">ç³»ç»Ÿæ§åˆ¶å°</div>
          <div class="terminal-tabs">
            <button class="active" onclick="switchTerminalTab('logs')">æ—¥å¿—</button>
            <button onclick="switchTerminalTab('terminal')">ç»ˆç«¯</button>
            <button onclick="switchTerminalTab('claude')" style="color: #00f0ff;">ğŸ§¿ Claude</button>
            <button id="btn-connect-claude" onclick="connectClaude()" style="color: #0a0e17; background: var(--neon-cyan); border-radius: 3px; padding: 2px 10px; font-size: 10px; margin-left: 8px;">ğŸš€ è¿æ¥</button>
          </div>
        </div>

        <div class="terminal-body">
          <div class="terminal-main">
            <div class="terminal-content" id="system-logs">
              <!-- æ—¥å¿—ç”± JS åŠ¨æ€æ¸²æŸ“ -->
            </div>
            <!-- ttyd çœŸå®ç»ˆç«¯ iframe -->
            <iframe id="ttyd-terminal" src="" style="display: none; flex: 1; width: 100%; border: none; background: #0d1117;"></iframe>
            <!-- Claude Code ç»ˆç«¯ iframe -->
            <iframe id="claude-terminal" src="" style="display: none; flex: 1; width: 100%; border: none;"></iframe>
          </div>

          <!-- AI Agent ä¾§è¾¹æ  -->
          <div class="agent-sidebar">
            <div class="agent-header">
              <span class="agent-avatar">ğŸ§¿</span>
              <span class="agent-name">AI AGENT</span>
              <span class="agent-status">â— ACTIVE</span>
            </div>
            <div class="agent-body" id="agent-messages">
              <div class="agent-message system">
                <strong>FAIRY ASSISTANT</strong><br>
                ç³»ç»Ÿå·²å°±ç»ªã€‚Claude Code ä½¿ç”¨æ–¹å¼ï¼š
              </div>
              <div class="agent-message" style="background: var(--bg-panel); font-size: 12px;">
                <strong style="color: var(--neon-cyan);">ğŸ–¥ï¸ ç»ˆç«¯æ¨¡å¼</strong><br>
                åœ¨ç³»ç»Ÿç»ˆç«¯è¿è¡Œï¼š<code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude</code><br><br>
                <strong style="color: var(--neon-cyan);">ğŸŒ Web æ¨¡å¼</strong><br>
                è®¿é—® <a href="https://claude.ai/code" target="_blank" style="color: var(--neon-cyan);">claude.ai/code</a> æˆ–ä½¿ç”¨ <code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude &</code> å‰ç¼€å‘é€ä»»åŠ¡<br><br>
                <strong style="color: var(--neon-cyan);">ğŸ”— Chrome é›†æˆ</strong><br>
                å®‰è£… Claude in Chrome æ‰©å±•åè¿è¡Œï¼š<code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">claude --chrome</code>
              </div>
            </div>
            <div class="agent-input">
              <input type="text" id="agent-input" placeholder="è¾“å…¥å‘½ä»¤æˆ–é—®é¢˜..." onkeypress="if(event.key==='Enter')sendAgentMessage()">
              <button onclick="sendAgentMessage()">å‘é€</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/core.js"></script>
  <script>
    // ä¸­å±ç‰¹å®šé€»è¾‘

    let currentTerminalTab = 'logs';
    let ttydUrl = null;       // æ¢æµ‹åˆ°çš„ ttyd åœ°å€
    let ttydChecked = false;  // æ˜¯å¦å·²æ¢æµ‹
    let claudeConnected = false;  // Claude æ˜¯å¦å·²ç›´è¿
    let claudeWebUrl = null;      // æ¢æµ‹åˆ°çš„ claude-code-web åœ°å€

    // æ¢æµ‹ ttyd æ˜¯å¦å¯ç”¨ï¼ˆno-cors å› ä¸º ttyd ä¸è¿”å› CORS å¤´ï¼‰
    async function detectTtyd() {
      if (ttydChecked) return ttydUrl;
      var ports = [7681, 7682, 7680];
      for (var i = 0; i < ports.length; i++) {
        var url = 'http://localhost:' + ports[i];
        try {
          var resp = await fetch(url, {
            method: 'HEAD',
            mode: 'no-cors',
            signal: AbortSignal.timeout(2000)
          });
          // no-cors æˆåŠŸè¿”å› opaque responseï¼ˆstatus=0, type='opaque'ï¼‰
          // å¤±è´¥åˆ™æŠ›å¼‚å¸¸è¿› catch
          ttydUrl = url;
          break;
        } catch (e) { /* ç«¯å£ä¸é€šï¼Œç»§ç»­ */ }
      }
      ttydChecked = true;
      return ttydUrl;
    }

    // æ¢æµ‹ claude-code-web æ˜¯å¦å¯ç”¨ï¼ˆä» center.html å±‚çº§ç›´è¿ï¼‰
    async function detectClaudeWeb() {
      // å¦‚æœ localStorage æœ‰ä¿å­˜çš„åœ°å€ï¼Œä¼˜å…ˆå°è¯•
      var saved = localStorage.getItem('claude-web-url');
      if (saved) {
        var ok = await probeUrl(saved);
        if (ok) { claudeWebUrl = saved; return saved; }
      }
      // æ¢æµ‹å¸¸ç”¨ç«¯å£
      var ports = [32352, 3000, 3001];
      for (var i = 0; i < ports.length; i++) {
        var url = 'http://localhost:' + ports[i];
        var ok = await probeUrl(url);
        if (ok) {
          claudeWebUrl = url;
          localStorage.setItem('claude-web-url', url);
          return url;
        }
      }
      return null;
    }

    async function probeUrl(url) {
      // å…ˆè¯• /health
      try {
        var resp = await fetch(url + '/health', {
          method: 'GET', mode: 'cors',
          signal: AbortSignal.timeout(3000)
        });
        if (resp.ok) return true;
      } catch (e) {}
      // å›é€€ HEAD
      try {
        var resp2 = await fetch(url, {
          method: 'HEAD', mode: 'cors',
          signal: AbortSignal.timeout(3000)
        });
        return resp2.ok || resp2.type === 'opaque';
      } catch (e) { return false; }
    }

    // è¿æ¥ Claudeï¼ˆæŒ‰é’® + tab é¦–æ¬¡ç‚¹å‡»å…±ç”¨ï¼‰
    async function connectClaude() {
      var claudeFrame = document.getElementById('claude-terminal');
      var content = document.getElementById('system-logs');
      var ttydFrame = document.getElementById('ttyd-terminal');

      // åˆ‡åˆ° Claude tab
      currentTerminalTab = 'claude';
      updateTabState('claude');
      content.style.display = 'none';
      ttydFrame.style.display = 'none';
      claudeFrame.style.display = 'block';

      // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
      claudeFrame.src = 'about:blank';
      claudeFrame.style.background = '#0a0e17';

      // ç›´æ¥ä» center.html å±‚çº§æ¢æµ‹ claude-code-web
      var url = await detectClaudeWeb();

      if (url) {
        // æ‰¾åˆ°äº†ï¼Œç›´æ¥åŠ è½½ claude-code-webï¼ˆè·³è¿‡ terminal.html ä¸­é—´å±‚ï¼‰
        var token = localStorage.getItem('claude-web-token') || '';
        var loadUrl = url;
        if (token) {
          loadUrl += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);
        }
        claudeFrame.src = loadUrl;
        claudeConnected = true;
        localStorage.setItem('claude-web-autoconnect', 'true');
      } else {
        // æ²¡æ‰¾åˆ°ï¼ŒåŠ è½½ terminal.html è®¾ç½®é¢æ¿ä½œä¸ºå›é€€
        claudeFrame.src = '/widget/terminal';
        claudeConnected = false;
      }
    }

    function updateTabState(tab) {
      document.querySelectorAll('.terminal-tabs button').forEach(function(btn) {
        if (btn.id === 'btn-connect-claude') return;
        var btnText = btn.textContent.toLowerCase();
        var isActive = (tab === 'logs' && btnText.includes('æ—¥å¿—')) ||
                       (tab === 'terminal' && btnText.includes('ç»ˆç«¯') && !btnText.includes('claude')) ||
                       (tab === 'claude' && btnText.includes('claude'));
        btn.classList.toggle('active', isActive);
      });
    }

    function switchTerminalTab(tab) {
      currentTerminalTab = tab;
      updateTabState(tab);

      var content = document.getElementById('system-logs');
      var claudeFrame = document.getElementById('claude-terminal');
      var ttydFrame = document.getElementById('ttyd-terminal');

      if (tab === 'claude') {
        content.style.display = 'none';
        ttydFrame.style.display = 'none';
        claudeFrame.style.display = 'block';

        if (claudeConnected && claudeFrame.src && claudeFrame.src !== 'about:blank') {
          // å·²è¿æ¥ï¼Œç›´æ¥æ˜¾ç¤º
          return;
        }
        // é¦–æ¬¡ç‚¹å‡»æˆ–æœªè¿æ¥ â†’ è§¦å‘è‡ªåŠ¨è¿æ¥ï¼ˆä¸è¿æ¥æŒ‰é’®ç›¸åŒé€»è¾‘ï¼‰
        connectClaude();
      } else if (tab === 'terminal') {
        // ttyd çœŸå®ç»ˆç«¯ï¼ˆæˆ–å›é€€åˆ°æ¨¡æ‹Ÿç»ˆç«¯ï¼‰
        claudeFrame.style.display = 'none';

        if (ttydChecked && ttydUrl) {
          // å·²æ¢æµ‹åˆ° ttydï¼Œç›´æ¥æ˜¾ç¤º
          content.style.display = 'none';
          ttydFrame.style.display = 'block';
          if (!ttydFrame.src || ttydFrame.src === '' || ttydFrame.src === 'about:blank') {
            ttydFrame.src = ttydUrl;
          }
        } else if (ttydChecked && !ttydUrl) {
          // å·²æ¢æµ‹è¿‡ï¼Œæ²¡æœ‰ ttydï¼Œç›´æ¥æ˜¾ç¤ºå›é€€ç»ˆç«¯
          content.style.display = 'block';
          ttydFrame.style.display = 'none';
          showFallbackTerminal(content);
        } else {
          // é¦–æ¬¡ï¼šå…ˆæ˜¾ç¤º content åŒºåŸŸï¼ˆæ¸…ç©ºæ—§å†…å®¹ï¼‰ï¼Œå¼‚æ­¥æ¢æµ‹
          content.style.display = 'block';
          ttydFrame.style.display = 'none';
          content.innerHTML = '';
          var loadingMsg = document.createElement('div');
          loadingMsg.className = 'terminal-line';
          loadingMsg.style.color = 'var(--text-muted)';
          loadingMsg.textContent = 'æ­£åœ¨æ£€æµ‹ç»ˆç«¯æœåŠ¡...';
          content.appendChild(loadingMsg);
          loadTtydOrFallback(content, ttydFrame);
        }
      } else {
        // æ—¥å¿—
        content.style.display = 'block';
        claudeFrame.style.display = 'none';
        ttydFrame.style.display = 'none';
        content.innerHTML = '';
        initSystemLogs();
      }
    }

    async function loadTtydOrFallback(content, ttydFrame) {
      var url = await detectTtyd();
      if (url) {
        // ttyd å¯ç”¨ï¼ŒåŠ è½½ iframe
        content.style.display = 'none';
        ttydFrame.style.display = 'block';
        if (!ttydFrame.src || ttydFrame.src === '' || ttydFrame.src === 'about:blank') {
          ttydFrame.src = url;
        }
      } else {
        // ttyd ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºå®‰è£…æç¤º + æ¨¡æ‹Ÿç»ˆç«¯
        content.style.display = 'block';
        ttydFrame.style.display = 'none';
        showFallbackTerminal(content);
      }
    }

    function showFallbackTerminal(content) {
      content.innerHTML = '';

      var banner = document.createElement('div');
      banner.className = 'terminal-line';
      banner.style.color = 'var(--neon-cyan)';
      banner.textContent = 'FAIRY-DESK Terminal v1.0.0';
      content.appendChild(banner);

      var ttydHint = document.createElement('div');
      ttydHint.className = 'terminal-line';
      ttydHint.style.cssText = 'color: #eab308; margin: 8px 0; padding: 8px; background: rgba(234,179,8,0.1); border-radius: 4px; font-size: 12px;';
      ttydHint.textContent = 'ğŸ’¡ å®‰è£… ttyd å¯è·å¾—çœŸå®ç»ˆç«¯ä½“éªŒï¼ˆå®¡è®¡æ›´æ–¹ä¾¿ï¼‰ï¼špip install ttyd æˆ– brew install ttydï¼Œç„¶åè¿è¡Œ ttyd -p 7681 bash';
      content.appendChild(ttydHint);

      var helpLine = document.createElement('div');
      helpLine.className = 'terminal-line';
      helpLine.style.color = 'var(--text-muted)';
      helpLine.textContent = "è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤";
      content.appendChild(helpLine);

      var inputDiv = document.createElement('div');
      inputDiv.className = 'terminal-input';

      var prompt = document.createElement('span');
      prompt.className = 'prompt';
      prompt.textContent = '$';
      inputDiv.appendChild(prompt);

      var input = document.createElement('input');
      input.type = 'text';
      input.id = 'terminal-input';
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') executeCommand(this.value);
      });
      inputDiv.appendChild(input);

      content.appendChild(inputDiv);
      input.focus();
    }

    function executeCommand(cmd) {
      var content = document.getElementById('system-logs');
      var input = document.getElementById('terminal-input');

      // æ·»åŠ å‘½ä»¤åˆ°è¾“å‡º
      var cmdLine = document.createElement('div');
      cmdLine.className = 'terminal-line';
      var cmdSpan = document.createElement('span');
      cmdSpan.style.color = 'var(--neon-green)';
      cmdSpan.textContent = '$ ' + cmd;
      cmdLine.appendChild(cmdSpan);
      content.insertBefore(cmdLine, content.lastElementChild);

      // å¤„ç†å‘½ä»¤
      var output = '';
      var cmdLower = cmd.toLowerCase().trim();

      if (cmdLower === 'help') {
        output = 'å¯ç”¨å‘½ä»¤:\n  claude    - å¯åŠ¨ Claude Code\n  clear     - æ¸…å±\n  status    - ç³»ç»ŸçŠ¶æ€\n  hidrs     - HIDRS è¿æ¥çŠ¶æ€\n  help      - æ˜¾ç¤ºå¸®åŠ©';
      } else if (cmdLower === 'clear') {
        switchTerminalTab('terminal');
        return;
      } else if (cmdLower === 'status') {
        output = 'FAIRY-DESK è¿è¡Œä¸­\n' +
          'CPU: ' + (document.querySelector('#metric-cpu .metric-value')?.textContent || '--') + '\n' +
          'å†…å­˜: ' + (document.querySelector('#metric-memory .metric-value')?.textContent || '--') + '\n' +
          'HIDRS: ' + (FairyDesk.hidrsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
      } else if (cmdLower === 'hidrs') {
        output = FairyDesk.hidrsConnected
          ? 'HIDRS å·²è¿æ¥ï¼Œå…¨éƒ¨åŠŸèƒ½å¯ç”¨'
          : 'HIDRS æœªè¿æ¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™\nè¿è¡Œ HIDRS åå¯è·å¾—ç½‘ç»œæ‹“æ‰‘ç›‘æ§ã€å…¨æ¯æœç´¢ç­‰åŠŸèƒ½';
      } else if (cmdLower === 'claude') {
        output = 'æ­£åœ¨åˆ‡æ¢åˆ° Claude Code ç»ˆç«¯...';
        showNotification('åˆ‡æ¢åˆ° Claude Code ç»ˆç«¯', 'info');
        setTimeout(function() { switchTerminalTab('claude'); }, 500);
      } else if (cmd.trim()) {
        output = 'å‘½ä»¤æœªæ‰¾åˆ°: ' + cmd + '\nè¾“å…¥ \'help\' æŸ¥çœ‹å¯ç”¨å‘½ä»¤';
      }

      if (output) {
        var outputLine = document.createElement('div');
        outputLine.className = 'terminal-line';
        outputLine.style.whiteSpace = 'pre-wrap';
        outputLine.textContent = output;
        content.insertBefore(outputLine, content.lastElementChild);
      }

      input.value = '';
      content.scrollTop = content.scrollHeight;
    }

    function sendAgentMessage() {
      const input = document.getElementById('agent-input');
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById('agent-messages');

      // ç”¨æˆ·æ¶ˆæ¯
      const userMsg = document.createElement('div');
      userMsg.className = 'agent-message';
      userMsg.style.textAlign = 'right';
      userMsg.style.background = 'var(--bg-panel)';
      userMsg.textContent = message;
      container.appendChild(userMsg);

      // æ¨¡æ‹Ÿ Agent å“åº”
      setTimeout(() => {
        const agentMsg = document.createElement('div');
        agentMsg.className = 'agent-message system';

        let response = '';
        const msgLower = message.toLowerCase();

        if (msgLower.includes('claude') || msgLower.includes('code')) {
          response = `Claude Code ä½¿ç”¨æŒ‡å—ï¼š<br><br>
            <b>1. ç»ˆç«¯æ¨¡å¼</b> - åœ¨ç³»ç»Ÿç»ˆç«¯è¿è¡Œ <code>claude</code><br>
            <b>2. Web æ¨¡å¼</b> - è®¿é—® <a href="https://claude.ai/code" target="_blank">claude.ai/code</a><br>
            <b>3. åå°ä»»åŠ¡</b> - è¾“å…¥ <code>& ä½ çš„ä»»åŠ¡</code> å‘é€åˆ° Web æ‰§è¡Œ<br>
            <b>4. Chrome é›†æˆ</b> - è¿è¡Œ <code>claude --chrome</code> è¿æ¥æµè§ˆå™¨<br>
            <b>5. ä¼šè¯ä¼ é€</b> - è¿è¡Œ <code>/teleport</code> æ‹‰å– Web ä¼šè¯åˆ°æœ¬åœ°`;
        } else if (msgLower.includes('hidrs') || msgLower.includes('è¿æ¥')) {
          response = FairyDesk.hidrsConnected
            ? 'âœ… HIDRS å·²è¿æ¥ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚'
            : 'âš ï¸ HIDRS æœªè¿æ¥ã€‚å¯åŠ¨ HIDRS å¯è·å¾—:\nâ€¢ ç½‘ç»œæ‹“æ‰‘ç›‘æ§\nâ€¢ Fiedler å€¼æ£€æµ‹\nâ€¢ å…¨æ¯æœç´¢\nâ€¢ å†³ç­–åé¦ˆ';
        } else if (msgLower.includes('help') || msgLower.includes('å¸®åŠ©')) {
          response = 'æˆ‘å¯ä»¥å¸®ä½ :\nâ€¢ æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€\nâ€¢ å¯åŠ¨ Claude Code\nâ€¢ æ£€æŸ¥ HIDRS è¿æ¥\nâ€¢ è§£ç­”ä½¿ç”¨é—®é¢˜\n\næœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„ï¼Ÿ';
        } else {
          response = 'æ”¶åˆ°ï¼æˆ‘ä¼šå°½åŠ›å¸®åŠ©ä½ ã€‚å¦‚æœéœ€è¦æ‰§è¡Œå‘½ä»¤ï¼Œè¯·åˆ‡æ¢åˆ°ç»ˆç«¯æ ‡ç­¾é¡µã€‚';
        }

        agentMsg.innerHTML = `<strong>ğŸ§¿ FAIRY</strong><br>${response}`;
        container.appendChild(agentMsg);
        container.scrollTop = container.scrollHeight;
      }, 500);

      input.value = '';
      container.scrollTop = container.scrollHeight;
    }

    // æ›´æ–° HIDRS æŒ‡æ ‡æ˜¾ç¤º
    function updateHIDRSMetrics() {
      if (!FairyDesk.hidrsConnected) return;

      document.querySelectorAll('.hidrs-metrics').forEach(el => {
        el.classList.add('connected');
      });

      // è·å– HIDRS æ•°æ®
      fetch('/api/hidrs/proxy/api/network/metrics')
        .then(resp => resp.json())
        .then(data => {
          if (data.current_metrics) {
            updateMetric('nodes', data.current_metrics.node_count || 0, '');
            updateMetric('fiedler', (data.current_metrics.fiedler_value || 0).toFixed(3), '');
          }
        })
        .catch(() => {});
    }

    // å®šæœŸæ£€æŸ¥ HIDRS
    setInterval(() => {
      if (FairyDesk.hidrsConnected) {
        updateHIDRSMetrics();
      }
    }, 10000);
  </script>
</body>
</html>
