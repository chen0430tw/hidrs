<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='.9em' font-size='90'&gt;ğŸ§¿&lt;/text&gt;&lt;/svg&gt;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIRY-DESK - è®¾ç½®</title>
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
    .settings-container {
      height: calc(100vh - 32px);
      overflow-y: auto;
      padding: 24px;
    }

    .settings-section {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .settings-section-header {
      background: var(--bg-tertiary);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .settings-section-header .icon {
      font-size: 20px;
    }

    .settings-section-header .title {
      font-size: 16px;
      font-weight: bold;
      color: var(--neon-cyan);
    }

    .settings-section-body {
      padding: 20px;
    }

    .settings-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-row:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .settings-label {
      width: 200px;
      flex-shrink: 0;
    }

    .settings-label .label-title {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .settings-label .label-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .settings-control {
      flex: 1;
    }

    /* Tab åˆ—è¡¨ */
    .tab-list {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .tab-list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      gap: 12px;
    }

    .tab-list-item:last-child {
      border-bottom: none;
    }

    .tab-list-item .tab-icon {
      font-size: 18px;
      width: 30px;
      text-align: center;
    }

    .tab-list-item .tab-info {
      flex: 1;
    }

    .tab-list-item .tab-name {
      font-size: 14px;
      color: var(--text-primary);
    }

    .tab-list-item .tab-url {
      font-size: 11px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-list-item .tab-strategy {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .tab-list-item .tab-strategy.background {
      background: rgba(16, 185, 129, 0.2);
      color: var(--status-success);
    }

    .tab-list-item .tab-actions {
      display: flex;
      gap: 8px;
    }

    .tab-list-item .tab-actions button {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    .tab-list-item .tab-actions button:hover {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }

    .tab-list-item .tab-actions button.danger:hover {
      border-color: var(--status-danger);
      color: var(--status-danger);
    }

    /* RSS åˆ—è¡¨ */
    .rss-list {
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    .rss-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      gap: 12px;
    }

    .rss-item:last-child {
      border-bottom: none;
    }

    .rss-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .rss-item .rss-name {
      width: 120px;
      font-size: 13px;
    }

    .rss-item .rss-url {
      flex: 1;
      font-size: 11px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ä¸»é¢˜é¢„è§ˆ */
    .theme-preview {
      display: flex;
      gap: 16px;
    }

    .theme-option {
      width: 100px;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-option:hover {
      border-color: var(--neon-cyan);
    }

    .theme-option.active {
      border-color: var(--neon-cyan);
      box-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
    }

    .theme-option .preview-box {
      height: 40px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .theme-option .theme-name {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* CCTV æ‘„åƒå¤´ç®¡ç† */
    .camera-list {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }

    .camera-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      gap: 10px;
    }

    .camera-item:last-child {
      border-bottom: none;
    }

    .camera-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .camera-item .cam-index {
      font-size: 10px;
      color: var(--text-muted);
      width: 36px;
      flex-shrink: 0;
      font-family: monospace;
    }

    .camera-item .cam-info {
      flex: 1;
      min-width: 0;
    }

    .camera-item .cam-name-text {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .camera-item .cam-url-text {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .camera-item .cam-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .camera-item .cam-actions button {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    .camera-item .cam-actions button:hover {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }

    .camera-item .cam-actions button.danger:hover {
      border-color: var(--status-danger);
      color: var(--status-danger);
    }

    .camera-edit-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }

    .camera-edit-row input {
      font-size: 13px;
    }

    .grid-size-options {
      display: flex;
      gap: 8px;
    }

    .grid-size-option {
      padding: 8px 16px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .grid-size-option:hover {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }

    .grid-size-option.active {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
      background: rgba(0, 240, 255, 0.1);
      box-shadow: 0 0 8px rgba(0, 240, 255, 0.2);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .settings-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-footer .left-actions {
      display: flex;
      gap: 12px;
    }

    .settings-footer .right-actions {
      display: flex;
      gap: 12px;
    }

    /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
    .settings-container {
      padding-bottom: 80px;
    }
  </style>
</head>
<body data-page="settings">
  <div class="screen-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="title">
        âš™ï¸ è®¾ç½®
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <a href="/" style="color: var(--text-secondary); text-decoration: none; font-size: 12px;">â† è¿”å›é¦–é¡µ</a>
        <div class="clock" id="clock">--:--:--</div>
      </div>
    </div>

    <div class="settings-container">
      <!-- å·¦å±è®¾ç½® -->
      <div class="settings-section" id="left-settings">
        <div class="settings-section-header">
          <span class="icon">ğŸ“¹</span>
          <span class="title">å·¦å±è®¾ç½® - æ€åŠ¿ç›‘æ§</span>
        </div>
        <div class="settings-section-body">
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">é»˜è®¤åˆ†é¡µ</div>
              <div class="label-desc">å¯åŠ¨æ—¶æ˜¾ç¤ºçš„åˆ†é¡µ</div>
            </div>
            <div class="settings-control">
              <select id="default-tab" class="form-input form-select" style="width: 200px;">
                <!-- ç”± JS å¡«å…… -->
              </select>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">åˆ†é¡µç®¡ç†</div>
              <div class="label-desc">æ·»åŠ ã€ç¼–è¾‘æˆ–åˆ é™¤åˆ†é¡µ</div>
            </div>
            <div class="settings-control">
              <div class="tab-list" id="tab-list">
                <!-- ç”± JS å¡«å…… -->
              </div>
              <button class="btn btn-secondary" style="margin-top: 12px;" onclick="showAddTabModal()">
                + æ·»åŠ æ–°åˆ†é¡µ
              </button>
            </div>
          </div>

          <!-- CCTV æ‘„åƒå¤´ç®¡ç† -->
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">CCTV ç½‘æ ¼</div>
              <div class="label-desc">æ‘„åƒå¤´æ˜¾ç¤ºå¸ƒå±€</div>
            </div>
            <div class="settings-control">
              <div class="grid-size-options" id="grid-size-options">
                <button class="grid-size-option" data-grid="2x2" onclick="selectGrid('2x2')">2Ã—2</button>
                <button class="grid-size-option active" data-grid="3x3" onclick="selectGrid('3x3')">3Ã—3</button>
                <button class="grid-size-option" data-grid="4x4" onclick="selectGrid('4x4')">4Ã—4</button>
              </div>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">æ‘„åƒå¤´ç®¡ç†</div>
              <div class="label-desc">æ·»åŠ ã€ç¼–è¾‘æˆ–åˆ é™¤ CCTV æ‘„åƒå¤´æº</div>
            </div>
            <div class="settings-control">
              <div class="camera-list" id="camera-list">
                <!-- ç”± JS å¡«å…… -->
              </div>
              <div class="camera-edit-row">
                <input type="text" id="new-cam-name" class="form-input" style="width: 140px;" placeholder="æ‘„åƒå¤´åç§°">
                <input type="text" id="new-cam-url" class="form-input" style="flex: 1;" placeholder="ä»»æ„å¯åµŒå…¥çš„è§†é¢‘æµ URL">
                <button class="btn btn-secondary" onclick="addCamera()">æ·»åŠ </button>
              </div>
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; line-height: 1.6;">
                æ”¯æŒæ ¼å¼ï¼šiframe åµŒå…¥é¡µï¼ˆYouTube/ç½‘ç«™ï¼‰ã€MJPEG ä¸²æµï¼ˆ.mjpgï¼‰ã€HLS ä¸²æµï¼ˆ.m3u8ï¼‰ã€å›¾ç‰‡å¿«ç…§ï¼ˆ.jpgï¼‰<br>
                YouTube ä¼šè‡ªåŠ¨è½¬æ¢ watch é“¾æ¥ä¸º embed æ ¼å¼ ï½œ MJPEG/å›¾ç‰‡ä¼šä»¥ &lt;img&gt; æ–¹å¼åµŒå…¥
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸­å±è®¾ç½® -->
      <div class="settings-section" id="center-settings">
        <div class="settings-section-header">
          <span class="icon">ğŸ–¥ï¸</span>
          <span class="title">ä¸­å±è®¾ç½® - æ§åˆ¶å°</span>
        </div>
        <div class="settings-section-body">
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">åˆ·æ–°é—´éš”</div>
              <div class="label-desc">ç³»ç»Ÿç›‘æ§æ•°æ®åˆ·æ–°é¢‘ç‡</div>
            </div>
            <div class="settings-control">
              <input type="number" id="refresh-interval" class="form-input" style="width: 100px;" min="1" max="60" value="5"> ç§’
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">ç»ˆç«¯å‘½ä»¤</div>
              <div class="label-desc">Agent å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤</div>
            </div>
            <div class="settings-control">
              <input type="text" id="terminal-command" class="form-input" style="width: 300px;" placeholder="claude">
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">ç»ˆç«¯èƒŒæ™¯é¢œè‰²</div>
              <div class="label-desc">æ§åˆ¶å°ç»ˆç«¯åŒºåŸŸçš„èƒŒæ™¯è‰²</div>
            </div>
            <div class="settings-control">
              <div style="display: flex; align-items: center; gap: 12px;">
                <input type="color" id="terminal-bg-color" value="#0d1117" style="width: 48px; height: 32px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); cursor: pointer;">
                <input type="text" id="terminal-bg-color-hex" class="form-input" style="width: 120px; font-family: monospace;" placeholder="#0d1117">
                <div style="display: flex; gap: 6px;">
                  <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="setTermBg('#0d1117')">é»˜è®¤</button>
                  <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="setTermBg('#000000')">çº¯é»‘</button>
                  <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="setTermBg('#1a1b26')">Tokyo Night</button>
                  <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="setTermBg('#282c34')">One Dark</button>
                  <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="setTermBg('#0d1a0d')">Matrix</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³å±è®¾ç½® -->
      <div class="settings-section" id="right-settings">
        <div class="settings-section-header">
          <span class="icon">ğŸ“Š</span>
          <span class="title">å³å±è®¾ç½® - æƒ…æŠ¥è§†çª—</span>
        </div>
        <div class="settings-section-body">
          <!-- ç¤¾äº¤åª’ä½“ -->
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">ç¤¾äº¤åª’ä½“ URL</div>
              <div class="label-desc">ç¬¬ä¸€æ åµŒå…¥çš„ç½‘å€</div>
            </div>
            <div class="settings-control">
              <input type="url" id="social-url" class="form-input" placeholder="https://x.com/home">
            </div>
          </div>

          <!-- æ–°é—» RSS -->
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">æ–°é—» RSS æº</div>
              <div class="label-desc">å‹¾é€‰å¯ç”¨çš„æ–°é—»æº</div>
            </div>
            <div class="settings-control">
              <div class="rss-list" id="rss-list">
                <!-- ç”± JS å¡«å…… -->
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <input type="text" id="new-rss-name" class="form-input" style="width: 120px;" placeholder="åç§°">
                <input type="url" id="new-rss-url" class="form-input" style="flex: 1;" placeholder="RSS URL">
                <button class="btn btn-secondary" onclick="addRSSFeed()">æ·»åŠ </button>
              </div>
            </div>
          </div>

          <!-- è‚¡ç¥¨ -->
          <div class="settings-row" id="stocks">
            <div class="settings-label">
              <div class="label-title">è‚¡ç¥¨ä»£ç </div>
              <div class="label-desc">TradingView æ˜¾ç¤ºçš„è‚¡ç¥¨</div>
            </div>
            <div class="settings-control">
              <input type="text" id="stock-symbols" class="form-input" placeholder="AAPL, GOOGL, BTCUSD">
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                ç”¨é€—å·åˆ†éš”ï¼Œæ”¯æŒæ ¼å¼ï¼šAAPL, NASDAQ:MSFT, BINANCE:BTCUSDT
              </div>
            </div>
          </div>

          <!-- é«˜äº®å…³é”®è¯ -->
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">é«˜äº®å…³é”®è¯</div>
              <div class="label-desc">åŒ…å«è¿™äº›è¯çš„æ–°é—»ä¼šé«˜äº®æ˜¾ç¤º</div>
            </div>
            <div class="settings-control">
              <input type="text" id="highlight-keywords" class="form-input" placeholder="breaking, urgent, åœ°éœ‡, æˆ˜äº‰">
            </div>
          </div>
        </div>
      </div>

      <!-- HIDRS è®¾ç½® -->
      <div class="settings-section" id="hidrs-settings">
        <div class="settings-section-header">
          <span class="icon">ğŸ”®</span>
          <span class="title">HIDRS è®¾ç½®</span>
        </div>
        <div class="settings-section-body">
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">HIDRS ç«¯ç‚¹</div>
              <div class="label-desc">HIDRS æœåŠ¡å™¨åœ°å€</div>
            </div>
            <div class="settings-control">
              <input type="url" id="hidrs-endpoint" class="form-input" style="width: 300px;" placeholder="http://localhost:5000">
              <button class="btn btn-secondary" style="margin-left: 8px;" onclick="testHIDRSConnection()">æµ‹è¯•è¿æ¥</button>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">è‡ªåŠ¨æ£€æµ‹</div>
              <div class="label-desc">è‡ªåŠ¨æ£€æµ‹ HIDRS è¿æ¥çŠ¶æ€</div>
            </div>
            <div class="settings-control">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="hidrs-auto-detect" style="width: 16px; height: 16px;">
                <span>å¯ç”¨è‡ªåŠ¨æ£€æµ‹</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸»é¢˜è®¾ç½® -->
      <div class="settings-section" id="theme-settings">
        <div class="settings-section-header">
          <span class="icon">ğŸ¨</span>
          <span class="title">ä¸»é¢˜è®¾ç½®</span>
        </div>
        <div class="settings-section-body">
          <div class="settings-row">
            <div class="settings-label">
              <div class="label-title">é…è‰²æ–¹æ¡ˆ</div>
              <div class="label-desc">é€‰æ‹©ç•Œé¢ä¸»é¢˜</div>
            </div>
            <div class="settings-control">
              <div class="theme-preview">
                <div class="theme-option active" data-theme="cyberpunk">
                  <div class="preview-box" style="background: linear-gradient(135deg, #0a0e17, #1a1f2e); border: 1px solid #00f0ff;"></div>
                  <div class="theme-name">èµ›åšæœ‹å…‹</div>
                </div>
                <div class="theme-option" data-theme="matrix">
                  <div class="preview-box" style="background: linear-gradient(135deg, #0d1a0d, #1a2e1a); border: 1px solid #00ff00;"></div>
                  <div class="theme-name">é»‘å®¢å¸å›½</div>
                </div>
                <div class="theme-option" data-theme="midnight">
                  <div class="preview-box" style="background: linear-gradient(135deg, #1a1a2e, #2e2e4a); border: 1px solid #6366f1;"></div>
                  <div class="theme-name">åˆå¤œè“</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="settings-footer">
      <div class="left-actions">
        <button class="btn btn-secondary" onclick="resetToDefault()">æ¢å¤é»˜è®¤</button>
        <button class="btn btn-secondary" onclick="exportConfig()">å¯¼å‡ºé…ç½®</button>
        <button class="btn btn-secondary" onclick="importConfig()">å¯¼å…¥é…ç½®</button>
      </div>
      <div class="right-actions">
        <button class="btn btn-secondary" onclick="location.href='/'">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAllSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <script src="/static/js/core.js"></script>
  <script>
    // è®¾ç½®é¡µé¢ç‰¹å®šé€»è¾‘

    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      populateSettings();
    });

    function populateSettings() {
      const config = FairyDesk.config;
      if (!config) return;

      // å·¦å± Tab
      const tabs = config.left_screen?.tabs || [];
      const defaultTabSelect = document.getElementById('default-tab');
      const tabList = document.getElementById('tab-list');

      defaultTabSelect.innerHTML = tabs.map(t =>
        `<option value="${t.id}" ${t.id === config.left_screen?.default_tab ? 'selected' : ''}>${t.icon} ${t.name}</option>`
      ).join('');

      tabList.innerHTML = tabs.map(t => `
        <div class="tab-list-item">
          <span class="tab-icon">${t.icon}</span>
          <div class="tab-info">
            <div class="tab-name">${t.name}</div>
            <div class="tab-url">${t.url}</div>
          </div>
          <span class="tab-strategy ${t.loadStrategy}">${t.loadStrategy === 'background' ? 'èƒŒæ™¯åŒæ­¥' : t.loadStrategy === 'smart' ? 'æ™ºèƒ½' : 'æ‡’åŠ è½½'}</span>
          <div class="tab-actions">
            <button onclick="editTab('${t.id}')">ç¼–è¾‘</button>
            ${!t.builtIn ? `<button class="danger" onclick="removeTab('${t.id}')">åˆ é™¤</button>` : ''}
          </div>
        </div>
      `).join('');

      // CCTV æ‘„åƒå¤´
      populateCameras();

      // ä¸­å±
      document.getElementById('refresh-interval').value = config.center_screen?.refresh_interval || 5;
      document.getElementById('terminal-command').value = config.center_screen?.terminal_command || 'claude';

      // ç»ˆç«¯èƒŒæ™¯è‰²
      var termBg = config.theme?.terminal_bg_color || '#0d1117';
      document.getElementById('terminal-bg-color').value = termBg;
      document.getElementById('terminal-bg-color-hex').value = termBg;

      // å³å±
      document.getElementById('social-url').value = config.right_screen?.social?.url || 'https://x.com/home';

      const feeds = config.right_screen?.news?.feeds || [];
      document.getElementById('rss-list').innerHTML = feeds.map((f, i) => `
        <div class="rss-item">
          <input type="checkbox" ${f.enabled !== false ? 'checked' : ''} data-index="${i}">
          <span class="rss-name">${f.name}</span>
          <span class="rss-url">${f.url}</span>
        </div>
      `).join('');

      document.getElementById('stock-symbols').value = (config.right_screen?.stocks?.symbols || []).join(', ');
      document.getElementById('highlight-keywords').value = (config.right_screen?.news?.highlight_keywords || []).join(', ');

      // HIDRS
      document.getElementById('hidrs-endpoint').value = config.hidrs?.endpoint || 'http://localhost:5000';
      document.getElementById('hidrs-auto-detect').checked = config.hidrs?.auto_detect !== false;

      // ä¸»é¢˜
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.theme === (config.theme?.name || 'cyberpunk'));
        opt.onclick = () => {
          document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
          // å®æ—¶é¢„è§ˆä¸»é¢˜
          applyTheme(opt.dataset.theme);
        };
      });
    }

    // ç»ˆç«¯èƒŒæ™¯è‰²å¿«æ·è®¾ç½®
    function setTermBg(color) {
      document.getElementById('terminal-bg-color').value = color;
      document.getElementById('terminal-bg-color-hex').value = color;
    }

    // åŒæ­¥ color picker å’Œ hex input
    document.getElementById('terminal-bg-color').addEventListener('input', function() {
      document.getElementById('terminal-bg-color-hex').value = this.value;
    });
    document.getElementById('terminal-bg-color-hex').addEventListener('input', function() {
      if (/^#[0-9a-fA-F]{6}$/.test(this.value)) {
        document.getElementById('terminal-bg-color').value = this.value;
      }
    });

    // ===== CCTV æ‘„åƒå¤´ç®¡ç† =====

    function selectGrid(size) {
      document.querySelectorAll('.grid-size-option').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.grid === size);
      });
    }

    function populateCameras() {
      var cctvCfg = FairyDesk.config.left_screen?.cctv || { grid: '3x3', cameras: [] };
      var cameras = cctvCfg.cameras || [];

      // ç½‘æ ¼å¤§å°
      selectGrid(cctvCfg.grid || '3x3');

      // æ‘„åƒå¤´åˆ—è¡¨
      var list = document.getElementById('camera-list');
      list.innerHTML = '';

      cameras.forEach(function(cam, i) {
        var item = document.createElement('div');
        item.className = 'camera-item';
        item.dataset.index = i;

        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = cam.enabled !== false;
        cb.dataset.camIndex = i;
        item.appendChild(cb);

        var idx = document.createElement('span');
        idx.className = 'cam-index';
        idx.textContent = 'CAM-' + String(i + 1).padStart(2, '0');
        item.appendChild(idx);

        var info = document.createElement('div');
        info.className = 'cam-info';
        var nameSpan = document.createElement('div');
        nameSpan.className = 'cam-name-text';
        nameSpan.textContent = cam.name || '(æœªå‘½å)';
        info.appendChild(nameSpan);
        var urlSpan = document.createElement('div');
        urlSpan.className = 'cam-url-text';
        urlSpan.textContent = cam.url || '';
        info.appendChild(urlSpan);
        item.appendChild(info);

        var actions = document.createElement('div');
        actions.className = 'cam-actions';

        var editBtn = document.createElement('button');
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.addEventListener('click', function() { editCamera(i); });
        actions.appendChild(editBtn);

        var delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.textContent = 'åˆ é™¤';
        delBtn.addEventListener('click', function() { removeCamera(i); });
        actions.appendChild(delBtn);

        item.appendChild(actions);
        list.appendChild(item);
      });
    }

    function addCamera() {
      var name = document.getElementById('new-cam-name').value.trim();
      var url = document.getElementById('new-cam-url').value.trim();

      if (!name || !url) {
        showNotification('è¯·å¡«å†™æ‘„åƒå¤´åç§°å’Œ URL', 'error');
        return;
      }

      // è‡ªåŠ¨è¡¥å…¨ YouTube embed URL
      var ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      if (ytMatch) {
        url = 'https://www.youtube.com/embed/' + ytMatch[1] + '?autoplay=1&mute=1&controls=0';
      }

      if (!FairyDesk.config.left_screen.cctv) {
        FairyDesk.config.left_screen.cctv = { grid: '3x3', cameras: [] };
      }

      FairyDesk.config.left_screen.cctv.cameras.push({
        name: name,
        url: url,
        enabled: true
      });

      document.getElementById('new-cam-name').value = '';
      document.getElementById('new-cam-url').value = '';

      populateCameras();
      showNotification('æ‘„åƒå¤´å·²æ·»åŠ ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
    }

    function editCamera(index) {
      var cameras = FairyDesk.config.left_screen?.cctv?.cameras;
      if (!cameras || !cameras[index]) return;

      var cam = cameras[index];
      var newName = prompt('æ‘„åƒå¤´åç§°ï¼š', cam.name);
      if (newName === null) return;

      var newUrl = prompt('è§†é¢‘æµ URLï¼š', cam.url);
      if (newUrl === null) return;

      // è‡ªåŠ¨è¡¥å…¨ YouTube embed URL
      var ytMatch = newUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      if (ytMatch) {
        newUrl = 'https://www.youtube.com/embed/' + ytMatch[1] + '?autoplay=1&mute=1&controls=0';
      }

      cam.name = newName.trim() || cam.name;
      cam.url = newUrl.trim() || cam.url;

      populateCameras();
      showNotification('æ‘„åƒå¤´å·²æ›´æ–°ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
    }

    function removeCamera(index) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ‘„åƒå¤´ï¼Ÿ')) return;

      var cameras = FairyDesk.config.left_screen?.cctv?.cameras;
      if (cameras) {
        cameras.splice(index, 1);
        populateCameras();
        showNotification('æ‘„åƒå¤´å·²åˆ é™¤ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
      }
    }

    async function saveAllSettings() {
      const config = FairyDesk.config;

      // æ”¶é›†è®¾ç½®
      config.left_screen.default_tab = document.getElementById('default-tab').value;
      config.center_screen.refresh_interval = parseInt(document.getElementById('refresh-interval').value) || 5;
      config.center_screen.terminal_command = document.getElementById('terminal-command').value;

      config.right_screen.social.url = document.getElementById('social-url').value;

      // RSS å¯ç”¨çŠ¶æ€
      document.querySelectorAll('#rss-list input[type="checkbox"]').forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (config.right_screen.news.feeds[index]) {
          config.right_screen.news.feeds[index].enabled = cb.checked;
        }
      });

      config.right_screen.stocks.symbols = document.getElementById('stock-symbols').value
        .split(',').map(s => s.trim()).filter(s => s);

      config.right_screen.news.highlight_keywords = document.getElementById('highlight-keywords').value
        .split(',').map(s => s.trim()).filter(s => s);

      config.hidrs.endpoint = document.getElementById('hidrs-endpoint').value;
      config.hidrs.auto_detect = document.getElementById('hidrs-auto-detect').checked;

      config.theme.name = document.querySelector('.theme-option.active')?.dataset.theme || 'cyberpunk';
      config.theme.terminal_bg_color = document.getElementById('terminal-bg-color').value || '#0d1117';

      // CCTV æ‘„åƒå¤´
      var activeGrid = document.querySelector('.grid-size-option.active');
      if (!config.left_screen.cctv) config.left_screen.cctv = { grid: '3x3', cameras: [] };
      config.left_screen.cctv.grid = activeGrid ? activeGrid.dataset.grid : '3x3';

      // æ›´æ–°æ‘„åƒå¤´å¯ç”¨çŠ¶æ€
      document.querySelectorAll('#camera-list input[type="checkbox"]').forEach(function(cb) {
        var idx = parseInt(cb.dataset.camIndex);
        if (config.left_screen.cctv.cameras[idx]) {
          config.left_screen.cctv.cameras[idx].enabled = cb.checked;
        }
      });

      // ä¿å­˜
      const success = await saveConfig(config);
      if (success) {
        showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
      }
    }

    function addRSSFeed() {
      const name = document.getElementById('new-rss-name').value.trim();
      const url = document.getElementById('new-rss-url').value.trim();

      if (!name || !url) {
        showNotification('è¯·å¡«å†™åç§°å’Œ URL', 'error');
        return;
      }

      FairyDesk.config.right_screen.news.feeds.push({ name, url, enabled: true });
      populateSettings();

      document.getElementById('new-rss-name').value = '';
      document.getElementById('new-rss-url').value = '';

      showNotification('RSS æºå·²æ·»åŠ ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
    }

    function editTab(tabId) {
      const tab = FairyDesk.config.left_screen.tabs.find(t => t.id === tabId);
      if (tab) showEditTabModal(tab);
    }

    async function removeTab(tabId) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†é¡µï¼Ÿ')) return;

      const tabs = FairyDesk.config.left_screen.tabs;
      const index = tabs.findIndex(t => t.id === tabId);
      if (index > -1) {
        tabs.splice(index, 1);
        populateSettings();
        showNotification('åˆ†é¡µå·²åˆ é™¤ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
      }
    }

    async function testHIDRSConnection() {
      const endpoint = document.getElementById('hidrs-endpoint').value;
      try {
        const resp = await fetch(`${endpoint}/health`, {
          signal: AbortSignal.timeout(3000)
        });
        if (resp.ok) {
          showNotification('HIDRS è¿æ¥æˆåŠŸï¼', 'success');
        } else {
          showNotification('HIDRS è¿æ¥å¤±è´¥', 'error');
        }
      } catch {
        showNotification('HIDRS æ— æ³•è¿æ¥', 'error');
      }
    }

    async function resetToDefault() {
      if (!confirm('ç¡®å®šæ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿæ‰€æœ‰è‡ªå®šä¹‰é…ç½®å°†ä¸¢å¤±ã€‚')) return;
      try {
        const resp = await fetch(`${API_BASE}/api/config/reset`, { method: 'POST' });
        if (resp.ok) {
          showNotification('å·²æ¢å¤é»˜è®¤é…ç½®', 'success');
          await loadConfig();
          populateSettings();
        } else {
          showNotification('æ¢å¤å¤±è´¥', 'error');
        }
      } catch {
        showNotification('æ¢å¤å¤±è´¥', 'error');
      }
    }

    function exportConfig() {
      const blob = new Blob([JSON.stringify(FairyDesk.config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fairy-desk-config.json';
      a.click();
      URL.revokeObjectURL(url);
      showNotification('é…ç½®å·²å¯¼å‡º', 'success');
    }

    function importConfig() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const config = JSON.parse(text);
          FairyDesk.config = config;
          populateSettings();
          showNotification('é…ç½®å·²å¯¼å…¥ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰', 'success');
        } catch {
          showNotification('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
        }
      };
      input.click();
    }
  </script>
</body>
</html>
