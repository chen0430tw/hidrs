<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='.9em' font-size='90'&gt;ğŸ§¿&lt;/text&gt;&lt;/svg&gt;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIRY-DESK - ç¤¾äº¤åª’ä½“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0e17;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #e5e7eb;
    }

    /* é¡¶éƒ¨å¹³å°åˆ‡æ¢æ  */
    .platform-tabs {
      display: flex;
      background: rgba(17, 24, 39, 0.95);
      border-bottom: 1px solid rgba(0, 240, 255, 0.2);
      padding: 0 8px;
      gap: 4px;
      overflow-x: auto;
    }

    .platform-tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 12px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      user-select: none;
    }

    .platform-tab:active {
      cursor: grabbing;
    }

    .platform-tab.dragging {
      opacity: 0.4;
    }

    .platform-tab.drag-over {
      border-left: 2px solid #00f0ff;
    }

    .platform-tab:hover {
      color: #e5e7eb;
      background: rgba(255, 255, 255, 0.05);
    }

    .platform-tab.active {
      color: #00f0ff;
      border-bottom-color: #00f0ff;
    }

    .platform-tab .icon {
      font-size: 14px;
    }

    /* å†…å®¹åŒºåŸŸ */
    .content-area {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .platform-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
    }

    .platform-content.active {
      display: flex;
    }

    /* iframe å®¹å™¨ */
    .embed-container {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .embed-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Twitter Timeline å®¹å™¨ */
    .twitter-timeline-container {
      flex: 1;
      overflow: auto;
      position: relative;
      background: #0a0e17;
    }

    /* Fallback UI */
    .fallback-ui {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
    }

    .fallback-ui .platform-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .fallback-ui h3 {
      color: #00f0ff;
      font-size: 16px;
      font-weight: normal;
      margin-bottom: 8px;
    }

    .fallback-ui p {
      color: #6b7280;
      font-size: 12px;
      margin-bottom: 20px;
      max-width: 280px;
      line-height: 1.6;
    }

    .fallback-ui .open-btn {
      padding: 10px 24px;
      background: rgba(0, 240, 255, 0.15);
      border: 1px solid #00f0ff;
      border-radius: 6px;
      color: #00f0ff;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .fallback-ui .open-btn:hover {
      background: #00f0ff;
      color: #0a0e17;
    }

    /* è‡ªåŠ¨è½®æ’­æŒ‡ç¤ºå™¨ */
    .carousel-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 8px;
      background: rgba(17, 24, 39, 0.8);
      border-top: 1px solid rgba(0, 240, 255, 0.1);
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .carousel-dot.active {
      background: #00f0ff;
      box-shadow: 0 0 8px #00f0ff;
    }

    .carousel-toggle {
      background: transparent;
      border: 1px solid #374151;
      color: #6b7280;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      margin-left: 12px;
    }

    .carousel-toggle:hover {
      border-color: #00f0ff;
      color: #00f0ff;
    }

    .carousel-toggle.playing {
      border-color: #00f0ff;
      color: #00f0ff;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0e17;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid rgba(0, 240, 255, 0.2);
      border-top-color: #00f0ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å¿«æ·æ“ä½œæ  */
    .quick-actions {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: rgba(17, 24, 39, 0.6);
      border-bottom: 1px solid rgba(0, 240, 255, 0.1);
    }

    .quick-action {
      flex: 1;
      padding: 8px;
      background: rgba(0, 240, 255, 0.08);
      border: 1px solid rgba(0, 240, 255, 0.2);
      border-radius: 4px;
      color: #9ca3af;
      font-size: 11px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .quick-action:hover {
      background: rgba(0, 240, 255, 0.15);
      color: #00f0ff;
      border-color: #00f0ff;
    }

    /* Twitter å¸å·åˆ‡æ¢æ  */
    .account-bar {
      display: flex;
      gap: 6px;
      padding: 8px 10px;
      background: rgba(17, 24, 39, 0.6);
      border-bottom: 1px solid rgba(0, 240, 255, 0.1);
      overflow-x: auto;
      align-items: center;
    }

    .account-chip {
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid #374151;
      background: transparent;
      color: #9ca3af;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .account-chip:hover {
      border-color: #00f0ff;
      color: #00f0ff;
    }

    .account-chip.active {
      border-color: #00f0ff;
      background: rgba(0, 240, 255, 0.15);
      color: #00f0ff;
    }
  </style>
</head>
<body>
  <!-- å¹³å°åˆ‡æ¢æ ‡ç­¾ï¼ˆç”± JS åŠ¨æ€ç”Ÿæˆï¼Œæ”¯æŒæ‹–åŠ¨æ’åºï¼‰ -->
  <div class="platform-tabs" id="platform-tabs"></div>

  <!-- å†…å®¹åŒºåŸŸ -->
  <div class="content-area">
    <!-- X / Twitter (Syndication Timeline Proxy) -->
    <div class="platform-content active" id="content-x">
      <div class="account-bar" id="twitter-accounts">
        <!-- ç”± JS ä»é…ç½®å¡«å……å¸å·åˆ—è¡¨ -->
      </div>
      <div class="embed-container" id="twitter-container">
        <div class="loading-overlay" id="loading-x">
          <div class="loading-spinner"></div>
        </div>
        <iframe id="twitter-iframe" src=""
                onload="hideLoading('x')"
                onerror="showTwitterFallback()"
                style="width:100%;height:100%;border:none;background:#0a0e17;"></iframe>
      </div>
    </div>

    <!-- Threads -->
    <div class="platform-content" id="content-threads">
      <div class="fallback-ui">
        <div class="platform-icon">ğŸ”—</div>
        <h3>Threads by Meta</h3>
        <p>Threads ç›®å‰ä¸æ”¯æŒç½‘é¡µåµŒå…¥ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚</p>
        <button class="open-btn" onclick="window.open('https://www.threads.net/', '_blank')">
          ğŸš€ æ‰“å¼€ Threads
        </button>
      </div>
    </div>

    <!-- Bluesky (bsky-embed web componentï¼Œæ— éœ€è®¤è¯) -->
    <div class="platform-content" id="content-bluesky">
      <div class="quick-actions">
        <div class="quick-action" onclick="window.open('https://bsky.app/', '_blank')">ğŸ  é¦–é¡µ</div>
        <div class="quick-action" onclick="window.open('https://bsky.app/search', '_blank')">ğŸ” æœç´¢</div>
        <div class="quick-action" onclick="window.open('https://bsky.app/notifications', '_blank')">ğŸ”” é€šçŸ¥</div>
      </div>
      <div class="embed-container" style="overflow-y: auto; padding: 8px;">
        <script type="module" src="https://cdn.jsdelivr.net/npm/bsky-embed/dist/bsky-embed.es.js" async></script>
        <bsky-embed
          username="bsky.app"
          mode="dark"
          limit="15"
          link-target="_blank"
          load-more="true"
          custom-styles="* { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; } .border-slate-300 { border-color: rgba(0,240,255,0.2) !important; } a { color: #00f0ff !important; }"
        ></bsky-embed>
      </div>
    </div>

    <!-- Facebook (Page Plugin) -->
    <div class="platform-content" id="content-facebook">
      <div class="quick-actions">
        <div class="quick-action" onclick="window.open('https://www.facebook.com/', '_blank')">ğŸ  é¦–é¡µ</div>
        <div class="quick-action" onclick="window.open('https://www.facebook.com/watch/', '_blank')">ğŸ“º Watch</div>
        <div class="quick-action" onclick="window.open('https://www.facebook.com/marketplace/', '_blank')">ğŸ›’ å¸‚é›†</div>
        <div class="quick-action" onclick="window.open('https://www.facebook.com/groups/', '_blank')">ğŸ‘¥ ç¤¾å›¢</div>
      </div>
      <div class="embed-container" id="facebook-container">
        <div class="loading-overlay" id="loading-facebook">
          <div class="loading-spinner"></div>
        </div>
        <iframe id="facebook-iframe" src=""
                style="width:100%;height:100%;border:none;background:#0a0e17;"
                onload="hideLoading('facebook')"
                onerror="showFacebookFallback()"></iframe>
      </div>
    </div>

    <!-- Mastodon -->
    <div class="platform-content" id="content-mastodon">
      <div class="quick-actions">
        <div class="quick-action" onclick="window.open('https://mastodon.social/explore', '_blank')">ğŸŒ æ¢ç´¢</div>
        <div class="quick-action" onclick="window.open('https://joinmastodon.org/', '_blank')">â„¹ï¸ äº†è§£æ›´å¤š</div>
      </div>
      <div class="embed-container">
        <div class="loading-overlay" id="loading-mastodon">
          <div class="loading-spinner"></div>
        </div>
        <iframe src="https://mastodon.social/public/local" onload="hideLoading('mastodon')" onerror="showFallback('mastodon')"></iframe>
      </div>
    </div>

    <!-- Reddit -->
    <div class="platform-content" id="content-reddit">
      <div class="quick-actions">
        <div class="quick-action" onclick="window.open('https://www.reddit.com/', '_blank')">ğŸ  é¦–é¡µ</div>
        <div class="quick-action" onclick="window.open('https://www.reddit.com/r/popular/', '_blank')">ğŸ”¥ çƒ­é—¨</div>
        <div class="quick-action" onclick="window.open('https://www.reddit.com/r/all/', '_blank')">ğŸŒ å…¨éƒ¨</div>
      </div>
      <div class="fallback-ui">
        <div class="platform-icon">ğŸ¤–</div>
        <h3>Reddit</h3>
        <p>Reddit é™åˆ¶ iframe åµŒå…¥ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚</p>
        <button class="open-btn" onclick="window.open('https://www.reddit.com/', '_blank')">
          ğŸš€ æ‰“å¼€ Reddit
        </button>
      </div>
    </div>

    <!-- å¾®åš Weibo -->
    <div class="platform-content" id="content-weibo">
      <div class="quick-actions">
        <div class="quick-action" onclick="window.open('https://weibo.com/', '_blank')">ğŸ  é¦–é¡µ</div>
        <div class="quick-action" onclick="window.open('https://s.weibo.com/top/summary', '_blank')">ğŸ”¥ çƒ­æœ</div>
        <div class="quick-action" onclick="window.open('https://weibo.com/mygroups', '_blank')">ğŸ‘¥ åˆ†ç»„</div>
        <div class="quick-action" onclick="window.open('https://message.weibo.com/', '_blank')">âœ‰ï¸ ç§ä¿¡</div>
      </div>
      <div class="embed-container">
        <div class="loading-overlay" id="loading-weibo">
          <div class="loading-spinner"></div>
        </div>
        <iframe src="https://m.weibo.cn/p/index?containerid=102803" onload="hideLoading('weibo')" onerror="showWeiboFallback()"></iframe>
      </div>
    </div>
  </div>

  <!-- è½®æ’­æ§åˆ¶ï¼ˆåœ†ç‚¹ç”± JS åŠ¨æ€ç”Ÿæˆï¼‰ -->
  <div class="carousel-controls">
    <button class="carousel-toggle" id="carousel-toggle" onclick="toggleCarousel()">
      â–¶ è‡ªåŠ¨è½®æ’­
    </button>
  </div>

  <script>
    // å¹³å°å®šä¹‰ï¼ˆå¯æ‹–åŠ¨æ’åºï¼‰
    var platformDefs = [
      { id: 'x', icon: '\u{1D54F}', label: 'X / Twitter' },
      { id: 'threads', icon: 'ğŸ”—', label: 'Threads' },
      { id: 'bluesky', icon: 'ğŸ¦‹', label: 'Bluesky' },
      { id: 'facebook', icon: 'ğŸ“˜', label: 'Facebook' },
      { id: 'mastodon', icon: 'ğŸ˜', label: 'Mastodon' },
      { id: 'reddit', icon: 'ğŸ¤–', label: 'Reddit' },
      { id: 'weibo', icon: 'ğŸ”´', label: 'å¾®åš' }
    ];

    let currentIndex = 0;
    let carouselInterval = null;
    let isCarouselPlaying = false;
    var dragSrcEl = null;

    function getPlatforms() {
      return platformDefs.map(function(p) { return p.id; });
    }

    // æ¸²æŸ“é¡µç­¾æ 
    function renderTabs() {
      var container = document.getElementById('platform-tabs');
      container.innerHTML = '';
      platformDefs.forEach(function(p, i) {
        var btn = document.createElement('button');
        btn.className = 'platform-tab' + (i === currentIndex ? ' active' : '');
        btn.dataset.platform = p.id;
        btn.dataset.index = i;
        btn.draggable = true;

        var iconSpan = document.createElement('span');
        iconSpan.className = 'icon';
        iconSpan.textContent = p.icon;
        btn.appendChild(iconSpan);

        var labelSpan = document.createElement('span');
        labelSpan.textContent = p.label;
        btn.appendChild(labelSpan);

        btn.addEventListener('click', function() { switchPlatform(p.id); });
        btn.addEventListener('dragstart', handleDragStart);
        btn.addEventListener('dragover', handleDragOver);
        btn.addEventListener('dragenter', handleDragEnter);
        btn.addEventListener('dragleave', handleDragLeave);
        btn.addEventListener('drop', handleDrop);
        btn.addEventListener('dragend', handleDragEnd);

        container.appendChild(btn);
      });
      renderDots();
    }

    // æ‹–åŠ¨æ’åºé€»è¾‘
    function handleDragStart(e) {
      dragSrcEl = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.index);
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    }

    function handleDragLeave() {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');

      var fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      var toIdx = parseInt(this.dataset.index);

      if (fromIdx === toIdx) return;

      // ä¿å­˜å½“å‰æ¿€æ´»å¹³å° IDï¼ˆå¿…é¡»åœ¨ splice ä¹‹å‰ï¼‰
      var activePlatformId = platformDefs[currentIndex] ? platformDefs[currentIndex].id : platformDefs[0].id;

      // é‡æ–°æ’åˆ— platformDefs
      var moved = platformDefs.splice(fromIdx, 1)[0];
      platformDefs.splice(toIdx, 0, moved);

      // æ‰¾åˆ°æ¿€æ´»å¹³å°åœ¨æ–°é¡ºåºä¸­çš„ä½ç½®
      var newIdx = platformDefs.findIndex(function(p) { return p.id === activePlatformId; });
      currentIndex = newIdx >= 0 ? newIdx : 0;

      renderTabs();

      // ä¿å­˜æ’åºåˆ°é…ç½®
      var order = platformDefs.map(function(p) { return p.id; });
      fetch('/api/config')
        .then(function(r) { return r.json(); })
        .then(function(cfg) {
          if (!cfg.right_screen) cfg.right_screen = {};
          if (!cfg.right_screen.social) cfg.right_screen.social = {};
          cfg.right_screen.social.platform_order = order;
          return fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(cfg)
          });
        })
        .catch(function() {});
    }

    function handleDragEnd() {
      document.querySelectorAll('.platform-tab').forEach(function(tab) {
        tab.classList.remove('dragging', 'drag-over');
      });
    }

    // æ¸²æŸ“è½®æ’­åœ†ç‚¹
    function renderDots() {
      var dotsContainer = document.querySelector('.carousel-controls');
      if (!dotsContainer) return;
      // æ¸…é™¤æ—§åœ†ç‚¹ï¼ˆä¿ç•™ toggle æŒ‰é’®ï¼‰
      var toggle = document.getElementById('carousel-toggle');
      dotsContainer.innerHTML = '';
      platformDefs.forEach(function(p, i) {
        var dot = document.createElement('div');
        dot.className = 'carousel-dot' + (i === currentIndex ? ' active' : '');
        dot.dataset.index = i;
        dot.addEventListener('click', function() { goToSlide(i); });
        dotsContainer.appendChild(dot);
      });
      dotsContainer.appendChild(toggle);
    }

    // åˆ‡æ¢å¹³å°
    var facebookLoaded = false;

    function switchPlatform(platform) {
      var platforms = getPlatforms();
      const index = platforms.indexOf(platform);
      if (index === -1) return;

      currentIndex = index;

      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.platform-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.platform === platform);
      });

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.platform-content').forEach(function(content) {
        content.classList.remove('active');
      });
      document.getElementById('content-' + platform).classList.add('active');

      // æ›´æ–°è½®æ’­æŒ‡ç¤ºå™¨
      document.querySelectorAll('.carousel-dot').forEach(function(dot, i) {
        dot.classList.toggle('active', i === index);
      });

      // Facebook æ‡’åŠ è½½ï¼šåªåœ¨ç¬¬ä¸€æ¬¡åˆ‡æ¢åˆ° Facebook æ—¶åŠ è½½ Page Plugin
      if (platform === 'facebook' && !facebookLoaded) {
        loadFacebookPlugin();
      }
    }

    // Twitter fallbackï¼ˆiframe åŠ è½½å¤±è´¥æ—¶è°ƒç”¨ï¼‰
    function showTwitterFallback() {
      var container = document.getElementById('twitter-container');
      if (!container) return;

      container.innerHTML = '';

      var fallback = document.createElement('div');
      fallback.className = 'fallback-ui';

      var icon = document.createElement('div');
      icon.className = 'platform-icon';
      icon.textContent = '\u{1D54F}';
      fallback.appendChild(icon);

      var title = document.createElement('h3');
      title.textContent = 'X / Twitter';
      fallback.appendChild(title);

      var desc = document.createElement('p');
      desc.textContent = 'Twitter Timeline åŠ è½½å¤±è´¥ã€‚å¯èƒ½æ˜¯ç½‘ç»œé™åˆ¶ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚';
      fallback.appendChild(desc);

      var btn = document.createElement('button');
      btn.className = 'open-btn';
      btn.textContent = '\uD83D\uDE80 æ‰“å¼€ X';
      btn.addEventListener('click', function() {
        window.open('https://x.com/explore', '_blank');
      });
      fallback.appendChild(btn);

      container.appendChild(fallback);
    }

    // ===== iframe ç¦»çº¿æ£€æµ‹ =====
    var iframeTimeouts = {};

    function setupIframeTimeout(platform, iframe, ms) {
      // æ¸…é™¤æ—§çš„ timeout
      if (iframeTimeouts[platform]) clearTimeout(iframeTimeouts[platform]);

      iframeTimeouts[platform] = setTimeout(function() {
        var loading = document.getElementById('loading-' + platform);
        if (loading && !loading.classList.contains('hidden')) {
          // è¶…æ—¶ï¼šæ›¿æ¢ loading ä¸ºç¦»çº¿æç¤º
          showOfflineOverlay(platform, iframe);
        }
      }, ms || 15000);

      // iframe åŠ è½½æˆåŠŸæ—¶æ¸…é™¤ timeout
      iframe.addEventListener('load', function onLoad() {
        clearTimeout(iframeTimeouts[platform]);
        iframe.removeEventListener('load', onLoad);
      });
    }

    function showOfflineOverlay(platform, iframe) {
      var loading = document.getElementById('loading-' + platform);
      if (!loading) return;

      loading.innerHTML = '';
      loading.classList.remove('hidden');
      loading.style.flexDirection = 'column';
      loading.style.gap = '12px';

      var icon = document.createElement('div');
      icon.style.cssText = 'font-size:36px;';
      icon.textContent = 'ğŸ“¡';
      loading.appendChild(icon);

      var msg = document.createElement('div');
      msg.style.cssText = 'color:#6b7280;font-size:12px;text-align:center;max-width:240px;line-height:1.6;';
      msg.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–è¯¥æœåŠ¡å·²ç¦»çº¿ã€‚';
      loading.appendChild(msg);

      var retryBtn = document.createElement('button');
      retryBtn.style.cssText = 'padding:8px 20px;background:rgba(0,240,255,0.15);border:1px solid #00f0ff;border-radius:4px;color:#00f0ff;font-size:12px;cursor:pointer;transition:all 0.2s;';
      retryBtn.textContent = 'ğŸ”„ é‡è¯•';
      retryBtn.addEventListener('click', function() {
        // æ¢å¤ loading spinner
        loading.innerHTML = '';
        loading.style.flexDirection = '';
        loading.style.gap = '';
        var spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        loading.appendChild(spinner);
        loading.classList.remove('hidden');

        // é‡æ–°åŠ è½½ iframe
        if (platform === 'facebook') {
          facebookLoaded = false;
          loadFacebookPlugin();
        } else {
          var currentSrc = iframe.src;
          iframe.src = '';
          setTimeout(function() { iframe.src = currentSrc; }, 100);
          setupIframeTimeout(platform, iframe, 15000);
        }
      });
      loading.appendChild(retryBtn);
    }

    function hideLoading(platform) {
      // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
      if (iframeTimeouts[platform]) {
        clearTimeout(iframeTimeouts[platform]);
        delete iframeTimeouts[platform];
      }
      const loading = document.getElementById('loading-' + platform);
      if (loading) {
        setTimeout(() => loading.classList.add('hidden'), 300);
      }
    }

    function showFallback(platform) {
      hideLoading(platform);
    }

    // Facebook Page Plugin æ‡’åŠ è½½ï¼ˆç­‰å®¹å™¨å¯è§åå†è®¾ç½® srcï¼Œé¿å… 0 å®½åº¦ï¼‰
    // ç”¨æˆ·è¦æ±‚ï¼šheader 120px + timeline 200pxï¼Œä½†Facebookä¸å…è®¸ç›´æ¥æ§åˆ¶å†…éƒ¨å…ƒç´ é«˜åº¦
    // è§£å†³æ–¹æ¡ˆï¼šä¼ é€’è¶³å¤Ÿå¤§çš„æ€»é«˜åº¦ï¼Œè®©Facebookæœ‰ç©ºé—´æ­£ç¡®åˆ†é…å†…éƒ¨å¸ƒå±€
    function loadFacebookPlugin() {
      var fbIframe = document.getElementById('facebook-iframe');
      if (!fbIframe || facebookLoaded) return;
      facebookLoaded = true;

      var fbContainer = document.getElementById('facebook-container');
      // width: å®¹å™¨å®é™…å®½åº¦ï¼ˆPage Plugin é™åˆ¶ 180-500ï¼‰
      var fbWidth = fbContainer ? fbContainer.clientWidth : 400;
      if (fbWidth < 180) fbWidth = 340;
      if (fbWidth > 500) fbWidth = 500;

      // height: ä½¿ç”¨å®¹å™¨çš„å®é™…é«˜åº¦ï¼Œä½†å¼ºåˆ¶æœ€å°800px
      // è¿™æ ·å¯ä»¥ç»™timelineè¶³å¤Ÿçš„ç©ºé—´æ˜¾ç¤ºå¸–å­ï¼Œé¿å…è¢«å‹ç¼©æˆ130px
      var fbHeight = fbContainer ? fbContainer.clientHeight : 800;
      if (fbHeight < 800) fbHeight = 800;

      var fbPage = facebookPageUrl || 'https://www.facebook.com/CNN';
      fbIframe.src = 'https://www.facebook.com/plugins/page.php?href=' +
        encodeURIComponent(fbPage) +
        '&tabs=timeline&width=' + fbWidth + '&height=' + fbHeight +
        '&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true';

      // è¶…æ—¶ä¿æŠ¤
      setupIframeTimeout('facebook', fbIframe, 15000);
    }

    function showFacebookFallback() {
      hideLoading('facebook');
      var container = document.getElementById('facebook-container');
      if (container) {
        container.innerHTML = '';
        var fallback = document.createElement('div');
        fallback.className = 'fallback-ui';
        fallback.innerHTML = '<div class="platform-icon">ğŸ“˜</div>' +
          '<h3>Facebook</h3>' +
          '<p>Facebook é¡µé¢æ’ä»¶åŠ è½½å¤±è´¥ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚</p>';
        var btn = document.createElement('button');
        btn.className = 'open-btn';
        btn.textContent = '\uD83D\uDE80 æ‰“å¼€ Facebook';
        btn.addEventListener('click', function() { window.open('https://www.facebook.com/', '_blank'); });
        fallback.appendChild(btn);
        container.appendChild(fallback);
      }
    }

    function showWeiboFallback() {
      hideLoading('weibo');
      const container = document.querySelector('#content-weibo .embed-container');
      if (container) {
        container.innerHTML = `
          <div class="fallback-ui">
            <div class="platform-icon">ğŸ”´</div>
            <h3>å¾®åš Weibo</h3>
            <p>å¾®åšåµŒå…¥åŠ è½½å¤±è´¥ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚</p>
            <button class="open-btn" onclick="window.open('https://weibo.com/', '_blank')">
              ğŸš€ æ‰“å¼€å¾®åš
            </button>
          </div>
        `;
      }
    }

    // è½®æ’­æ§åˆ¶
    function goToSlide(index) {
      var platforms = getPlatforms();
      if (index >= 0 && index < platforms.length) {
        switchPlatform(platforms[index]);
      }
    }

    function toggleCarousel() {
      const btn = document.getElementById('carousel-toggle');

      if (isCarouselPlaying) {
        clearInterval(carouselInterval);
        carouselInterval = null;
        isCarouselPlaying = false;
        btn.textContent = 'â–¶ è‡ªåŠ¨è½®æ’­';
        btn.classList.remove('playing');
      } else {
        isCarouselPlaying = true;
        btn.textContent = 'â¸ æš‚åœ';
        btn.classList.add('playing');

        carouselInterval = setInterval(() => {
          var platforms = getPlatforms();
          currentIndex = (currentIndex + 1) % platforms.length;
          switchPlatform(platforms[currentIndex]);
        }, 10000); // æ¯10ç§’åˆ‡æ¢
      }
    }

    // ===== Twitter å¸å·åˆ‡æ¢ =====
    var twitterAccounts = [];
    var currentTwitterAccount = '';

    function switchTwitterAccount(username) {
      currentTwitterAccount = username;
      var iframe = document.getElementById('twitter-iframe');
      var loading = document.getElementById('loading-x');

      // æ˜¾ç¤º loading
      if (loading) loading.classList.remove('hidden');

      iframe.src = '/api/twitter/timeline/' + encodeURIComponent(username);

      // æ›´æ–° chip æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('#twitter-accounts .account-chip').forEach(function(chip) {
        chip.classList.toggle('active', chip.dataset.account === username);
      });
    }

    function buildTwitterAccountBar(accounts) {
      var bar = document.getElementById('twitter-accounts');
      bar.innerHTML = '';

      accounts.forEach(function(account, i) {
        var chip = document.createElement('button');
        chip.className = 'account-chip' + (i === 0 ? ' active' : '');
        chip.dataset.account = account;
        chip.textContent = '@' + account;
        chip.addEventListener('click', function() {
          switchTwitterAccount(account);
        });
        bar.appendChild(chip);
      });

      // æœ«å°¾åŠ ä¸€ä¸ª"åœ¨ X æ‰“å¼€"æŒ‰é’®
      var openBtn = document.createElement('button');
      openBtn.className = 'account-chip';
      openBtn.textContent = 'â†— æ‰“å¼€ X';
      openBtn.style.marginLeft = 'auto';
      openBtn.addEventListener('click', function() {
        window.open('https://x.com/explore', '_blank');
      });
      bar.appendChild(openBtn);
    }

    // Facebook é¡µé¢ URLï¼ˆé…ç½®åŠ è½½åèµ‹å€¼ï¼Œæ‡’åŠ è½½æ—¶ä½¿ç”¨ï¼‰
    var facebookPageUrl = '';

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // ä»é…ç½®åŠ è½½
      fetch('/api/config')
        .then(function(r) { return r.json(); })
        .then(function(config) {
          // æ¢å¤å¹³å°æ’åºï¼ˆä» config æŒä¹…åŒ–çš„é¡ºåºï¼‰
          var savedOrder = config.right_screen?.social?.platform_order;
          if (savedOrder && Array.isArray(savedOrder) && savedOrder.length > 0) {
            var reordered = [];
            savedOrder.forEach(function(id) {
              var found = platformDefs.find(function(p) { return p.id === id; });
              if (found) reordered.push(found);
            });
            // æ·»åŠ ä¸åœ¨ savedOrder ä¸­çš„æ–°å¹³å°ï¼ˆå¯èƒ½åç»­æ–°å¢ï¼‰
            platformDefs.forEach(function(p) {
              if (!reordered.find(function(r) { return r.id === p.id; })) {
                reordered.push(p);
              }
            });
            platformDefs = reordered;
          }

          // æ¸²æŸ“å¯æ‹–åŠ¨é¡µç­¾
          renderTabs();

          // Twitter å¸å·
          twitterAccounts = config.right_screen?.social?.twitter_accounts || ['X'];
          buildTwitterAccountBar(twitterAccounts);
          switchTwitterAccount(twitterAccounts[0]);

          // Bluesky å¸å·
          var bskyAccount = config.right_screen?.social?.bluesky_account;
          if (bskyAccount) {
            var bskyEmbed = document.querySelector('bsky-embed');
            if (bskyEmbed) bskyEmbed.setAttribute('username', bskyAccount);
          }

          // ç¼“å­˜ Facebook é¡µé¢ URLï¼ˆæ‡’åŠ è½½æ—¶ä½¿ç”¨ï¼Œä¸åœ¨æ­¤å¤„è®¾ srcï¼‰
          facebookPageUrl = config.right_screen?.social?.facebook_page || 'https://www.facebook.com/CNN';

          // ä¸º Mastodon / Weibo è®¾ç½®è¶…æ—¶ä¿æŠ¤
          var mastodonIframe = document.querySelector('#content-mastodon iframe');
          if (mastodonIframe) setupIframeTimeout('mastodon', mastodonIframe, 15000);
          var weiboIframe = document.querySelector('#content-weibo iframe');
          if (weiboIframe) setupIframeTimeout('weibo', weiboIframe, 15000);
        })
        .catch(function() {
          // é…ç½®åŠ è½½å¤±è´¥ï¼Œç”¨é»˜è®¤
          renderTabs();
          twitterAccounts = ['X'];
          buildTwitterAccountBar(twitterAccounts);
          switchTwitterAccount('X');
        });

      // Twitter iframe è¶…æ—¶ä¿æŠ¤ï¼š10 ç§’åè‹¥ä»åœ¨ loadingï¼Œæ˜¾ç¤º fallback
      setTimeout(function() {
        var loading = document.getElementById('loading-x');
        if (loading && !loading.classList.contains('hidden')) {
          showTwitterFallback();
        }
      }, 10000);
    });

    // ç›‘å¬ iframe åŠ è½½é”™è¯¯
    document.querySelectorAll('iframe').forEach(function(iframe) {
      iframe.addEventListener('error', function() {
        var contentEl = iframe.closest('.platform-content');
        if (contentEl) {
          var platform = contentEl.id.replace('content-', '');
          showOfflineOverlay(platform, iframe);
        }
      });
    });
  </script>
</body>
</html>
