<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIRY-DESK - Claude Code Terminal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0e17;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #e5e7eb;
    }

    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .terminal-header {
      height: 36px;
      background: rgba(17, 24, 39, 0.95);
      border-bottom: 1px solid rgba(0, 240, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
    }

    .terminal-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #00f0ff;
      font-size: 12px;
      font-weight: 500;
    }

    .terminal-title .icon {
      font-size: 14px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
    }

    .status-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 8px #22c55e;
    }

    .status-dot.connecting {
      background: #eab308;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .terminal-actions {
      display: flex;
      gap: 8px;
    }

    .terminal-actions button {
      background: transparent;
      border: 1px solid rgba(0, 240, 255, 0.3);
      color: #9ca3af;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .terminal-actions button:hover {
      border-color: #00f0ff;
      color: #00f0ff;
    }

    /* ç»ˆç«¯å†…å®¹åŒº */
    .terminal-body {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .terminal-body iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #0a0e17;
    }

    /* è¿æ¥è®¾ç½®é¢æ¿ */
    .setup-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0e17;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }

    .setup-panel.hidden {
      display: none;
    }

    .setup-panel .logo {
      font-size: 64px;
      margin-bottom: 24px;
    }

    .setup-panel h2 {
      color: #00f0ff;
      font-size: 20px;
      font-weight: normal;
      margin-bottom: 12px;
    }

    .setup-panel p {
      color: #6b7280;
      font-size: 13px;
      max-width: 400px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .setup-form {
      width: 100%;
      max-width: 400px;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-group label {
      display: block;
      color: #9ca3af;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 6px;
      color: #e5e7eb;
      font-size: 13px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00f0ff;
      box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.1);
    }

    .form-group input::placeholder {
      color: #4b5563;
    }

    .connect-btn {
      width: 100%;
      padding: 12px;
      background: #00f0ff;
      border: none;
      border-radius: 6px;
      color: #0a0e17;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .connect-btn:hover {
      background: #00d4e0;
    }

    .connect-btn:disabled {
      background: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    /* å®‰è£…æŒ‡å— */
    .install-guide {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(0, 240, 255, 0.1);
      width: 100%;
      max-width: 500px;
    }

    .install-guide h3 {
      color: #9ca3af;
      font-size: 12px;
      font-weight: normal;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .install-steps {
      text-align: left;
    }

    .install-step {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .step-num {
      width: 24px;
      height: 24px;
      background: rgba(0, 240, 255, 0.15);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #00f0ff;
      font-size: 11px;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-content .cmd {
      background: rgba(17, 24, 39, 0.8);
      padding: 8px 12px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 12px;
      color: #4ade80;
      margin-top: 4px;
      display: block;
    }

    .step-content .desc {
      color: #6b7280;
      font-size: 12px;
    }

    /* é”™è¯¯æç¤º */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
      color: #ef4444;
      font-size: 12px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* å¿«æ·æ“ä½œ */
    .quick-links {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .quick-link {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 4px;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .quick-link:hover {
      border-color: #00f0ff;
      color: #00f0ff;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <div class="terminal-header">
    <div class="terminal-title">
      <span class="icon">ğŸ§¿</span>
      <span>Claude Code Terminal</span>
    </div>
    <div class="connection-status">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">æœªè¿æ¥</span>
    </div>
    <div class="terminal-actions">
      <button onclick="showSetup()" title="è®¾ç½®">âš™ï¸ è®¾ç½®</button>
      <button onclick="reconnect()" title="é‡è¿">ğŸ”„ é‡è¿</button>
      <button onclick="openExternal()" title="æ–°çª—å£">â›¶ æ–°çª—å£</button>
    </div>
  </div>

  <!-- ç»ˆç«¯å†…å®¹ -->
  <div class="terminal-body">
    <!-- è¿æ¥è®¾ç½®é¢æ¿ -->
    <div class="setup-panel" id="setup-panel">
      <div class="logo">ğŸ§¿</div>
      <h2>è¿æ¥åˆ° Claude Code</h2>
      <p>
        FAIRY-DESK ä½¿ç”¨ <strong>claude-code-web</strong> æä¾›æµè§ˆå™¨å†…çš„ Claude Code ç»ˆç«¯ä½“éªŒã€‚
        è¯·ç¡®ä¿å·²åœ¨æœ¬åœ°å¯åŠ¨ claude-code-web æœåŠ¡ã€‚
      </p>

      <div class="setup-form">
        <div class="form-group">
          <label>æœåŠ¡åœ°å€</label>
          <input type="text" id="server-url" placeholder="http://localhost:3000" value="http://localhost:3000">
        </div>
        <div class="form-group">
          <label>è®¤è¯ Tokenï¼ˆå¦‚å·²å¯ç”¨ï¼‰</label>
          <input type="password" id="auth-token" placeholder="ç•™ç©ºåˆ™ä¸ä½¿ç”¨è®¤è¯">
        </div>
        <button class="connect-btn" id="connect-btn" onclick="connect()">
          ğŸš€ è¿æ¥
        </button>
        <div class="error-message" id="error-message"></div>
      </div>

      <div class="quick-links">
        <a class="quick-link" href="https://github.com/vultuk/claude-code-web" target="_blank">
          ğŸ“– é¡¹ç›®æ–‡æ¡£
        </a>
        <a class="quick-link" href="https://www.npmjs.com/package/claude-code-web" target="_blank">
          ğŸ“¦ NPM åŒ…
        </a>
      </div>

      <div class="install-guide">
        <h3>å¿«é€Ÿå®‰è£…æŒ‡å—</h3>
        <div class="install-steps">
          <div class="install-step">
            <div class="step-num">1</div>
            <div class="step-content">
              <div class="desc">å®‰è£… Claude Code CLI</div>
              <code class="cmd">curl -fsSL https://claude.ai/install.sh | bash</code>
            </div>
          </div>
          <div class="install-step">
            <div class="step-num">2</div>
            <div class="step-content">
              <div class="desc">è¿è¡Œ claude-code-webï¼ˆæ— éœ€å®‰è£…ï¼‰</div>
              <code class="cmd">npx claude-code-web</code>
            </div>
          </div>
          <div class="install-step">
            <div class="step-num">3</div>
            <div class="step-content">
              <div class="desc">å¤åˆ¶ç»ˆç«¯æ˜¾ç¤ºçš„ Tokenï¼Œå¡«å…¥ä¸Šæ–¹å¹¶è¿æ¥</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç»ˆç«¯ iframe -->
    <iframe id="terminal-frame" class="hidden" src="about:blank"></iframe>
  </div>

  <script>
    // é…ç½®
    let serverUrl = localStorage.getItem('claude-web-url') || 'http://localhost:3000';
    let authToken = localStorage.getItem('claude-web-token') || '';
    let isConnected = false;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('server-url').value = serverUrl;
      document.getElementById('auth-token').value = authToken;

      // å¦‚æœæœ‰ä¿å­˜çš„é…ç½®ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥
      if (serverUrl && localStorage.getItem('claude-web-autoconnect') === 'true') {
        connect();
      }
    });

    // è¿æ¥åˆ° claude-code-web
    async function connect() {
      const urlInput = document.getElementById('server-url');
      const tokenInput = document.getElementById('auth-token');
      const connectBtn = document.getElementById('connect-btn');
      const errorMsg = document.getElementById('error-message');

      serverUrl = urlInput.value.trim().replace(/\/$/, '');
      authToken = tokenInput.value.trim();

      if (!serverUrl) {
        showError('è¯·è¾“å…¥æœåŠ¡åœ°å€');
        return;
      }

      // ä¿å­˜é…ç½®
      localStorage.setItem('claude-web-url', serverUrl);
      localStorage.setItem('claude-web-token', authToken);

      // æ›´æ–° UI
      connectBtn.disabled = true;
      connectBtn.innerHTML = 'â³ è¿æ¥ä¸­...';
      errorMsg.classList.remove('show');
      updateStatus('connecting', 'è¿æ¥ä¸­...');

      try {
        // æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨
        const checkUrl = serverUrl + '/health';
        const response = await fetch(checkUrl, {
          method: 'GET',
          headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {},
          mode: 'cors'
        }).catch(() => null);

        // å³ä½¿ health æ£€æŸ¥å¤±è´¥ä¹Ÿå°è¯•åŠ è½½ï¼ˆå¯èƒ½æ²¡æœ‰ health ç«¯ç‚¹ï¼‰
        loadTerminal();

      } catch (error) {
        // ç½‘ç»œé”™è¯¯ï¼Œä½†ä»å°è¯•åŠ è½½
        loadTerminal();
      }
    }

    // åŠ è½½ç»ˆç«¯
    function loadTerminal() {
      const frame = document.getElementById('terminal-frame');
      const setupPanel = document.getElementById('setup-panel');
      const connectBtn = document.getElementById('connect-btn');

      // æ„å»º URL
      let url = serverUrl;
      if (authToken) {
        url += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(authToken);
      }

      frame.src = url;
      frame.classList.remove('hidden');
      frame.style.display = 'block';

      // ç›‘å¬åŠ è½½
      frame.onload = () => {
        setupPanel.classList.add('hidden');
        updateStatus('connected', 'å·²è¿æ¥');
        isConnected = true;
        localStorage.setItem('claude-web-autoconnect', 'true');
        connectBtn.disabled = false;
        connectBtn.innerHTML = 'ğŸš€ è¿æ¥';
      };

      frame.onerror = () => {
        showError('æ— æ³•è¿æ¥åˆ° claude-code-web æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨');
        updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
        connectBtn.disabled = false;
        connectBtn.innerHTML = 'ğŸš€ è¿æ¥';
      };

      // è¶…æ—¶å¤„ç†
      setTimeout(() => {
        if (!isConnected) {
          // å¯èƒ½æ˜¯é™é»˜åŠ è½½æˆåŠŸ
          setupPanel.classList.add('hidden');
          updateStatus('connected', 'å·²è¿æ¥');
          isConnected = true;
        }
        connectBtn.disabled = false;
        connectBtn.innerHTML = 'ğŸš€ è¿æ¥';
      }, 5000);
    }

    // æ˜¾ç¤ºè®¾ç½®é¢æ¿
    function showSetup() {
      document.getElementById('setup-panel').classList.remove('hidden');
      document.getElementById('terminal-frame').style.display = 'none';
      isConnected = false;
      updateStatus('disconnected', 'æœªè¿æ¥');
    }

    // é‡æ–°è¿æ¥
    function reconnect() {
      const frame = document.getElementById('terminal-frame');
      if (frame.src && frame.src !== 'about:blank') {
        updateStatus('connecting', 'é‡è¿ä¸­...');
        frame.src = frame.src;
        setTimeout(() => {
          updateStatus('connected', 'å·²è¿æ¥');
        }, 2000);
      } else {
        showSetup();
      }
    }

    // æ–°çª—å£æ‰“å¼€
    function openExternal() {
      if (serverUrl) {
        let url = serverUrl;
        if (authToken) {
          url += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(authToken);
        }
        window.open(url, '_blank');
      }
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(status, text) {
      const dot = document.getElementById('status-dot');
      const textEl = document.getElementById('status-text');

      dot.className = 'status-dot';
      if (status === 'connected') {
        dot.classList.add('connected');
      } else if (status === 'connecting') {
        dot.classList.add('connecting');
      }

      textEl.textContent = text;
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    // æ·»åŠ  CSS
    const style = document.createElement('style');
    style.textContent = `
      .hidden { display: none !important; }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
