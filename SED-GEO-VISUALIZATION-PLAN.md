# SED + åœ°ç†ä½ç½®å¯è§†åŒ– æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

å°† **SEDï¼ˆSocial Engineering Databaseï¼‰** ä¸ **åœ°ç†ä½ç½®å¯è§†åŒ–** æ•´åˆï¼Œåœ¨ FAIRY-DESK ä¸­å®ç°æ•°æ®æ³„éœ²äº‹ä»¶çš„åœ°ç†åˆ†å¸ƒå¯è§†åŒ–ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1ï¸âƒ£ æ•°æ®æ³„éœ²åœ°ç†çƒ­åŠ›å›¾
- æ˜¾ç¤ºå…¨çƒ/å›½å†…æ•°æ®æ³„éœ²äº‹ä»¶çš„åœ°ç†åˆ†å¸ƒ
- åŸºäºæ•°æ®æ¥æºï¼ˆsourceï¼‰çš„åœ°ç†ç»Ÿè®¡
- å®æ—¶æ›´æ–°çƒ­åŠ›å¯†åº¦

### 2ï¸âƒ£ é‚®ç®±åŸŸååœ°ç†åˆ†æ
- è§£æé‚®ç®±åŸŸåï¼ˆsuffix_emailï¼‰çš„æ³¨å†Œåœ°ç†ä½ç½®
- ç»Ÿè®¡å„åœ°åŒºä½¿ç”¨æœ€å¤šçš„é‚®ç®±æœåŠ¡å•†
- å¯è§†åŒ–åŸŸåæœåŠ¡å™¨åˆ†å¸ƒ

### 3ï¸âƒ£ æ³„éœ²äº‹ä»¶æ—¶é—´è½´
- æŒ‰æ—¶é—´ï¼ˆxtimeï¼‰å’Œåœ°ç†ä½ç½®æ˜¾ç¤ºæ³„éœ²äº‹ä»¶æ¼”å˜
- æ—¶é—´æ»‘å—æ§åˆ¶æ˜¾ç¤ºæ—¶é—´æ®µ
- åŠ¨æ€æ’­æ”¾æ³„éœ²äº‹ä»¶æ‰©æ•£è¿‡ç¨‹

### 4ï¸âƒ£ äº¤äº’å¼æŸ¥è¯¢
- ç‚¹å‡»åœ°å›¾åŒºåŸŸæŸ¥çœ‹è¯¥åœ°åŒºçš„æ³„éœ²æ•°æ®
- æ”¯æŒåœˆé€‰ã€æ¡†é€‰åŒºåŸŸæ‰¹é‡æŸ¥è¯¢
- å®æ—¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FAIRY-DESK å·¦å±                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           SED åœ°ç†ä½ç½®å¯è§†åŒ– Tab                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         Leaflet.js åœ°å›¾                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - çƒ­åŠ›å›¾å±‚ï¼ˆæ•°æ®æ³„éœ²å¯†åº¦ï¼‰                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ ‡è®°å›¾å±‚ï¼ˆé‡å¤§æ³„éœ²äº‹ä»¶ï¼‰                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - èšç±»å›¾å±‚ï¼ˆé‚®ç®±åŸŸååˆ†å¸ƒï¼‰                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚  â”‚æ—¶é—´è½´  â”‚ç»Ÿè®¡é¢æ¿â”‚è¿‡æ»¤å™¨  â”‚å›¾ä¾‹    â”‚              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FAIRY-DESK Flask API (æ–°å¢ç«¯ç‚¹)                â”‚
â”‚  /api/sed/geo/sources        - è·å–æ•°æ®æºåœ°ç†åˆ†å¸ƒ          â”‚
â”‚  /api/sed/geo/domains        - è·å–é‚®ç®±åŸŸååœ°ç†åˆ†å¸ƒ        â”‚
â”‚  /api/sed/geo/timeline       - è·å–æ—¶é—´è½´æ•°æ®              â”‚
â”‚  /api/sed/geo/region/<name>  - æŸ¥è¯¢æŒ‡å®šåœ°åŒºçš„æ•°æ®          â”‚
â”‚  /api/sed/geo/heatmap        - è·å–çƒ­åŠ›å›¾æ•°æ®              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åœ°ç†ä½ç½®å¤„ç†å±‚ï¼ˆæ–°å¢ï¼‰                      â”‚
â”‚  - GeoIP æ•°æ®åº“ (GeoLite2-City.mmdb)                       â”‚
â”‚  - DNS è§£æå™¨ (dnspython)                                   â”‚
â”‚  - åŸŸå WHOIS æŸ¥è¯¢ (python-whois)                           â”‚
â”‚  - åœ°ç†ç¼–ç ç¼“å­˜ (Redis/å†…å­˜)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SED Elasticsearch                          â”‚
â”‚  ç´¢å¼•å­—æ®µ:                                                   â”‚
â”‚    - user, email, suffix_email                             â”‚
â”‚    - password, passwordHash                                â”‚
â”‚    - source (æ•°æ®æ¥æº)                                      â”‚
â”‚    - xtime (æ³„éœ²æ—¶é—´)                                       â”‚
â”‚    - [æ–°å¢] geo_location { lat, lon, country, city }       â”‚
â”‚    - [æ–°å¢] domain_ip                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ•°æ®æ¨¡å‹è®¾è®¡

### SED æ‰©å±•å­—æ®µ

åœ¨ç°æœ‰ Elasticsearch ç´¢å¼•ä¸­æ–°å¢åœ°ç†ä½ç½®ç›¸å…³å­—æ®µï¼š

```json
{
  "_index": "socialdb",
  "_source": {
    // ç°æœ‰å­—æ®µ
    "user": "johndoe",
    "email": "john@example.com",
    "suffix_email": "example.com",
    "password": "pass123",
    "passwordHash": "5f4dcc3b5aa765d61d8327deb882cf99",
    "source": "æŸç½‘ç«™æ³„éœ²2023",
    "xtime": "202301",
    "create_time": "2023/01/15 10:30:00",

    // æ–°å¢åœ°ç†ä½ç½®å­—æ®µ
    "geo_location": {
      "lat": 39.9042,
      "lon": 116.4074,
      "country": "China",
      "country_code": "CN",
      "city": "Beijing",
      "region": "Beijing",
      "source_type": "domain"  // domain/source/manual
    },

    // æ–°å¢åŸŸåIPå­—æ®µ
    "domain_ip": "93.184.216.34",
    "domain_asn": "AS15133",
    "domain_org": "Edgecast Inc."
  }
}
```

### åœ°ç†ä½ç½®æ¥æºç±»å‹

| source_type | è¯´æ˜ | ä¼˜å…ˆçº§ |
|-------------|------|--------|
| `manual` | æ‰‹åŠ¨æ ‡æ³¨çš„æ³„éœ²äº‹ä»¶åœ°ç†ä½ç½® | ğŸ¥‡ é«˜ |
| `source` | ä»sourceå­—æ®µæå–çš„åœ°ç†ä¿¡æ¯ | ğŸ¥ˆ ä¸­ |
| `domain` | ä»é‚®ç®±åŸŸåè§£æçš„åœ°ç†ä½ç½® | ğŸ¥‰ ä½ |

---

## ğŸ”Œ API ç«¯ç‚¹è®¾è®¡

### 1. è·å–æ•°æ®æºåœ°ç†åˆ†å¸ƒ

```
GET /api/sed/geo/sources
```

**æŸ¥è¯¢å‚æ•°**:
- `time_range`: æ—¶é—´èŒƒå›´ï¼ˆæ ¼å¼ï¼š202301-202312ï¼‰
- `limit`: è¿”å›æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤100ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "source": "æŸç½‘ç«™æ³„éœ²2023",
      "location": {
        "lat": 39.9042,
        "lon": 116.4074,
        "country": "China",
        "city": "Beijing"
      },
      "count": 1250000,
      "time": "202301"
    }
  ],
  "total": 45
}
```

---

### 2. è·å–é‚®ç®±åŸŸååœ°ç†åˆ†å¸ƒ

```
GET /api/sed/geo/domains
```

**æŸ¥è¯¢å‚æ•°**:
- `top_n`: è¿”å›å‰Nä¸ªåŸŸåï¼ˆé»˜è®¤50ï¼‰
- `country`: æŒ‰å›½å®¶è¿‡æ»¤

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "domain": "qq.com",
      "location": {
        "lat": 22.5431,
        "lon": 114.0579,
        "country": "China",
        "city": "Shenzhen"
      },
      "count": 8500000,
      "ip": "58.250.137.66"
    },
    {
      "domain": "163.com",
      "location": {
        "lat": 30.2741,
        "lon": 120.1551,
        "country": "China",
        "city": "Hangzhou"
      },
      "count": 6200000,
      "ip": "123.58.180.77"
    }
  ]
}
```

---

### 3. è·å–çƒ­åŠ›å›¾æ•°æ®

```
GET /api/sed/geo/heatmap
```

**æŸ¥è¯¢å‚æ•°**:
- `resolution`: åˆ†è¾¨ç‡ï¼ˆcountry/province/cityï¼‰
- `time_range`: æ—¶é—´èŒƒå›´

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "lat": 39.9042,
      "lon": 116.4074,
      "intensity": 0.95,
      "count": 12500000,
      "region": "Beijing"
    },
    {
      "lat": 31.2304,
      "lon": 121.4737,
      "intensity": 0.82,
      "count": 8900000,
      "region": "Shanghai"
    }
  ]
}
```

---

### 4. è·å–æ—¶é—´è½´æ•°æ®

```
GET /api/sed/geo/timeline
```

**æŸ¥è¯¢å‚æ•°**:
- `start_time`: èµ·å§‹æ—¶é—´ï¼ˆYYYYMMï¼‰
- `end_time`: ç»“æŸæ—¶é—´ï¼ˆYYYYMMï¼‰
- `interval`: é—´éš”ï¼ˆmonth/quarter/yearï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "time": "202301",
      "events": [
        {
          "source": "æŸç¤¾äº¤å¹³å°æ³„éœ²",
          "location": { "lat": 37.7749, "lon": -122.4194, "city": "San Francisco" },
          "count": 5000000
        }
      ]
    },
    {
      "time": "202302",
      "events": [
        {
          "source": "æŸç”µå•†å¹³å°æ³„éœ²",
          "location": { "lat": 39.9042, "lon": 116.4074, "city": "Beijing" },
          "count": 8000000
        }
      ]
    }
  ]
}
```

---

### 5. åŒºåŸŸæŸ¥è¯¢

```
GET /api/sed/geo/region/<region_name>
POST /api/sed/geo/query/bounds
```

**POSTè¯·æ±‚ä½“**ï¼ˆè¾¹ç•Œæ¡†æŸ¥è¯¢ï¼‰:
```json
{
  "bounds": {
    "north": 40.0,
    "south": 39.0,
    "east": 117.0,
    "west": 116.0
  },
  "limit": 100,
  "offset": 0
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "user": "john***",
      "email": "j***@qq.com",
      "source": "æŸç½‘ç«™æ³„éœ²2023",
      "time": "202301",
      "location": { "lat": 39.9042, "lon": 116.4074 }
    }
  ],
  "total": 1250000,
  "summary": {
    "top_domains": ["qq.com", "163.com", "sina.com"],
    "top_sources": ["æŸç½‘ç«™æ³„éœ²2023", "æŸè®ºå›æ³„éœ²2022"]
  }
}
```

---

## ğŸ¨ å‰ç«¯ç»„ä»¶è®¾è®¡

### ç»„ä»¶æ–‡ä»¶: `fairy-desk/templates/widgets/sed_geo_map.html`

#### 1. åœ°å›¾æ ¸å¿ƒåŠŸèƒ½

```javascript
// åœ°å›¾åˆå§‹åŒ–
const map = L.map('map', {
  center: [35.8617, 104.1954],
  zoom: 4,
  minZoom: 2,
  maxZoom: 18
});

// æš—è‰²ä¸»é¢˜ç“¦ç‰‡
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// å›¾å±‚ç®¡ç†
const layers = {
  heatmap: L.heatLayer([], { radius: 25, blur: 35, maxZoom: 10 }),
  markers: L.markerClusterGroup(),
  sources: L.layerGroup(),
  timeline: L.layerGroup()
};
```

#### 2. çƒ­åŠ›å›¾æ¸²æŸ“

```javascript
async function renderHeatmap() {
  const response = await fetch('/api/sed/geo/heatmap?resolution=city');
  const data = await response.json();

  const heatPoints = data.data.map(item => [
    item.lat,
    item.lon,
    item.intensity  // 0-1èŒƒå›´
  ]);

  layers.heatmap.setLatLngs(heatPoints);
  layers.heatmap.addTo(map);
}
```

#### 3. æ³„éœ²äº‹ä»¶æ ‡è®°

```javascript
async function renderSourceMarkers() {
  const response = await fetch('/api/sed/geo/sources?limit=100');
  const data = await response.json();

  data.data.forEach(source => {
    const marker = L.marker([source.location.lat, source.location.lon], {
      icon: createCustomIcon(source.count)
    });

    marker.bindPopup(`
      <div class="source-popup">
        <h3>${source.source}</h3>
        <p>ğŸ“Š æ³„éœ²æ•°æ®: ${formatNumber(source.count)}æ¡</p>
        <p>ğŸ“ ä½ç½®: ${source.location.city}, ${source.location.country}</p>
        <p>ğŸ• æ—¶é—´: ${formatTime(source.time)}</p>
        <button onclick="queryRegion('${source.source}')">æŸ¥çœ‹è¯¦æƒ…</button>
      </div>
    `);

    layers.markers.addLayer(marker);
  });

  map.addLayer(layers.markers);
}

function createCustomIcon(count) {
  const size = Math.min(50, 20 + Math.log10(count) * 5);
  const color = getColorByCount(count);

  return L.divIcon({
    className: 'custom-marker',
    html: `
      <div style="
        width: ${size}px;
        height: ${size}px;
        background: ${color};
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(0,240,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 10px;
      ">
        ${formatShortNumber(count)}
      </div>
    `,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });
}

function getColorByCount(count) {
  if (count > 10000000) return '#ef4444';      // çº¢è‰²ï¼ˆè¶…1000ä¸‡ï¼‰
  if (count > 5000000) return '#f97316';       // æ©™è‰²ï¼ˆ500-1000ä¸‡ï¼‰
  if (count > 1000000) return '#eab308';       // é»„è‰²ï¼ˆ100-500ä¸‡ï¼‰
  if (count > 100000) return '#22c55e';        // ç»¿è‰²ï¼ˆ10-100ä¸‡ï¼‰
  return '#3b82f6';                            // è“è‰²ï¼ˆ<10ä¸‡ï¼‰
}
```

#### 4. æ—¶é—´è½´æ§åˆ¶

```javascript
class TimelineController {
  constructor() {
    this.currentTime = '202301';
    this.timeRange = ['202101', '202412'];
    this.playing = false;
    this.speed = 500; // ms per step
  }

  async loadTimelineData() {
    const response = await fetch(
      `/api/sed/geo/timeline?start_time=${this.timeRange[0]}&end_time=${this.timeRange[1]}`
    );
    this.data = await response.json();
  }

  renderTimeStep(time) {
    const events = this.data.data.find(d => d.time === time)?.events || [];

    layers.timeline.clearLayers();

    events.forEach(event => {
      const circle = L.circle([event.location.lat, event.location.lon], {
        color: '#00f0ff',
        fillColor: '#00f0ff',
        fillOpacity: 0.4,
        radius: Math.sqrt(event.count) * 100,
        className: 'timeline-event'
      }).addTo(layers.timeline);

      circle.bindPopup(`
        <b>${event.source}</b><br>
        æ³„éœ²æ•°æ®: ${formatNumber(event.count)}æ¡<br>
        æ—¶é—´: ${formatTime(time)}
      `);
    });

    map.addLayer(layers.timeline);
  }

  play() {
    this.playing = true;
    this.animate();
  }

  pause() {
    this.playing = false;
  }

  animate() {
    if (!this.playing) return;

    const times = this.data.data.map(d => d.time);
    const currentIndex = times.indexOf(this.currentTime);
    const nextIndex = (currentIndex + 1) % times.length;

    this.currentTime = times[nextIndex];
    this.renderTimeStep(this.currentTime);

    setTimeout(() => this.animate(), this.speed);
  }
}

const timeline = new TimelineController();
```

#### 5. äº¤äº’å¼åŒºåŸŸæŸ¥è¯¢

```javascript
// æ¡†é€‰å·¥å…·
let selectionBox = null;

function enableBoxSelection() {
  map.on('mousedown', startBoxSelection);
}

function startBoxSelection(e) {
  const startLatLng = e.latlng;

  selectionBox = L.rectangle([startLatLng, startLatLng], {
    color: '#00f0ff',
    weight: 2,
    fillOpacity: 0.1
  }).addTo(map);

  map.on('mousemove', updateBoxSelection);
  map.on('mouseup', finishBoxSelection);
}

function updateBoxSelection(e) {
  if (!selectionBox) return;
  const bounds = L.latLngBounds(
    selectionBox.getBounds().getSouthWest(),
    e.latlng
  );
  selectionBox.setBounds(bounds);
}

async function finishBoxSelection(e) {
  map.off('mousemove', updateBoxSelection);
  map.off('mouseup', finishBoxSelection);

  const bounds = selectionBox.getBounds();

  const response = await fetch('/api/sed/geo/query/bounds', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      bounds: {
        north: bounds.getNorth(),
        south: bounds.getSouth(),
        east: bounds.getEast(),
        west: bounds.getWest()
      },
      limit: 1000
    })
  });

  const data = await response.json();
  showRegionQueryResults(data);

  map.removeLayer(selectionBox);
  selectionBox = null;
}
```

#### 6. æ§åˆ¶é¢æ¿UI

```html
<div class="control-panel">
  <!-- å›¾å±‚åˆ‡æ¢ -->
  <div class="layer-controls">
    <label><input type="checkbox" id="layer-heatmap" checked> çƒ­åŠ›å›¾</label>
    <label><input type="checkbox" id="layer-markers" checked> æ³„éœ²äº‹ä»¶</label>
    <label><input type="checkbox" id="layer-domains"> é‚®ç®±åŸŸå</label>
  </div>

  <!-- æ—¶é—´è½´æ§åˆ¶ -->
  <div class="timeline-controls">
    <button id="timeline-play">â–¶ï¸ æ’­æ”¾</button>
    <button id="timeline-pause">â¸ï¸ æš‚åœ</button>
    <input type="range" id="timeline-slider" min="0" max="100">
    <span id="timeline-label">2023-01</span>
  </div>

  <!-- è¿‡æ»¤å™¨ -->
  <div class="filter-controls">
    <select id="filter-country">
      <option value="">å…¨éƒ¨å›½å®¶</option>
      <option value="CN">ä¸­å›½</option>
      <option value="US">ç¾å›½</option>
    </select>
    <input type="number" id="filter-min-count" placeholder="æœ€å°æ•°æ®é‡">
  </div>

  <!-- ç»Ÿè®¡é¢æ¿ -->
  <div class="stats-panel">
    <div class="stat-item">
      <div class="stat-label">æ€»æ³„éœ²æ•°æ®</div>
      <div class="stat-value" id="stat-total">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">æ³„éœ²äº‹ä»¶</div>
      <div class="stat-value" id="stat-events">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">è¦†ç›–å›½å®¶</div>
      <div class="stat-value" id="stat-countries">0</div>
    </div>
  </div>
</div>
```

---

## ğŸ”§ åç«¯å®ç°ï¼ˆfairy-desk/app.pyï¼‰

### 1. ä¾èµ–å®‰è£…

```bash
pip install geoip2 dnspython python-whois
```

### 2. åœ°ç†ä½ç½®è§£æç±»

```python
import geoip2.database
import dns.resolver
import socket
from functools import lru_cache
import logging

logger = logging.getLogger(__name__)

class GeoLocationResolver:
    """åœ°ç†ä½ç½®è§£æå™¨"""

    def __init__(self, geoip_db_path='data/GeoLite2-City.mmdb'):
        self.geoip_reader = geoip2.database.Reader(geoip_db_path)
        self.dns_resolver = dns.resolver.Resolver()
        self.dns_resolver.timeout = 2
        self.dns_resolver.lifetime = 2

    @lru_cache(maxsize=10000)
    def resolve_ip(self, ip_address):
        """æ ¹æ®IPè·å–åœ°ç†ä½ç½®"""
        try:
            response = self.geoip_reader.city(ip_address)
            return {
                'lat': response.location.latitude,
                'lon': response.location.longitude,
                'country': response.country.name,
                'country_code': response.country.iso_code,
                'city': response.city.name,
                'region': response.subdivisions.most_specific.name if response.subdivisions else None
            }
        except Exception as e:
            logger.warning(f"IPåœ°ç†è§£æå¤±è´¥ {ip_address}: {e}")
            return None

    @lru_cache(maxsize=10000)
    def resolve_domain(self, domain):
        """æ ¹æ®åŸŸåè·å–åœ°ç†ä½ç½®"""
        try:
            # DNSè§£æè·å–IP
            answers = self.dns_resolver.resolve(domain, 'A')
            if answers:
                ip = str(answers[0])
                location = self.resolve_ip(ip)
                if location:
                    location['domain_ip'] = ip
                    return location
        except Exception as e:
            logger.warning(f"åŸŸååœ°ç†è§£æå¤±è´¥ {domain}: {e}")

        return None

    def batch_resolve_domains(self, domains):
        """æ‰¹é‡è§£æåŸŸå"""
        results = {}
        for domain in domains:
            results[domain] = self.resolve_domain(domain)
        return results

# å…¨å±€å®ä¾‹
geo_resolver = GeoLocationResolver()
```

### 3. APIè·¯ç”±å®ç°

```python
from flask import Flask, jsonify, request
import requests

# SED APIé…ç½®
SED_API_BASE = config.get('sed', {}).get('api_endpoint', 'http://localhost:5000')

@app.route('/api/sed/geo/sources')
def sed_geo_sources():
    """è·å–æ•°æ®æºåœ°ç†åˆ†å¸ƒ"""
    try:
        time_range = request.args.get('time_range', '')
        limit = request.args.get('limit', 100, type=int)

        # ä»SED APIè·å–sourceèšåˆæ•°æ®
        # æ³¨æ„ï¼šéœ€è¦SEDåç«¯æ”¯æŒèšåˆæŸ¥è¯¢
        response = requests.get(
            f"{SED_API_BASE}/api/analysis/sources",
            params={'time_range': time_range, 'limit': limit},
            timeout=10
        )

        sources_data = response.json()

        # ä¸ºæ¯ä¸ªsourceæ·»åŠ åœ°ç†ä½ç½®ï¼ˆæ‰‹åŠ¨æ˜ å°„æˆ–ä»æ•°æ®åº“è¯»å–ï¼‰
        result = []
        for source in sources_data.get('data', []):
            location = get_source_location(source['source'])
            if location:
                result.append({
                    'source': source['source'],
                    'location': location,
                    'count': source['count'],
                    'time': source.get('time', '')
                })

        return jsonify({
            'success': True,
            'data': result,
            'total': len(result)
        })

    except Exception as e:
        logger.error(f"è·å–æ•°æ®æºåœ°ç†åˆ†å¸ƒå¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/sed/geo/domains')
def sed_geo_domains():
    """è·å–é‚®ç®±åŸŸååœ°ç†åˆ†å¸ƒ"""
    try:
        top_n = request.args.get('top_n', 50, type=int)
        country = request.args.get('country', '')

        # ä»SED APIè·å–åŸŸåç»Ÿè®¡
        response = requests.get(
            f"{SED_API_BASE}/api/analysis/domains",
            params={'top': top_n},
            timeout=10
        )

        domains_data = response.json()

        # æ‰¹é‡è§£æåŸŸååœ°ç†ä½ç½®
        domains = [d['domain'] for d in domains_data.get('data', [])]
        locations = geo_resolver.batch_resolve_domains(domains)

        # ç»„åˆç»“æœ
        result = []
        for domain_stat in domains_data.get('data', []):
            domain = domain_stat['domain']
            location = locations.get(domain)

            if location:
                # å¦‚æœæŒ‡å®šäº†å›½å®¶è¿‡æ»¤
                if country and location.get('country_code') != country:
                    continue

                result.append({
                    'domain': domain,
                    'location': location,
                    'count': domain_stat['count'],
                    'ip': location.get('domain_ip')
                })

        return jsonify({
            'success': True,
            'data': result[:top_n]
        })

    except Exception as e:
        logger.error(f"è·å–åŸŸååœ°ç†åˆ†å¸ƒå¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/sed/geo/heatmap')
def sed_geo_heatmap():
    """è·å–çƒ­åŠ›å›¾æ•°æ®"""
    try:
        resolution = request.args.get('resolution', 'city')
        time_range = request.args.get('time_range', '')

        # ä»SEDè·å–èšåˆç»Ÿè®¡
        # æ ¹æ®resolutionå†³å®šèšåˆç²’åº¦
        response = requests.get(
            f"{SED_API_BASE}/api/analysis/geo_distribution",
            params={'resolution': resolution, 'time_range': time_range},
            timeout=10
        )

        geo_data = response.json()

        # å½’ä¸€åŒ–intensityå€¼
        max_count = max([d['count'] for d in geo_data.get('data', [])], default=1)

        result = []
        for item in geo_data.get('data', []):
            result.append({
                'lat': item['lat'],
                'lon': item['lon'],
                'intensity': min(1.0, item['count'] / max_count),
                'count': item['count'],
                'region': item.get('region', '')
            })

        return jsonify({
            'success': True,
            'data': result
        })

    except Exception as e:
        logger.error(f"è·å–çƒ­åŠ›å›¾æ•°æ®å¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/sed/geo/timeline')
def sed_geo_timeline():
    """è·å–æ—¶é—´è½´æ•°æ®"""
    try:
        start_time = request.args.get('start_time', '202101')
        end_time = request.args.get('end_time', '202412')
        interval = request.args.get('interval', 'month')

        response = requests.get(
            f"{SED_API_BASE}/api/analysis/timeline",
            params={
                'start': start_time,
                'end': end_time,
                'interval': interval
            },
            timeout=10
        )

        timeline_data = response.json()

        # ä¸ºæ¯ä¸ªæ—¶é—´ç‚¹çš„äº‹ä»¶æ·»åŠ åœ°ç†ä½ç½®
        result = []
        for time_point in timeline_data.get('data', []):
            events_with_geo = []
            for event in time_point.get('events', []):
                location = get_source_location(event['source'])
                if location:
                    events_with_geo.append({
                        'source': event['source'],
                        'location': location,
                        'count': event['count']
                    })

            if events_with_geo:
                result.append({
                    'time': time_point['time'],
                    'events': events_with_geo
                })

        return jsonify({
            'success': True,
            'data': result
        })

    except Exception as e:
        logger.error(f"è·å–æ—¶é—´è½´æ•°æ®å¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/sed/geo/query/bounds', methods=['POST'])
def sed_geo_query_bounds():
    """è¾¹ç•Œæ¡†æŸ¥è¯¢"""
    try:
        bounds = request.json.get('bounds', {})
        limit = request.json.get('limit', 100)
        offset = request.json.get('offset', 0)

        # æ„å»ºElasticsearchåœ°ç†è¾¹ç•ŒæŸ¥è¯¢
        # æ³¨æ„ï¼šéœ€è¦SEDçš„Elasticsearchç´¢å¼•åŒ…å«geo_locationå­—æ®µ
        response = requests.post(
            f"{SED_API_BASE}/api/query/geo_bounds",
            json={
                'bounds': bounds,
                'limit': limit,
                'offset': offset
            },
            timeout=30
        )

        query_result = response.json()

        # è„±æ•å¤„ç†
        for item in query_result.get('data', []):
            item['user'] = mask_string(item.get('user', ''), 3)
            item['email'] = mask_email(item.get('email', ''))

        return jsonify(query_result)

    except Exception as e:
        logger.error(f"è¾¹ç•Œæ¡†æŸ¥è¯¢å¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500


# è¾…åŠ©å‡½æ•°
def get_source_location(source_name):
    """æ ¹æ®sourceåç§°è·å–åœ°ç†ä½ç½®ï¼ˆæ‰‹åŠ¨æ˜ å°„æˆ–æ•°æ®åº“ï¼‰"""
    # è¿™é‡Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªsource -> locationçš„æ˜ å°„è¡¨
    # æˆ–è€…ä»æ•°æ®åº“ä¸­è¯»å–é¢„å…ˆæ ‡æ³¨çš„åœ°ç†ä½ç½®
    source_locations = {
        'æŸç¤¾äº¤å¹³å°æ³„éœ²2023': {'lat': 37.7749, 'lon': -122.4194, 'country': 'USA', 'city': 'San Francisco'},
        'æŸç”µå•†å¹³å°æ³„éœ²2023': {'lat': 39.9042, 'lon': 116.4074, 'country': 'China', 'city': 'Beijing'},
        # ... æ›´å¤šæ˜ å°„
    }

    return source_locations.get(source_name)


def mask_string(text, keep_chars=3):
    """å­—ç¬¦ä¸²è„±æ•"""
    if len(text) <= keep_chars:
        return text
    return text[:keep_chars] + '***'


def mask_email(email):
    """é‚®ç®±è„±æ•"""
    if '@' not in email:
        return email
    user, domain = email.split('@', 1)
    return mask_string(user, 1) + '@' + domain
```

---

## ğŸ—„ï¸ SEDæ•°æ®åº“æ‰©å±•

### Elasticsearchç´¢å¼•æ˜ å°„æ›´æ–°

```json
PUT /socialdb
{
  "mappings": {
    "properties": {
      "user": { "type": "keyword" },
      "email": { "type": "keyword" },
      "suffix_email": { "type": "keyword" },
      "password": { "type": "keyword" },
      "passwordHash": { "type": "keyword" },
      "source": { "type": "keyword" },
      "xtime": { "type": "keyword" },
      "create_time": { "type": "date", "format": "yyyy/MM/dd HH:mm:ss" },

      "geo_location": {
        "type": "geo_point"
      },
      "geo_country": { "type": "keyword" },
      "geo_city": { "type": "keyword" },
      "domain_ip": { "type": "ip" },
      "domain_asn": { "type": "keyword" }
    }
  }
}
```

### æ•°æ®è¿ç§»è„šæœ¬

```python
# sed/backend/migrate_geo_data.py
from es_utils import ESClient
from geo_resolver import GeoLocationResolver

es_client = ESClient()
geo_resolver = GeoLocationResolver()

def migrate_add_geo_locations():
    """ä¸ºç°æœ‰æ•°æ®æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯"""

    # 1. è·å–æ‰€æœ‰å”¯ä¸€çš„suffix_email
    query = {
        "size": 0,
        "aggs": {
            "unique_domains": {
                "terms": {
                    "field": "suffix_email",
                    "size": 10000
                }
            }
        }
    }

    result = es_client.es.search(index=es_client.index, body=query)
    domains = [bucket['key'] for bucket in result['aggregations']['unique_domains']['buckets']]

    print(f"æ‰¾åˆ° {len(domains)} ä¸ªå”¯ä¸€åŸŸå")

    # 2. æ‰¹é‡è§£æåŸŸååœ°ç†ä½ç½®
    domain_locations = geo_resolver.batch_resolve_domains(domains)

    # 3. æ›´æ–°Elasticsearchæ–‡æ¡£
    for domain, location in domain_locations.items():
        if not location:
            continue

        # æ„å»ºæ›´æ–°æŸ¥è¯¢
        update_query = {
            "script": {
                "source": """
                    ctx._source.geo_location = params.geo_location;
                    ctx._source.geo_country = params.country;
                    ctx._source.geo_city = params.city;
                    ctx._source.domain_ip = params.domain_ip;
                """,
                "params": {
                    "geo_location": {
                        "lat": location['lat'],
                        "lon": location['lon']
                    },
                    "country": location['country'],
                    "city": location['city'],
                    "domain_ip": location.get('domain_ip', '')
                }
            },
            "query": {
                "term": {
                    "suffix_email": domain
                }
            }
        }

        # æ‰§è¡Œæ‰¹é‡æ›´æ–°
        es_client.es.update_by_query(
            index=es_client.index,
            body=update_query,
            conflicts='proceed'
        )

        print(f"å·²æ›´æ–°åŸŸå {domain} çš„åœ°ç†ä½ç½®")

if __name__ == '__main__':
    migrate_add_geo_locations()
```

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
# Pythonä¾èµ–
pip install geoip2 dnspython python-whois

# ä¸‹è½½GeoIPæ•°æ®åº“
wget https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb \
  -O fairy-desk/data/GeoLite2-City.mmdb
```

### 2. é…ç½®fairy-desk

```json
// fairy-desk/config.json
{
  "sed": {
    "enabled": true,
    "api_endpoint": "http://localhost:5000",
    "geo_enabled": true
  },
  "geoip": {
    "database_path": "data/GeoLite2-City.mmdb",
    "cache_size": 10000
  }
}
```

### 3. SEDæ•°æ®è¿ç§»

```bash
cd /home/user/hidrs/sed/backend
python migrate_geo_data.py
```

### 4. æ·»åŠ Tabåˆ°FAIRY-DESK

```json
// fairy-desk/config.json
{
  "left_screen": {
    "tabs": [
      {
        "id": "sed-geo",
        "name": "SEDåœ°ç†åˆ†æ",
        "icon": "ğŸ—ºï¸",
        "url": "/widget/sed-geo-map",
        "loadStrategy": "lazy",
        "category": "security",
        "builtIn": false
      }
    ]
  }
}
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨SED
cd /home/user/hidrs/sed
docker-compose up -d

# å¯åŠ¨FAIRY-DESK
cd /home/user/hidrs/fairy-desk
python app.py
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å…¨çƒæ•°æ®æ³„éœ²æ€åŠ¿åˆ†æ
- æŸ¥çœ‹å…¨çƒèŒƒå›´å†…çš„æ•°æ®æ³„éœ²çƒ­ç‚¹åœ°åŒº
- åˆ†æä¸åŒå›½å®¶/åœ°åŒºçš„æ³„éœ²äº‹ä»¶å¯†åº¦
- è¯†åˆ«é«˜é£é™©åœ°ç†åŒºåŸŸ

### åœºæ™¯2: é‚®ç®±æœåŠ¡å•†åˆ†å¸ƒåˆ†æ
- ç»Ÿè®¡å„åœ°åŒºæœ€å¸¸ç”¨çš„é‚®ç®±æœåŠ¡æä¾›å•†
- åˆ†æåŸŸåæœåŠ¡å™¨çš„åœ°ç†åˆ†å¸ƒ
- è¯†åˆ«å¯ç–‘çš„é‚®ç®±æœåŠ¡å•†é›†ä¸­åŒºåŸŸ

### åœºæ™¯3: æ³„éœ²äº‹ä»¶æ—¶é—´æ¼”å˜è¿½è¸ª
- æ’­æ”¾æ³„éœ²äº‹ä»¶çš„æ—¶é—´æ¼”å˜è¿‡ç¨‹
- åˆ†ææ³„éœ²äº‹ä»¶çš„ä¼ æ’­è·¯å¾„
- é¢„æµ‹æœªæ¥å¯èƒ½çš„æ³„éœ²çƒ­ç‚¹

### åœºæ™¯4: ç‰¹å®šåŒºåŸŸæ·±åº¦åˆ†æ
- æ¡†é€‰æŸä¸ªåœ°ç†åŒºåŸŸæŸ¥çœ‹è¯¦ç»†æ•°æ®
- ç»Ÿè®¡è¯¥åŒºåŸŸçš„æ³„éœ²æ•°æ®ç‰¹å¾
- ç”ŸæˆåŒºåŸŸå®‰å…¨æŠ¥å‘Š

---

## ğŸ”’ å®‰å…¨ä¸éšç§

### æ•°æ®è„±æ•
- ç”¨æˆ·åæ˜¾ç¤ºå‰3ä¸ªå­—ç¬¦ï¼Œå…¶ä½™ç”¨ `***` æ›¿ä»£
- é‚®ç®±ç”¨æˆ·åä»…æ˜¾ç¤ºé¦–å­—æ¯
- å¯†ç å’Œå“ˆå¸Œä¸åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º

### è®¿é—®æ§åˆ¶
- åœ°ç†æŸ¥è¯¢åŠŸèƒ½éœ€è¦è®¤è¯
- è¯¦ç»†æ•°æ®æŸ¥çœ‹éœ€è¦é«˜æƒé™
- è®°å½•æ‰€æœ‰åœ°ç†æŸ¥è¯¢æ“ä½œæ—¥å¿—

### æ•°æ®ä¿æŠ¤
- ä¸è®°å½•æŸ¥è¯¢è€…çš„IPå’Œåœ°ç†ä½ç½®
- æŸ¥è¯¢ç»“æœé™åˆ¶è¿”å›æ•°é‡
- æ•æ„ŸåŒºåŸŸæ•°æ®æ¨¡ç³ŠåŒ–å¤„ç†

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. åœ°ç†ä½ç½®ç¼“å­˜
```python
# ä½¿ç”¨LRUç¼“å­˜å‡å°‘é‡å¤è§£æ
@lru_cache(maxsize=10000)
def resolve_domain(domain):
    # ...
```

### 2. Elasticsearchèšåˆä¼˜åŒ–
```json
{
  "size": 0,
  "aggs": {
    "geo_grid": {
      "geohash_grid": {
        "field": "geo_location",
        "precision": 5
      }
    }
  }
}
```

### 3. å‰ç«¯æ¸²æŸ“ä¼˜åŒ–
- ä½¿ç”¨ MarkerCluster èšåˆå¤§é‡æ ‡è®°
- çƒ­åŠ›å›¾ä½¿ç”¨WebGLåŠ é€Ÿæ¸²æŸ“
- æŒ‰è§†å›¾èŒƒå›´åŠ¨æ€åŠ è½½æ•°æ®

---

## ğŸ“ åç»­æ‰©å±•

1. **AIé¢„æµ‹åˆ†æ** - åŸºäºå†å²æ•°æ®é¢„æµ‹ä¸‹ä¸€ä¸ªæ³„éœ²çƒ­ç‚¹
2. **å®æ—¶å‘Šè­¦** - æ–°å¢æ³„éœ²äº‹ä»¶æ—¶åœ¨åœ°å›¾ä¸Šå®æ—¶æ˜¾ç¤º
3. **3Dåœ°çƒè§†å›¾** - ä½¿ç”¨Cesium.jså®ç°3Dåœ°çƒå¯è§†åŒ–
4. **å¯¼å‡ºåŠŸèƒ½** - å°†åœ°ç†åˆ†æç»“æœå¯¼å‡ºä¸ºPDFæŠ¥å‘Š
5. **å…³è”åˆ†æ** - ç»“åˆHIDRSçš„ç½‘ç»œæ‹“æ‰‘å’ŒSEDçš„åœ°ç†åˆ†å¸ƒè¿›è¡Œå…³è”åˆ†æ

---

## ğŸ“š æŠ€æœ¯æ ˆæ€»ç»“

| å±‚çº§ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| **å‰ç«¯åœ°å›¾** | Leaflet.js | åœ°å›¾æ¸²æŸ“ |
| **å‰ç«¯å¯è§†åŒ–** | Leaflet.heat | çƒ­åŠ›å›¾ |
| **å‰ç«¯èšç±»** | Leaflet.markercluster | æ ‡è®°èšç±» |
| **åç«¯æ¡†æ¶** | Flask | APIæœåŠ¡ |
| **åœ°ç†è§£æ** | GeoIP2 | IPåœ°ç†å®šä½ |
| **DNSè§£æ** | dnspython | åŸŸåè§£æ |
| **æ•°æ®å­˜å‚¨** | Elasticsearch | åœ°ç†æ•°æ®ç´¢å¼• |
| **ç¼“å­˜** | LRU Cache | åœ°ç†ä½ç½®ç¼“å­˜ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**çŠ¶æ€**: ğŸ“‹ è§„åˆ’å®Œæˆï¼Œå¾…å®æ–½
