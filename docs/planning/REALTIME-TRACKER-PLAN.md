# å®æ—¶Trackerè¿½è¸ªç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

å®ç°ç”µå½±çº§å®æ—¶ç›®æ ‡è¿½è¸ªç³»ç»Ÿï¼Œåœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºç§»åŠ¨ç›®æ ‡çš„ä½ç½®ã€è½¨è¿¹ã€é€Ÿåº¦å’Œæ–¹å‘ï¼Œæ”¯æŒå¤šç›®æ ‡åŒæ—¶è¿½è¸ªå’Œå†›äº‹é£æ ¼å¯è§†åŒ–ã€‚

**çµæ„Ÿæ¥æº**: ç”µå½±ä¸­çš„å«æ˜Ÿè¿½è¸ªç”»é¢ã€å†›äº‹æŒ‡æŒ¥ç³»ç»Ÿ

---

## ğŸ¬ ç³»ç»Ÿç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

1. **å®æ—¶ä½ç½®è¿½è¸ª** ğŸ“
   - WebSocketå®æ—¶æ•°æ®æ¨é€
   - 2-5ç§’æ›´æ–°é¢‘ç‡
   - å¹³æ»‘ç§»åŠ¨åŠ¨ç”»ï¼ˆ30å¸§æ’å€¼ï¼‰
   - æ”¯æŒå¤šç›®æ ‡åŒæ—¶è¿½è¸ª

2. **è½¨è¿¹å¯è§†åŒ–** ğŸ“Š
   - å†å²è½¨è¿¹çº¿æ¸²æŸ“ï¼ˆè™šçº¿æ ·å¼ï¼‰
   - ä¿ç•™æœ€è¿‘200ä¸ªä½ç½®ç‚¹
   - è½¨è¿¹é¢œè‰²åŒºåˆ†ä¸åŒç›®æ ‡
   - æ—¶é—´æˆ³æ ‡æ³¨

3. **å®æ—¶ä¿¡æ¯é¢æ¿** ğŸ“‹
   - ç›®æ ‡å½“å‰é€Ÿåº¦ï¼ˆkm/hï¼‰
   - ç§»åŠ¨æ–¹å‘ï¼ˆ8æ–¹ä½+è§’åº¦ï¼‰
   - æµ·æ‹”é«˜åº¦
   - è½¨è¿¹ç‚¹æ•°é‡
   - æœ€åæ›´æ–°æ—¶é—´

4. **å†›äº‹é£æ ¼UI** ğŸ¨
   - ç»¿è‰²å•è‰²è°ƒï¼ˆ#00ff00ï¼‰
   - æš—è‰²èƒŒæ™¯ï¼ˆ#0a0a0aï¼‰
   - Courier Newç­‰å®½å­—ä½“
   - æ–‡å­—å‘å…‰æ•ˆæœ
   - è„‰å†²åŠ¨ç”»æ ‡è®°

5. **äº¤äº’æ§åˆ¶** ğŸ®
   - æš‚åœ/æ¢å¤è¿½è¸ª
   - æ¸…é™¤å†å²è½¨è¿¹
   - è‡ªåŠ¨é€‚åº”è§†å›¾
   - å«æ˜Ÿåœ°å›¾åˆ‡æ¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯å®æ—¶åœ°å›¾ç•Œé¢                        â”‚
â”‚  Leaflet.js + å†›äº‹é£æ ¼UI                                â”‚
â”‚  - åœ°å›¾æ¸²æŸ“                                              â”‚
â”‚  - å¹³æ»‘ç§»åŠ¨åŠ¨ç”»ï¼ˆ30å¸§æ’å€¼ï¼‰                              â”‚
â”‚  - è½¨è¿¹çº¿ç»˜åˆ¶                                            â”‚
â”‚  - ä¿¡æ¯é¢æ¿å®æ—¶æ›´æ–°                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•ï¸ WebSocket åŒå‘é€šä¿¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flask-SocketIO å®æ—¶æ¨é€æœåŠ¡                 â”‚
â”‚  - WebSocketè¿æ¥ç®¡ç†                                     â”‚
â”‚  - ä½ç½®æ•°æ®å¹¿æ’­                                          â”‚
â”‚  - ç›®æ ‡çŠ¶æ€ç»´æŠ¤                                          â”‚
â”‚  - 5åˆ†é’Ÿè¶…æ—¶æ¸…ç†                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä½ç½®æ•°æ®æº                             â”‚
â”‚  - GPSè¿½è¸ªè®¾å¤‡                                           â”‚
â”‚  - ç§»åŠ¨è®¾å¤‡å®šä½API                                       â”‚
â”‚  - IoTè®¾å¤‡ä¸ŠæŠ¥                                           â”‚
â”‚  - æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨ï¼ˆæµ‹è¯•ç”¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **å‰ç«¯åœ°å›¾** | Leaflet.js | 1.9.4 | åœ°å›¾æ¸²æŸ“ |
| **å®æ—¶é€šä¿¡** | Socket.IO Client | 4.5.4 | WebSocketå®¢æˆ·ç«¯ |
| **åç«¯æ¡†æ¶** | Flask | 2.3+ | WebæœåŠ¡å™¨ |
| **å®æ—¶æ¨é€** | Flask-SocketIO | 5.3+ | WebSocketæœåŠ¡ç«¯ |
| **å¹¶å‘å¤„ç†** | eventlet | 0.33+ | å¼‚æ­¥I/O |
| **åœ°å›¾ç“¦ç‰‡** | CartoDB Dark | - | æš—è‰²åœ°å›¾ |
| **å«æ˜Ÿåœ°å›¾** | ArcGIS World Imagery | - | å«æ˜Ÿè§†å›¾ |

---

## ğŸ“ æ•°æ®æ¨¡å‹è®¾è®¡

### ç›®æ ‡å¯¹è±¡ï¼ˆTargetï¼‰

```javascript
class Target {
  id: string;              // ç›®æ ‡å”¯ä¸€æ ‡è¯†
  name: string;            // ç›®æ ‡åç§°
  position: [lat, lon];    // å½“å‰ä½ç½®
  trail: [[lat, lon]];     // å†å²è½¨è¿¹ï¼ˆæœ€å¤š200ç‚¹ï¼‰
  speed: number;           // é€Ÿåº¦ï¼ˆkm/hï¼‰
  heading: number;         // æ–¹å‘ï¼ˆ0-360åº¦ï¼‰
  altitude: number;        // æµ·æ‹”ï¼ˆç±³ï¼‰
  lastUpdate: timestamp;   // æœ€åæ›´æ–°æ—¶é—´
  marker: L.Marker;        // Leafletæ ‡è®°å¯¹è±¡
  trailLine: L.Polyline;   // è½¨è¿¹çº¿å¯¹è±¡
}
```

### WebSocketæ¶ˆæ¯æ ¼å¼

**ä½ç½®æ›´æ–°æ¶ˆæ¯**:
```json
{
  "event": "target_update",
  "data": {
    "target_id": "ALPHA",
    "name": "Target Alpha",
    "lat": 39.9042,
    "lon": 116.4074,
    "speed": 65.5,
    "heading": 135.2,
    "altitude": 125,
    "timestamp": 1704067200
  }
}
```

**ç›®æ ‡ä¸¢å¤±æ¶ˆæ¯**:
```json
{
  "event": "target_lost",
  "data": {
    "target_id": "ALPHA",
    "reason": "timeout"
  }
}
```

---

## ğŸ¨ å‰ç«¯å®ç°è¦ç‚¹

### 1. å¹³æ»‘ç§»åŠ¨åŠ¨ç”»

**å…³é”®æŠ€æœ¯ï¼šJavaScriptæ’å€¼åŠ¨ç”»**

```javascript
animateMove(from, to) {
  const steps = 30;      // 30å¸§
  const duration = 1000; // 1ç§’
  const latStep = (to[0] - from[0]) / steps;
  const lngStep = (to[1] - from[1]) / steps;

  let step = 0;
  const interval = setInterval(() => {
    step++;
    if (step >= steps) {
      clearInterval(interval);
      this.marker.setLatLng(to);
      return;
    }

    const newLat = from[0] + latStep * step;
    const newLng = from[1] + lngStep * step;
    this.marker.setLatLng([newLat, newLng]);
  }, duration / steps);
}
```

**æ•ˆæœ**:
- âœ… æ ‡è®°å¹³æ»‘ç§»åŠ¨ï¼Œæ— è·³è·ƒæ„Ÿ
- âœ… 30FPSæµç•…åŠ¨ç”»
- âœ… è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨

---

### 2. å®æ—¶è½¨è¿¹çº¿

**Leaflet Polylineé…ç½®**:

```javascript
this.trailLine = L.polyline([], {
  color: '#ff0000',        // çº¢è‰²è½¨è¿¹
  weight: 2,               // çº¿å®½
  opacity: 0.6,            // é€æ˜åº¦
  dashArray: '5, 5'        // è™šçº¿æ ·å¼
}).addTo(map);

// æ›´æ–°è½¨è¿¹
this.trail.push(newPosition);
if (this.trail.length > 200) {
  this.trail.shift();  // ä¿ç•™æœ€è¿‘200ä¸ªç‚¹
}
this.trailLine.setLatLngs(this.trail);
```

---

### 3. è„‰å†²åŠ¨ç”»æ ‡è®°

**CSSå…³é”®å¸§åŠ¨ç”»**:

```css
@keyframes ping {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.8);
  }
  100% {
    box-shadow: 0 0 0 20px rgba(255, 0, 0, 0);
  }
}

.marker-dot {
  width: 16px;
  height: 16px;
  background: #ff0000;
  border: 3px solid #fff;
  border-radius: 50%;
  animation: ping 2s infinite;
}
```

**æ•ˆæœ**: æ ‡è®°æŒç»­å‘å¤–å‘å‡ºçº¢è‰²è„‰å†²æ³¢

---

### 4. å†›äº‹é£æ ¼UI

**è®¾è®¡åŸåˆ™**:
- å•è‰²ç³»ï¼ˆç»¿è‰² #00ff00ï¼‰
- é«˜å¯¹æ¯”åº¦ï¼ˆé»‘èƒŒæ™¯ï¼‰
- ç­‰å®½å­—ä½“ï¼ˆCourier Newï¼‰
- å‘å…‰æ•ˆæœï¼ˆtext-shadowï¼‰
- è¾¹æ¡†é«˜äº®ï¼ˆborder + box-shadowï¼‰

**ç¤ºä¾‹CSS**:

```css
.header-title {
  color: #00ff00;
  text-shadow: 0 0 10px #00ff00;
  letter-spacing: 3px;
  font-family: 'Courier New', monospace;
}

.target-card {
  background: rgba(0, 40, 0, 0.8);
  border: 1px solid #00ff00;
  box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
}
```

---

## ğŸ”§ åç«¯å®ç°è¦ç‚¹

### 1. Flask-SocketIOæœåŠ¡å™¨

**æ–‡ä»¶**: `fairy-desk/tracker_server.py`

```python
from flask import Flask
from flask_socketio import SocketIO, emit
from flask_cors import CORS

app = Flask(__name__)
app.config['SECRET_KEY'] = 'secret!'
CORS(app)
socketio = SocketIO(app,
                    cors_allowed_origins="*",
                    async_mode='eventlet')

active_targets = {}  # å­˜å‚¨æ´»è·ƒç›®æ ‡

@socketio.on('connect')
def handle_connect():
    print('âœ… å®¢æˆ·ç«¯å·²è¿æ¥')
    emit('connected', {'status': 'success'})

@socketio.on('report_position')
def handle_position_report(data):
    """æ¥æ”¶GPSè®¾å¤‡ä¸ŠæŠ¥çš„ä½ç½®"""
    target_id = data['target_id']
    active_targets[target_id] = {
        'target_id': target_id,
        'name': data.get('name', f'Target {target_id}'),
        'lat': data['lat'],
        'lon': data['lon'],
        'speed': data.get('speed', 0),
        'heading': data.get('heading', 0),
        'altitude': data.get('altitude', 0),
        'timestamp': time.time()
    }

    # å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
    emit('target_update', active_targets[target_id], broadcast=True)

if __name__ == '__main__':
    socketio.run(app, host='0.0.0.0', port=5001)
```

---

### 2. è‡ªåŠ¨æ¸…ç†è¶…æ—¶ç›®æ ‡

**åå°çº¿ç¨‹**:

```python
from threading import Thread
import time

def cleanup_old_targets():
    """æ¸…ç†è¶…è¿‡5åˆ†é’Ÿæœªæ›´æ–°çš„ç›®æ ‡"""
    while True:
        current_time = time.time()
        to_remove = []

        for target_id, data in active_targets.items():
            if current_time - data.get('timestamp', 0) > 300:  # 5åˆ†é’Ÿ
                to_remove.append(target_id)

        for target_id in to_remove:
            del active_targets[target_id]
            socketio.emit('target_lost', {'target_id': target_id})
            print(f'ğŸ”´ ç›®æ ‡ {target_id} ä¿¡å·ä¸¢å¤±')

        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

# å¯åŠ¨æ¸…ç†çº¿ç¨‹
cleanup_thread = Thread(target=cleanup_old_targets, daemon=True)
cleanup_thread.start()
```

---

## ğŸ›°ï¸ GPSè¿½è¸ªå™¨æ¨¡æ‹Ÿå™¨

**æµ‹è¯•å·¥å…·**: `tracker_simulator.py`

```python
import requests
import time
import random
import math

class GPSTrackerSimulator:
    """æ¨¡æ‹ŸGPSè¿½è¸ªå™¨è®¾å¤‡"""

    def __init__(self, target_id, start_lat, start_lon):
        self.target_id = target_id
        self.lat = start_lat
        self.lon = start_lon
        self.heading = random.uniform(0, 360)
        self.speed = random.uniform(20, 80)  # km/h

    def simulate_movement(self):
        """æ¨¡æ‹ŸçœŸå®çš„ç§»åŠ¨æ¨¡å¼"""
        # é€Ÿåº¦å˜åŒ–
        self.speed += random.uniform(-5, 5)
        self.speed = max(0, min(120, self.speed))

        # æ–¹å‘å˜åŒ–
        self.heading += random.uniform(-15, 15)
        self.heading = self.heading % 360

        # è®¡ç®—æ–°ä½ç½®
        distance_km = self.speed / 3600  # 1ç§’ç§»åŠ¨çš„è·ç¦»
        lat_change = distance_km * math.cos(math.radians(self.heading)) / 111
        lon_change = distance_km * math.sin(math.radians(self.heading)) / \
                     (111 * math.cos(math.radians(self.lat)))

        self.lat += lat_change
        self.lon += lon_change

    def report_position(self, server_url='http://localhost:5001'):
        """å‘æœåŠ¡å™¨ä¸ŠæŠ¥ä½ç½®"""
        data = {
            'target_id': self.target_id,
            'name': f'è½¦è¾†-{self.target_id}',
            'lat': self.lat,
            'lon': self.lon,
            'speed': round(self.speed, 1),
            'heading': round(self.heading, 1),
            'altitude': random.randint(50, 200)
        }

        try:
            # é€šè¿‡WebSocket emitäº‹ä»¶
            # å®é™…éƒ¨ç½²ä¸­GPSè®¾å¤‡ç›´æ¥è¿æ¥WebSocket
            print(f'ğŸ“¡ {self.target_id}: {self.lat:.5f}, {self.lon:.5f}')
        except Exception as e:
            print(f'âŒ ä¸ŠæŠ¥å¤±è´¥: {e}')

    def run(self, interval=2):
        """æŒç»­è¿è¡Œ"""
        while True:
            self.simulate_movement()
            self.report_position()
            time.sleep(interval)
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
pip install flask flask-socketio flask-cors eventlet
```

### 2. å¯åŠ¨è¿½è¸ªæœåŠ¡å™¨

```bash
cd /home/user/hidrs/fairy-desk
python tracker_server.py

# è¾“å‡ºï¼š
# ğŸ›°ï¸ è¿½è¸ªæœåŠ¡å™¨å¯åŠ¨åœ¨ http://localhost:5001
```

### 3. åˆ›å»ºå‰ç«¯é¡µé¢

```bash
# åˆ›å»ºæ¨¡æ¿ç›®å½•
mkdir -p /home/user/hidrs/fairy-desk/templates/widgets

# å¤åˆ¶ realtime_tracker.html åˆ° templates/widgets/
```

### 4. æ·»åŠ è·¯ç”±åˆ°FAIRY-DESK

**åœ¨ `fairy-desk/app.py` ä¸­æ·»åŠ **:

```python
@app.route('/widget/realtime-tracker')
def widget_realtime_tracker():
    """å®æ—¶ç›®æ ‡è¿½è¸ªç³»ç»Ÿ"""
    return render_template('widgets/realtime_tracker.html')
```

### 5. é…ç½®åˆ°FAIRY-DESKå·¦å±

**ä¿®æ”¹ `fairy-desk/config.json`**:

```json
{
  "left_screen": {
    "tabs": [
      {
        "id": "realtime-tracker",
        "name": "å®æ—¶è¿½è¸ª",
        "icon": "ğŸ›°ï¸",
        "url": "/widget/realtime-tracker",
        "loadStrategy": "lazy",
        "category": "security",
        "builtIn": false
      }
    ]
  }
}
```

### 6. å¯åŠ¨æµ‹è¯•

```bash
# ç»ˆç«¯1ï¼šå¯åŠ¨WebSocketæœåŠ¡å™¨
python tracker_server.py

# ç»ˆç«¯2ï¼šå¯åŠ¨æ¨¡æ‹Ÿå™¨ï¼ˆå¯é€‰ï¼‰
python tracker_simulator.py

# ç»ˆç«¯3ï¼šå¯åŠ¨FAIRY-DESK
cd /home/user/hidrs/fairy-desk
python app.py

# æµè§ˆå™¨è®¿é—®ï¼š
http://localhost:5001/widget/realtime-tracker
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å‰ç«¯ä¼˜åŒ–

**è½¨è¿¹ç‚¹æ•°é‡é™åˆ¶**:
```javascript
if (this.trail.length > 200) {
  this.trail.shift();  // åªä¿ç•™200ä¸ªç‚¹
}
```

**åŠ¨ç”»å¸§ç‡æ§åˆ¶**:
```javascript
const fps = 30;
const interval = 1000 / fps;  // 33.3ms per frame
```

**æ ‡è®°èšåˆ**ï¼ˆå¤šç›®æ ‡åœºæ™¯ï¼‰:
```javascript
const markerGroup = L.markerClusterGroup({
  maxClusterRadius: 50,
  spiderfyOnMaxZoom: true
});
```

---

### 2. åç«¯ä¼˜åŒ–

**äº‹ä»¶èŠ‚æµ**ï¼ˆé˜²æ­¢é¢‘ç¹å¹¿æ’­ï¼‰:
```python
from time import time

last_broadcast = {}

def should_broadcast(target_id, min_interval=1.0):
    """æœ€å°1ç§’é—´éš”æ‰å¹¿æ’­"""
    now = time()
    if target_id not in last_broadcast:
        last_broadcast[target_id] = now
        return True

    if now - last_broadcast[target_id] >= min_interval:
        last_broadcast[target_id] = now
        return True

    return False
```

**è¿æ¥æ•°é™åˆ¶**:
```python
from flask_limiter import Limiter

limiter = Limiter(
    app,
    key_func=lambda: request.remote_addr,
    default_limits=["100 per minute"]
)
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è®¤è¯ä¸æˆæƒ

**WebSocketè¿æ¥è®¤è¯**:

```python
from flask_login import current_user

@socketio.on('connect')
def handle_connect():
    # éªŒè¯ç”¨æˆ·èº«ä»½
    if not current_user.is_authenticated:
        return False  # æ‹’ç»è¿æ¥

    if not current_user.has_permission('view_tracking'):
        return False

    emit('connected', {'status': 'success'})
```

### 2. æ•°æ®åŠ å¯†

**HTTPS + WSS**:
```python
if __name__ == '__main__':
    socketio.run(app,
                 host='0.0.0.0',
                 port=5001,
                 ssl_context=('cert.pem', 'key.pem'))  # SSLè¯ä¹¦
```

### 3. æƒé™åˆ†çº§

| æƒé™ç­‰çº§ | åŠŸèƒ½ |
|---------|------|
| **åªè¯»** | æŸ¥çœ‹ç›®æ ‡ä½ç½® |
| **æ ‡å‡†** | æŸ¥çœ‹ä½ç½® + è½¨è¿¹ |
| **ç®¡ç†å‘˜** | å…¨éƒ¨åŠŸèƒ½ + æ·»åŠ ç›®æ ‡ |

---

## ğŸ’¡ åº”ç”¨åœºæ™¯

### 1. ç‰©æµè½¦é˜Ÿç®¡ç†

**åœºæ™¯**: è´§è¿å…¬å¸è¿½è¸ª100è¾†è¿è¾“è½¦

**é…ç½®**:
- æ¯è¾†è½¦å®‰è£…GPSè¿½è¸ªå™¨
- 5ç§’ä¸ŠæŠ¥ä¸€æ¬¡ä½ç½®
- è°ƒåº¦ä¸­å¿ƒå®æ—¶ç›‘æ§

**æ•ˆæœ**:
- å®æ—¶æŒæ¡è½¦è¾†ä½ç½®
- é¢„è®¡åˆ°è¾¾æ—¶é—´
- å¼‚å¸¸è·¯çº¿å‘Šè­¦

---

### 2. é‡å¤–ä½œä¸šäººå‘˜å®šä½

**åœºæ™¯**: åœ°è´¨å‹˜æ¢é˜Ÿè¿½è¸ª12åé˜Ÿå‘˜

**é…ç½®**:
- æ¯äººä½©æˆ´GPSæ‰‹ç¯
- 10ç§’ä¸ŠæŠ¥ä¸€æ¬¡
- åŸºåœ°å®æ—¶ç›‘æ§

**æ•ˆæœ**:
- ç¡®ä¿äººå‘˜å®‰å…¨
- ç´§æ€¥æ•‘æ´å®šä½
- æ´»åŠ¨èŒƒå›´ç›‘æ§

---

### 3. æ— äººæœºé›†ç¾¤ç›‘æ§

**åœºæ™¯**: 5æ¶æ— äººæœºååŒä½œä¸š

**é…ç½®**:
- æ¯æ¶æ— äººæœºå†…ç½®GPS
- 2ç§’ä¸ŠæŠ¥ä¸€æ¬¡
- åœ°é¢ç«™ç›‘æ§

**æ•ˆæœ**:
- é˜²æ­¢ç¢°æ’
- ä»»åŠ¡åè°ƒ
- å®æ—¶è§†é¢‘å åŠ 

---

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### 1. åœ°ç†å›´æ å‘Šè­¦

**åŠŸèƒ½**: ç›®æ ‡è¿›å…¥/ç¦»å¼€æŒ‡å®šåŒºåŸŸæ—¶å‘Šè­¦

```javascript
function checkGeofence(target) {
  geofences.forEach(fence => {
    const distance = calculateDistance(target.position, fence.center);
    if (distance < fence.radius) {
      showAlert(`âš ï¸ ${target.name} è¿›å…¥ç¦åŒºï¼`);
    }
  });
}
```

---

### 2. è·¯å¾„é¢„æµ‹

**åŠŸèƒ½**: åŸºäºå†å²è½¨è¿¹é¢„æµ‹æœªæ¥ä½ç½®

```javascript
function predictNextPosition(target) {
  if (target.trail.length < 3) return null;

  // çº¿æ€§å›å½’é¢„æµ‹
  const recentPoints = target.trail.slice(-5);
  const avgSpeed = target.speed;
  const avgHeading = target.heading;

  // é¢„æµ‹5åˆ†é’Ÿåçš„ä½ç½®
  const distance = (avgSpeed / 60) * 5;  // km
  const predictedLat = target.position[0] +
    (distance * Math.cos(avgHeading * Math.PI / 180)) / 111;
  const predictedLon = target.position[1] +
    (distance * Math.sin(avgHeading * Math.PI / 180)) / 111;

  return [predictedLat, predictedLon];
}
```

---

### 3. å†å²è½¨è¿¹å›æ”¾

**åŠŸèƒ½**: å›æ”¾ç›®æ ‡è¿‡å»24å°æ—¶çš„ç§»åŠ¨è½¨è¿¹

```javascript
class TrackPlayback {
  constructor(historicalData) {
    this.data = historicalData;
    this.currentIndex = 0;
    this.playing = false;
  }

  play(speed = 1000) {
    this.playing = true;
    const interval = setInterval(() => {
      if (!this.playing || this.currentIndex >= this.data.length) {
        clearInterval(interval);
        return;
      }

      const point = this.data[this.currentIndex];
      updateMarkerPosition(point.lat, point.lon);
      this.currentIndex++;
    }, speed);
  }
}
```

---

### 4. å¤šç”¨æˆ·ååŒç›‘æ§

**åŠŸèƒ½**: å¤šä¸ªæ“ä½œå‘˜åŒæ—¶ç›‘æ§ï¼Œæƒé™éš”ç¦»

```python
@socketio.on('join_room')
def handle_join_room(data):
    room = data['room']
    join_room(room)

    # åªå‘è¯¥æˆ¿é—´å¹¿æ’­
    emit('user_joined', {
        'user': current_user.name,
        'room': room
    }, room=room)
```

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### éš¾ç‚¹1: ç½‘ç»œå»¶è¿Ÿå¯¼è‡´ä½ç½®è·³è·ƒ

**é—®é¢˜**: ç½‘ç»œæ³¢åŠ¨æ—¶ä½ç½®çªç„¶è·³è·ƒ

**è§£å†³**:
- ä½¿ç”¨æ’å€¼åŠ¨ç”»å¹³æ»‘è¿‡æ¸¡
- å¼‚å¸¸ä½ç½®æ£€æµ‹ï¼ˆé€Ÿåº¦>200km/håˆ™å¿½ç•¥ï¼‰
- å¡å°”æ›¼æ»¤æ³¢å¹³æ»‘è½¨è¿¹

```javascript
function isValidPosition(oldPos, newPos, maxSpeed = 200) {
  const distance = calculateDistance(oldPos, newPos);
  const time = (Date.now() - lastUpdate) / 1000 / 3600;
  const speed = distance / time;
  return speed <= maxSpeed;
}
```

---

### éš¾ç‚¹2: å¤§é‡ç›®æ ‡æ—¶æ€§èƒ½ä¸‹é™

**é—®é¢˜**: 100+ç›®æ ‡æ—¶åœ°å›¾å¡é¡¿

**è§£å†³**:
- ä½¿ç”¨MarkerClusterèšåˆ
- è§†å£å¤–çš„ç›®æ ‡ä¸æ¸²æŸ“åŠ¨ç”»
- Canvasæ¸²æŸ“æ›¿ä»£DOMæ ‡è®°ï¼ˆå¤§è§„æ¨¡åœºæ™¯ï¼‰

```javascript
map.on('moveend', () => {
  const bounds = map.getBounds();
  targets.forEach(target => {
    if (bounds.contains(target.position)) {
      target.marker.addTo(map);  // åœ¨è§†å£å†…
    } else {
      map.removeLayer(target.marker);  // è§†å£å¤–ç§»é™¤
    }
  });
});
```

---

### éš¾ç‚¹3: WebSocketè¿æ¥æ–­å¼€é‡è¿

**é—®é¢˜**: ç½‘ç»œä¸­æ–­åæ— æ³•æ¢å¤è¿½è¸ª

**è§£å†³**:
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- æ–­çº¿æœŸé—´æ•°æ®ç¼“å­˜
- é‡è¿åè¡¥å‘ä¸¢å¤±æ•°æ®

```javascript
socket.on('disconnect', () => {
  console.warn('âš ï¸ è¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¯•...');
  setTimeout(() => {
    socket.connect();
  }, 5000);
});

socket.on('reconnect', () => {
  console.log('âœ… é‡æ–°è¿æ¥æˆåŠŸ');
  // è¯·æ±‚ä¸¢å¤±çš„æ•°æ®
  socket.emit('request_missed_data', { since: lastUpdateTime });
});
```

---

## ğŸ“š å‚è€ƒèµ„æº

### æ–‡æ¡£é“¾æ¥

- **Leaflet.jså®˜æ–¹æ–‡æ¡£**: https://leafletjs.com/reference.html
- **Socket.IOæ–‡æ¡£**: https://socket.io/docs/v4/
- **Flask-SocketIO**: https://flask-socketio.readthedocs.io/

### å¼€æºé¡¹ç›®å‚è€ƒ

- **Traccar**: å¼€æºGPSè¿½è¸ªå¹³å°ï¼ˆJavaï¼‰
- **OwnTracks**: å¼€æºä½ç½®è¿½è¸ªï¼ˆiOS/Androidï¼‰
- **GPS Logger**: å¼€æºGPSæ—¥å¿—è®°å½•

---

## ğŸ“ TODOæ¸…å•

- [ ] å®ç°WebSocketæœåŠ¡å™¨
- [ ] åˆ›å»ºå‰ç«¯è¿½è¸ªç•Œé¢
- [ ] å¼€å‘GPSæ¨¡æ‹Ÿå™¨æµ‹è¯•
- [ ] é›†æˆåˆ°FAIRY-DESK
- [ ] æ·»åŠ åœ°ç†å›´æ åŠŸèƒ½
- [ ] å®ç°è·¯å¾„é¢„æµ‹
- [ ] æ·»åŠ å†å²è½¨è¿¹å›æ”¾
- [ ] é…ç½®HTTPS/WSS
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•ï¼ˆ1000+ç›®æ ‡ï¼‰
- [ ] ç¼–å†™ç”¨æˆ·æ‰‹å†Œ

---

## ğŸ† é¡¹ç›®äº®ç‚¹

1. **ç”µå½±çº§è§†è§‰æ•ˆæœ** - å†›äº‹é£æ ¼UIï¼Œè„‰å†²åŠ¨ç”»ï¼Œå‘å…‰æ•ˆæœ
2. **å¹³æ»‘åŠ¨ç”»** - 30FPSæ’å€¼ï¼Œæ— è·³è·ƒæ„Ÿ
3. **å®æ—¶æ€§å¼º** - WebSocketæ¨é€ï¼Œ2ç§’å»¶è¿Ÿ
4. **å¯æ‰©å±•æ€§** - æ”¯æŒåœ°ç†å›´æ ã€è·¯å¾„é¢„æµ‹ç­‰åŠŸèƒ½
5. **æ˜“äºéƒ¨ç½²** - Flask + Leafletï¼Œæ— å¤æ‚ä¾èµ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**çŠ¶æ€**: ğŸ“‹ è§„åˆ’å®Œæˆï¼Œå¾…å®æ–½
