input {
  # 从文件读取数据
  file {
    path => "${DATA_PATH:/path/to/data}/*.txt"
    start_position => "beginning"
    sincedb_path => "${SINCEDB_PATH:/dev/null}"
    mode => "read"
  }
}

filter {
  # 解析格式为: email----password 的数据
  grok {
    match => { "message" => "(?<email>[^-]+)----(?<password>.+)" }
  }
  
  # 从邮箱解析用户名和后缀
  if [email] {
    grok {
      match => { "email" => "(?<user>[^@]+)@(?<suffix_email>.+)" }
    }
    
    # 生成密码哈希
    if [password] {
      ruby {
        code => "
          require 'digest/md5'
          event.set('passwordHash', Digest::MD5.hexdigest(event.get('password')))
        "
      }
    }
    
    # 添加时间和来源信息
    mutate {
      add_field => {
        "xtime" => "${LEAK_TIME:unknown}"
        "source" => "${SOURCE:unknown}"
        "create_time" => "%{+YYYY/MM/dd HH:mm:ss}"
      }
      remove_field => ["message", "@version", "path", "host", "tags"]
    }
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["${ES_HOST:localhost}:${ES_PORT:9200}"]
    index => "${ES_INDEX:socialdb}"
    user => "${ES_USER:}"
    password => "${ES_PASSWORD:}"
  }
  
  # 调试输出
  stdout {
    codec => rubydebug
  }
}