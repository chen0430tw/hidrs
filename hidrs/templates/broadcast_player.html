<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIDRS å…¨çƒå¹¿æ’­æ’­æ”¾å™¨</title>

    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
        }

        .player-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #broadcast-player {
            width: 100%;
            height: 100%;
        }

        .video-js {
            width: 100vw !important;
            height: 100vh !important;
        }

        /* ä¸€å›¾æµæ¨¡å¼ */
        .oneimage-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            overflow: hidden;
        }

        .oneimage-mode.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .oneimage-mode img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* å¼ºåˆ¶å…¨å±è¦†ç›– */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            color: white;
            padding: 20px;
        }

        .fullscreen-overlay.active {
            display: block;
        }

        .broadcast-message {
            text-align: center;
            padding: 40px;
        }

        .broadcast-message h1 {
            font-size: 48px;
            margin-bottom: 30px;
            color: #ff0000;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .broadcast-message p {
            font-size: 24px;
            line-height: 1.6;
        }

        .level-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
        }

        .level-0 { background: #28a745; }
        .level-1 { background: #ffc107; }
        .level-2 { background: #fd7e14; }
        .level-3 { background: #dc3545; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .close-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }

        .close-button.can-close {
            display: block;
        }

        .close-button:hover {
            background: #ddd;
        }

        /* é‡è¿æç¤º */
        .reconnecting-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 10001;
        }

        .reconnecting-indicator.active {
            display: block;
        }

        /* ç¦ç”¨å³é”®èœå•å’Œé€‰æ‹©ï¼ˆLevel 3ï¼‰ */
        .no-interaction {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
        }

        .no-interaction .close-button {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- è§†é¢‘æ’­æ”¾å™¨ -->
    <div class="player-container">
        <video id="broadcast-player" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto">
            <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
        </video>
    </div>

    <!-- ä¸€å›¾æµæ¨¡å¼ -->
    <div id="oneimage-mode" class="oneimage-mode">
        <img id="oneimage-content" src="" alt="å¹¿æ’­å›¾ç‰‡">
    </div>

    <!-- å…¨å±æ¶ˆæ¯è¦†ç›– -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <button id="close-button" class="close-button">
            <i class="bi bi-x-circle"></i> å…³é—­å¹¿æ’­
        </button>
        <div id="level-badge" class="level-badge"></div>
        <div class="broadcast-message">
            <h1 id="broadcast-title"></h1>
            <p id="broadcast-content"></p>
        </div>
    </div>

    <!-- é‡è¿æç¤º -->
    <div id="reconnecting-indicator" class="reconnecting-indicator">
        <i class="bi bi-arrow-repeat"></i> æ­£åœ¨é‡è¿...
    </div>

    <!-- Video.js -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // åˆå§‹åŒ–æ’­æ”¾å™¨
        const player = videojs('broadcast-player', {
            fluid: true,
            autoplay: true,
            controls: true,
            preload: 'auto',
            liveui: true,
            html5: {
                vhs: {
                    overrideNative: true
                },
                nativeVideoTracks: false,
                nativeAudioTracks: false,
                nativeTextTracks: false
            }
        });

        // WebSocketè¿æ¥
        const socket = io('http://localhost:5000');
        let currentBroadcast = null;
        let canClose = true;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        socket.on('connect', () => {
            console.log('âœ… å·²è¿æ¥åˆ°å¹¿æ’­æœåŠ¡å™¨');
            document.getElementById('reconnecting-indicator').classList.remove('active');
            reconnectAttempts = 0;
        });

        socket.on('disconnect', () => {
            console.log('âŒ ä¸å¹¿æ’­æœåŠ¡å™¨æ–­å¼€è¿æ¥');
            document.getElementById('reconnecting-indicator').classList.add('active');
            attemptReconnect();
        });

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(() => {
                    socket.connect();
                }, 3000);
            }
        }

        // æ¥æ”¶å¹¿æ’­é€šçŸ¥
        socket.on('broadcast_start', (data) => {
            console.log('ğŸ“¡ æ”¶åˆ°å¹¿æ’­é€šçŸ¥:', data);
            currentBroadcast = data;
            handleBroadcast(data);
        });

        // ä¸€å›¾æµå¹¿æ’­
        socket.on('oneimage_broadcast', (data) => {
            console.log('ğŸ–¼ï¸ æ”¶åˆ°ä¸€å›¾æµå¹¿æ’­:', data);
            currentBroadcast = data;
            handleOneImageBroadcast(data);
        });

        // è®¾å¤‡åŠ«æŒæŒ‡ä»¤
        socket.on('hijack_device', (data) => {
            console.log('âš ï¸ æ”¶åˆ°è®¾å¤‡åŠ«æŒæŒ‡ä»¤:', data);
            handleDeviceHijack(data);
        });

        // å¹¿æ’­åœæ­¢
        socket.on('broadcast_stop', (data) => {
            console.log('ğŸ›‘ å¹¿æ’­å·²åœæ­¢');
            stopBroadcast();
        });

        function handleBroadcast(data) {
            const { broadcast_id, title, level, hls_url, permissions } = data;

            // æ›´æ–°æƒé™
            canClose = permissions?.can_close !== false;
            updateCloseButton();

            // è®¾ç½®ç­‰çº§å¾½ç« 
            const levelBadge = document.getElementById('level-badge');
            levelBadge.textContent = `Level ${level}`;
            levelBadge.className = `level-badge level-${level}`;

            // å¦‚æœæœ‰HLSæµï¼ŒåŠ è½½æ’­æ”¾
            if (hls_url) {
                player.src({
                    src: hls_url,
                    type: 'application/x-mpegURL'
                });
                player.play();

                // Level 2+ è‡ªåŠ¨å…¨å±
                if (level >= 2) {
                    enterFullscreen();
                }

                // Level 3 ç¦ç”¨äº¤äº’
                if (level >= 3) {
                    document.body.classList.add('no-interaction');
                    disableKeyboardShortcuts();
                }
            }

            // æ˜¾ç¤ºå¹¿æ’­æ ‡é¢˜
            document.getElementById('broadcast-title').textContent = title;
            if (data.content) {
                document.getElementById('broadcast-content').textContent = data.content;
                document.getElementById('fullscreen-overlay').classList.add('active');
            }
        }

        function handleOneImageBroadcast(data) {
            const { image_url, title, level, duration, permissions } = data;

            // æ›´æ–°æƒé™
            canClose = permissions?.can_close !== false;
            updateCloseButton();

            // æ˜¾ç¤ºä¸€å›¾æµ
            document.getElementById('oneimage-content').src = image_url;
            document.getElementById('oneimage-mode').classList.add('active');

            // Level 3 ç¦ç”¨æ‰€æœ‰äº¤äº’
            if (level >= 3) {
                document.body.classList.add('no-interaction');
                disableKeyboardShortcuts();
                disableRightClick();
            }

            // å¦‚æœè®¾ç½®äº†æŒç»­æ—¶é—´ï¼Œè‡ªåŠ¨å…³é—­
            if (duration > 0) {
                setTimeout(() => {
                    if (canClose) {
                        stopBroadcast();
                    }
                }, duration * 1000);
            }
        }

        function handleDeviceHijack(data) {
            const { hijack_type } = data;

            switch (hijack_type) {
                case 'oneimage':
                    // å·²é€šè¿‡oneimage_broadcastå¤„ç†
                    break;
                case 'kiosk':
                    enterKioskMode();
                    break;
                case 'dns':
                    // DNSåŠ«æŒç”±ç½‘ç»œå±‚å¤„ç†ï¼Œå®¢æˆ·ç«¯æ— éœ€æ“ä½œ
                    console.log('ğŸŒ DNSåŠ«æŒå·²æ¿€æ´»');
                    break;
            }
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function enterKioskMode() {
            // è¿›å…¥Kioskæ¨¡å¼ï¼ˆæµè§ˆå™¨å…¨å±é”å®šï¼‰
            enterFullscreen();
            disableKeyboardShortcuts();
            disableRightClick();
            document.body.classList.add('no-interaction');

            // å°è¯•é”å®šæ–¹å‘ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(e => {
                    console.log('æ— æ³•é”å®šå±å¹•æ–¹å‘:', e);
                });
            }
        }

        function disableKeyboardShortcuts() {
            // ç¦ç”¨å¸¸è§çš„é€€å‡ºå¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (!canClose) {
                    // ç¦ç”¨ ESC, F11, Alt+F4, Ctrl+W, Ctrl+Q
                    if (e.key === 'Escape' || e.key === 'F11' ||
                        (e.altKey && e.key === 'F4') ||
                        (e.ctrlKey && (e.key === 'w' || e.key === 'q'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }
            }, true);
        }

        function disableRightClick() {
            document.addEventListener('contextmenu', (e) => {
                if (!canClose) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        function updateCloseButton() {
            const closeButton = document.getElementById('close-button');
            if (canClose) {
                closeButton.classList.add('can-close');
            } else {
                closeButton.classList.remove('can-close');
            }
        }

        function stopBroadcast() {
            // åœæ­¢æ’­æ”¾
            player.pause();
            player.src('');

            // éšè—è¦†ç›–å±‚
            document.getElementById('fullscreen-overlay').classList.remove('active');
            document.getElementById('oneimage-mode').classList.remove('active');

            // æ¢å¤äº¤äº’
            document.body.classList.remove('no-interaction');

            // é€€å‡ºå…¨å±
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }

            currentBroadcast = null;
            canClose = true;
        }

        // å…³é—­æŒ‰é’®ç‚¹å‡»
        document.getElementById('close-button').addEventListener('click', () => {
            if (canClose) {
                stopBroadcast();
            }
        });

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });

        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && currentBroadcast && currentBroadcast.level >= 2) {
                // Level 2+ è‡ªåŠ¨é‡æ–°è¿›å…¥å…¨å±
                setTimeout(enterFullscreen, 1000);
            }
        });

        console.log('ğŸ“» HIDRS å…¨çƒå¹¿æ’­æ’­æ”¾å™¨å·²å°±ç»ª');
    </script>
</body>
</html>
