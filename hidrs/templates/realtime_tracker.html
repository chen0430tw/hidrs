<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶Trackerè¿½è¸ªç³»ç»Ÿ - HIDRS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* å†›äº‹é£æ ¼å…¨å±€æ ·å¼ */
        body {
            background-color: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .tracker-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background: linear-gradient(180deg, #001a00 0%, #000 100%);
            border-bottom: 2px solid #00ff00;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
        }

        .status-bar h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            letter-spacing: 3px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* åœ°å›¾å®¹å™¨ */
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 350px;
            background: rgba(0, 26, 0, 0.95);
            border-left: 2px solid #00ff00;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h3 {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* ç›®æ ‡å¡ç‰‡ */
        .target-card {
            background: rgba(0, 40, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            transition: all 0.3s;
        }

        .target-card:hover {
            background: rgba(0, 60, 0, 0.9);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        .target-card .target-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
        }

        .target-card .info-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .target-card .label {
            color: #00cc00;
        }

        .target-card .value {
            color: #00ff00;
            font-weight: bold;
        }

        /* è‡ªå®šä¹‰æ ‡è®°æ ·å¼ */
        .marker-dot {
            width: 16px;
            height: 16px;
            background: #ff0000;
            border: 3px solid #fff;
            border-radius: 50%;
            animation: ping 2s infinite;
            box-shadow: 0 0 10px #ff0000;
        }

        @keyframes ping {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.8);
            }
            100% {
                box-shadow: 0 0 0 20px rgba(255, 0, 0, 0);
            }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-military {
            background: rgba(0, 60, 0, 0.8);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .btn-military:hover {
            background: rgba(0, 100, 0, 0.9);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .btn-military:active {
            transform: scale(0.95);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #001a00;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #00cc00;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-panel {
            background: rgba(0, 40, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stats-panel .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="tracker-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <h1>ğŸ›°ï¸ REALTIME TRACKER SYSTEM</h1>
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">DISCONNECTED</span>
            </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div class="main-container">
            <!-- åœ°å›¾ -->
            <div id="map"></div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <h3><i class="bi bi-bar-chart-line"></i> SYSTEM STATUS</h3>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-panel">
                    <div class="stat-item">
                        <span>ACTIVE TARGETS:</span>
                        <span id="activeTargets">0</span>
                    </div>
                    <div class="stat-item">
                        <span>TOTAL UPDATES:</span>
                        <span id="totalUpdates">0</span>
                    </div>
                    <div class="stat-item">
                        <span>UPDATE RATE:</span>
                        <span id="updateRate">0/s</span>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="control-buttons">
                    <button class="btn-military" id="clearTrails">
                        <i class="bi bi-eraser"></i> CLEAR TRAILS
                    </button>
                    <button class="btn-military" id="autoFitView">
                        <i class="bi bi-arrows-fullscreen"></i> AUTO FIT
                    </button>
                </div>

                <h3><i class="bi bi-crosshair"></i> TARGETS</h3>

                <!-- ç›®æ ‡åˆ—è¡¨ -->
                <div id="targetList">
                    <div style="color: #00cc00; text-align: center; padding: 20px;">
                        No active targets
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let map;
        let socket;
        let targets = {};
        let totalUpdates = 0;
        let updateCounter = 0;
        let lastUpdateTime = Date.now();

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false
            }).setView([39.9042, 116.4074], 5);

            // ä½¿ç”¨æš—è‰²åœ°å›¾
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap, Â© CartoDB',
                maxZoom: 18
            }).addTo(map);

            console.log('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            // è¿æ¥åˆ°è¿½è¸ªæœåŠ¡å™¨ï¼ˆç«¯å£5002ï¼‰
            socket = io('http://localhost:5002');

            socket.on('connect', () => {
                console.log('âœ… WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                console.warn('âŒ WebSocketæ–­å¼€è¿æ¥');
                updateConnectionStatus(false);
            });

            socket.on('connected', (data) => {
                console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”:', data);
            });

            socket.on('target_update', (data) => {
                handleTargetUpdate(data);
            });

            socket.on('target_lost', (data) => {
                handleTargetLost(data);
            });

            socket.on('error', (data) => {
                console.error('âš ï¸ æœåŠ¡å™¨é”™è¯¯:', data);
            });
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'CONNECTED';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'DISCONNECTED';
            }
        }

        // å¤„ç†ç›®æ ‡æ›´æ–°
        function handleTargetUpdate(data) {
            const targetId = data.target_id;

            if (!targets[targetId]) {
                // æ–°ç›®æ ‡
                createTarget(data);
            } else {
                // æ›´æ–°ç°æœ‰ç›®æ ‡
                updateTarget(data);
            }

            // æ›´æ–°ç»Ÿè®¡
            totalUpdates++;
            updateCounter++;
            updateStats();

            // æ›´æ–°ä¾§è¾¹æ 
            updateTargetCard(data);
        }

        // åˆ›å»ºæ–°ç›®æ ‡
        function createTarget(data) {
            const targetId = data.target_id;

            // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-dot"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            const marker = L.marker([data.lat, data.lon], { icon: markerIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="color: #000; font-family: 'Courier New';">
                        <strong>${data.name}</strong><br>
                        ID: ${targetId}<br>
                        é€Ÿåº¦: ${data.speed} km/h<br>
                        æ–¹å‘: ${data.heading}Â°
                    </div>
                `);

            // åˆ›å»ºè½¨è¿¹çº¿
            const trail = L.polyline([[data.lat, data.lon]], {
                color: getRandomColor(),
                weight: 2,
                opacity: 0.6,
                dashArray: '5, 5'
            }).addTo(map);

            targets[targetId] = {
                data: data,
                marker: marker,
                trail: trail,
                trailPoints: [[data.lat, data.lon]],
                lastPosition: [data.lat, data.lon]
            };

            console.log(`âœ… æ–°ç›®æ ‡åˆ›å»º: ${targetId}`);
        }

        // æ›´æ–°ç›®æ ‡
        function updateTarget(data) {
            const targetId = data.target_id;
            const target = targets[targetId];

            const newPosition = [data.lat, data.lon];

            // å¹³æ»‘ç§»åŠ¨åŠ¨ç”»
            animateMarkerMove(target.marker, target.lastPosition, newPosition);

            // æ›´æ–°è½¨è¿¹
            target.trailPoints.push(newPosition);
            if (target.trailPoints.length > 200) {
                target.trailPoints.shift();  // ä¿ç•™æœ€è¿‘200ä¸ªç‚¹
            }
            target.trail.setLatLngs(target.trailPoints);

            // æ›´æ–°æ•°æ®
            target.data = data;
            target.lastPosition = newPosition;

            // æ›´æ–°å¼¹å‡ºçª—å£
            target.marker.setPopupContent(`
                <div style="color: #000; font-family: 'Courier New';">
                    <strong>${data.name}</strong><br>
                    ID: ${targetId}<br>
                    é€Ÿåº¦: ${data.speed} km/h<br>
                    æ–¹å‘: ${data.heading}Â°<br>
                    æµ·æ‹”: ${data.altitude}m
                </div>
            `);
        }

        // å¹³æ»‘ç§»åŠ¨åŠ¨ç”»ï¼ˆ30å¸§æ’å€¼ï¼‰
        function animateMarkerMove(marker, from, to) {
            const steps = 30;
            const duration = 1000;  // 1ç§’
            const latStep = (to[0] - from[0]) / steps;
            const lngStep = (to[1] - from[1]) / steps;

            let step = 0;
            const interval = setInterval(() => {
                step++;
                if (step >= steps) {
                    clearInterval(interval);
                    marker.setLatLng(to);
                    return;
                }

                const newLat = from[0] + latStep * step;
                const newLng = from[1] + lngStep * step;
                marker.setLatLng([newLat, newLng]);
            }, duration / steps);
        }

        // å¤„ç†ç›®æ ‡ä¸¢å¤±
        function handleTargetLost(data) {
            const targetId = data.target_id;
            if (targets[targetId]) {
                map.removeLayer(targets[targetId].marker);
                map.removeLayer(targets[targetId].trail);
                delete targets[targetId];
                updateStats();
                updateTargetList();
                console.log(`ğŸ”´ ç›®æ ‡ä¸¢å¤±: ${targetId} (${data.reason})`);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('activeTargets').textContent = Object.keys(targets).length;
            document.getElementById('totalUpdates').textContent = totalUpdates;

            // è®¡ç®—æ›´æ–°é€Ÿç‡
            const now = Date.now();
            const elapsed = (now - lastUpdateTime) / 1000;
            if (elapsed >= 1) {
                const rate = updateCounter / elapsed;
                document.getElementById('updateRate').textContent = rate.toFixed(1) + '/s';
                updateCounter = 0;
                lastUpdateTime = now;
            }
        }

        // æ›´æ–°ç›®æ ‡å¡ç‰‡
        function updateTargetCard(data) {
            const targetId = data.target_id;
            let card = document.getElementById(`card-${targetId}`);

            if (!card) {
                // åˆ›å»ºæ–°å¡ç‰‡
                const targetList = document.getElementById('targetList');
                card = document.createElement('div');
                card.id = `card-${targetId}`;
                card.className = 'target-card';
                targetList.appendChild(card);

                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç›®æ ‡ï¼Œæ¸…é™¤"No active targets"æç¤º
                if (Object.keys(targets).length === 1) {
                    targetList.innerHTML = '';
                    targetList.appendChild(card);
                }
            }

            // æ›´æ–°å¡ç‰‡å†…å®¹
            card.innerHTML = `
                <div class="target-name">${data.name}</div>
                <div class="info-row">
                    <span class="label">ID:</span>
                    <span class="value">${targetId}</span>
                </div>
                <div class="info-row">
                    <span class="label">POSITION:</span>
                    <span class="value">${data.lat.toFixed(5)}, ${data.lon.toFixed(5)}</span>
                </div>
                <div class="info-row">
                    <span class="label">SPEED:</span>
                    <span class="value">${data.speed} km/h</span>
                </div>
                <div class="info-row">
                    <span class="label">HEADING:</span>
                    <span class="value">${data.heading}Â° (${getDirection(data.heading)})</span>
                </div>
                <div class="info-row">
                    <span class="label">ALTITUDE:</span>
                    <span class="value">${data.altitude}m</span>
                </div>
                <div class="info-row">
                    <span class="label">TRAIL POINTS:</span>
                    <span class="value">${targets[targetId] ? targets[targetId].trailPoints.length : 1}</span>
                </div>
            `;

            // ç‚¹å‡»å¡ç‰‡èšç„¦åˆ°ç›®æ ‡
            card.onclick = () => {
                if (targets[targetId]) {
                    map.setView(targets[targetId].lastPosition, 12);
                    targets[targetId].marker.openPopup();
                }
            };
        }

        // æ›´æ–°ç›®æ ‡åˆ—è¡¨
        function updateTargetList() {
            const targetList = document.getElementById('targetList');
            if (Object.keys(targets).length === 0) {
                targetList.innerHTML = '<div style="color: #00cc00; text-align: center; padding: 20px;">No active targets</div>';
            }
        }

        // è·å–æ–¹å‘æ–‡å­—
        function getDirection(heading) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }

        // è·å–éšæœºé¢œè‰²
        function getRandomColor() {
            const colors = ['#ff0000', '#ff6600', '#ffcc00', '#00ff00', '#0099ff', '#cc00ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // æ¸…é™¤æ‰€æœ‰è½¨è¿¹
        document.getElementById('clearTrails').addEventListener('click', () => {
            for (const targetId in targets) {
                targets[targetId].trailPoints = [targets[targetId].lastPosition];
                targets[targetId].trail.setLatLngs(targets[targetId].trailPoints);
            }
            console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰è½¨è¿¹');
        });

        // è‡ªåŠ¨é€‚åº”è§†å›¾
        document.getElementById('autoFitView').addEventListener('click', () => {
            if (Object.keys(targets).length > 0) {
                const bounds = L.latLngBounds(
                    Object.values(targets).map(t => t.lastPosition)
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initWebSocket();
            console.log('ğŸš€ å®æ—¶è¿½è¸ªç³»ç»Ÿå·²å¯åŠ¨');
        });
    </script>
</body>
</html>
