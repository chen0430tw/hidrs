<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒå¹¿æ’­ç³»ç»Ÿ - HIDRS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="/static/css/theme-styles.css" rel="stylesheet">
    <link href="/static/css/backgrounds.css" rel="stylesheet">

    <style>
        .broadcast-container {
            max-width: 1400px;
            margin: 60px auto 40px;
            padding: 20px;
        }

        .compliance-banner {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .mode-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .mode-simulation {
            background: #ffc107;
            color: #000;
        }

        .mode-test {
            background: #17a2b8;
            color: #fff;
        }

        .mode-live {
            background: #28a745;
            color: #fff;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 2px solid var(--border-color);
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .broadcast-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .broadcast-card.level-0 { border-left-color: #6c757d; }
        .broadcast-card.level-1 { border-left-color: #ffc107; }
        .broadcast-card.level-2 { border-left-color: #fd7e14; }
        .broadcast-card.level-3 { border-left-color: #dc3545; }

        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            margin: 5px 0;
            padding: 3px;
        }

        .log-entry .timestamp {
            color: #858585;
        }

        .log-entry .action {
            color: #4ec9b0;
        }

        .ssl-warning {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6347 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-broadcast"></i> HIDRS - å…¨çƒå¹¿æ’­ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house"></i> é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/plugins"><i class="bi bi-plugin"></i> æ’ä»¶ç®¡ç†</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="broadcast-container">
        <!-- åˆè§„æ€§è­¦å‘Š -->
        <div class="compliance-banner">
            <h4><i class="bi bi-exclamation-triangle-fill"></i> ä¸¥æ ¼åˆè§„å£°æ˜</h4>
            <p><strong>æœ¬ç³»ç»Ÿä»…ç”¨äºåˆæ³•æˆæƒåœºæ™¯ï¼š</strong></p>
            <ul class="mb-0">
                <li>ä¼ä¸šå†…éƒ¨ç´§æ€¥é€šçŸ¥ç³»ç»Ÿ</li>
                <li>å…¬å…±å®‰å…¨è­¦æŠ¥ç³»ç»Ÿ</li>
                <li>æ•™è‚²æœºæ„é€šçŸ¥ç³»ç»Ÿ</li>
                <li>ç»è¿‡æˆæƒçš„æµ‹è¯•ç¯å¢ƒ</li>
            </ul>
        </div>

        <!-- SSLæ—¶é—´æˆ³è­¦å‘Š -->
        <div class="ssl-warning">
            <h5><i class="bi bi-shield-exclamation"></i> SSLæ—¶é—´æˆ³æ£€æµ‹è§„é¿è¯´æ˜</h5>
            <p class="mb-2"><strong>å¦‚æœé‡åˆ°SSLè¯ä¹¦éªŒè¯å¤±è´¥ï¼š</strong></p>
            <ol class="mb-0">
                <li>å®¢æˆ·ç«¯ä½¿ç”¨ <code>fetch(url, {mode: 'no-cors'})</code> æˆ–ç¦ç”¨è¯ä¹¦éªŒè¯ï¼ˆä»…é™æµ‹è¯•ï¼‰</li>
                <li>æœåŠ¡å™¨ä½¿ç”¨è‡ªç­¾åè¯ä¹¦æ—¶ï¼Œå®¢æˆ·ç«¯æ·»åŠ è¯ä¹¦ä¾‹å¤–</li>
                <li>å¯¹äºNode.jsç¯å¢ƒï¼š<code>process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0'</code></li>
                <li>æµè§ˆå™¨å¼€å‘è€…æ¨¡å¼ï¼šç¦ç”¨å®‰å…¨ç­–ç•¥ï¼ˆchrome://flagsï¼‰</li>
            </ol>
        </div>

        <!-- æ¨¡å¼æŒ‡ç¤ºå™¨ -->
        <div id="modeIndicator"></div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="activeCount">0</div>
                <div class="label">æ´»è·ƒå¹¿æ’­</div>
            </div>
            <div class="stat-card">
                <div class="value" id="clientCount">0</div>
                <div class="label">è¿æ¥å®¢æˆ·ç«¯</div>
            </div>
            <div class="stat-card">
                <div class="value" id="historyCount">0</div>
                <div class="label">å†å²è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="value" id="logCount">0</div>
                <div class="label">æ¨¡æ‹Ÿæ—¥å¿—</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h5><i class="bi bi-broadcast-pin"></i> å¹¿æ’­æ§åˆ¶</h5>

            <form id="broadcastForm">
                <div class="mb-3">
                    <label for="broadcastTitle" class="form-label">å¹¿æ’­æ ‡é¢˜</label>
                    <input type="text" class="form-control" id="broadcastTitle" value="ç³»ç»Ÿç´§æ€¥é€šçŸ¥" required>
                </div>

                <div class="mb-3">
                    <label for="broadcastLevel" class="form-label">å¹¿æ’­çº§åˆ«</label>
                    <select class="form-select" id="broadcastLevel">
                        <option value="0">Level 0 - æ™®é€šï¼ˆå¯å…³é—­ï¼‰</option>
                        <option value="1">Level 1 - é‡è¦ï¼ˆéœ€ç¡®è®¤ï¼‰</option>
                        <option value="2" selected>Level 2 - ç´§æ€¥ï¼ˆä¸å¯å…³é—­ï¼‰</option>
                        <option value="3">Level 3 - æœ€é«˜çº§ï¼ˆå¼ºåˆ¶æ’­æ”¾ï¼‰</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="broadcastContent" class="form-label">å¹¿æ’­å†…å®¹</label>
                    <textarea class="form-control" id="broadcastContent" rows="3" required>æ£€æµ‹åˆ°ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‰€æœ‰äººå‘˜è¯·æ³¨æ„ï¼</textarea>
                </div>

                <div class="mb-3">
                    <label for="broadcastDuration" class="form-label">æŒç»­æ—¶é—´ï¼ˆç§’ï¼Œ0=æ— é™æœŸï¼‰</label>
                    <input type="number" class="form-control" id="broadcastDuration" value="300" min="0">
                </div>

                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-broadcast"></i> å¯åŠ¨å¹¿æ’­
                </button>
            </form>
        </div>

        <!-- æ´»è·ƒå¹¿æ’­åˆ—è¡¨ -->
        <div class="control-panel">
            <h5><i class="bi bi-list-ul"></i> æ´»è·ƒå¹¿æ’­</h5>
            <div id="activeBroadcasts">
                <p class="text-muted">å½“å‰æ²¡æœ‰æ´»è·ƒå¹¿æ’­</p>
            </div>
        </div>

        <!-- å·²è¿æ¥å®¢æˆ·ç«¯ -->
        <div class="control-panel">
            <h5><i class="bi bi-people"></i> å·²è¿æ¥å®¢æˆ·ç«¯ (<span id="clientCountText">0</span>)</h5>
            <div id="connectedClients">
                <p class="text-muted">å½“å‰æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥</p>
            </div>
        </div>

        <!-- æ¨¡æ‹Ÿæ—¥å¿—æŸ¥çœ‹å™¨ -->
        <div class="control-panel" id="simulationLogPanel" style="display: none;">
            <h5><i class="bi bi-terminal"></i> æ¨¡æ‹Ÿæ¨¡å¼æ—¥å¿—</h5>
            <button id="refreshLogBtn" class="btn btn-sm btn-secondary mb-2">
                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ—¥å¿—
            </button>
            <div class="log-viewer" id="simulationLog">
                <div class="text-muted">æš‚æ— æ—¥å¿—</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentMode = 'live';
        let refreshInterval;

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/api/broadcast/stats');
                const data = await response.json();

                // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
                currentMode = data.mode;
                const modeIndicator = document.getElementById('modeIndicator');

                if (data.simulation_mode) {
                    modeIndicator.innerHTML = `
                        <span class="mode-indicator mode-simulation">
                            <i class="bi bi-file-earmark-play"></i> æ¨¡æ‹Ÿæ¨¡å¼ - ä¸ä¼šå®é™…å‘é€å¹¿æ’­
                        </span>
                    `;
                    document.getElementById('simulationLogPanel').style.display = 'block';
                } else if (data.test_mode) {
                    modeIndicator.innerHTML = `
                        <span class="mode-indicator mode-test">
                            <i class="bi bi-shield-check"></i> æµ‹è¯•æ¨¡å¼ - ç™½åå•: ${data.test_whitelist_count} IPï¼Œæœ€å¤š ${data.max_test_clients} å®¢æˆ·ç«¯
                        </span>
                    `;
                } else {
                    modeIndicator.innerHTML = `
                        <span class="mode-indicator mode-live">
                            <i class="bi bi-broadcast"></i> æ­£å¼æ¨¡å¼ - å…¨çƒå¹¿æ’­
                        </span>
                    `;
                }

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('activeCount').textContent = data.active_broadcasts || 0;
                document.getElementById('clientCount').textContent = data.connected_clients || 0;
                document.getElementById('historyCount').textContent = data.broadcast_history_count || 0;
                document.getElementById('logCount').textContent = data.simulation_log_count || 0;

            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ´»è·ƒå¹¿æ’­
        async function loadActiveBroadcasts() {
            try {
                const response = await fetch('/api/broadcast/active');
                const result = await response.json();

                const container = document.getElementById('activeBroadcasts');

                if (!result.success || result.count === 0) {
                    container.innerHTML = '<p class="text-muted">å½“å‰æ²¡æœ‰æ´»è·ƒå¹¿æ’­</p>';
                    return;
                }

                container.innerHTML = result.broadcasts.map(bc => `
                    <div class="broadcast-card level-${bc.level}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>${bc.title} <span class="badge bg-danger">Level ${bc.level}</span></h6>
                                <small class="text-muted">
                                    ID: ${bc.broadcast_id} | æ¨¡å¼: ${bc.mode} |
                                    å®¢æˆ·ç«¯: ${bc.connected_clients} |
                                    æ—¶é•¿: ${Math.floor(bc.duration)}ç§’
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="stopBroadcast('${bc.broadcast_id}')">
                                <i class="bi bi-stop-circle"></i> åœæ­¢
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('åŠ è½½æ´»è·ƒå¹¿æ’­å¤±è´¥:', error);
            }
        }

        // åŠ è½½å·²è¿æ¥å®¢æˆ·ç«¯
        async function loadClients() {
            try {
                const response = await fetch('/api/broadcast/clients');
                const result = await response.json();

                const container = document.getElementById('connectedClients');
                const countText = document.getElementById('clientCountText');

                countText.textContent = result.count || 0;

                if (!result.success || result.count === 0) {
                    container.innerHTML = '<p class="text-muted">å½“å‰æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>å®¢æˆ·ç«¯ID</th>
                                    <th>IPåœ°å€</th>
                                    <th>è®¾å¤‡ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å½“å‰å¹¿æ’­</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.clients.map(client => `
                                    <tr>
                                        <td><code>${client.client_id}</code></td>
                                        <td>${client.ip_address}</td>
                                        <td>${client.device_info.type || 'unknown'}</td>
                                        <td><span class="badge bg-success">${client.status}</span></td>
                                        <td>${client.current_broadcast || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·ç«¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ¨¡æ‹Ÿæ—¥å¿—
        async function loadSimulationLog() {
            if (currentMode !== 'simulation') return;

            try {
                const response = await fetch('/api/broadcast/simulation-log?limit=50');
                const result = await response.json();

                const logContainer = document.getElementById('simulationLog');

                if (!result.success || result.total === 0) {
                    logContainer.innerHTML = '<div class="text-muted">æš‚æ— æ—¥å¿—</div>';
                    return;
                }

                logContainer.innerHTML = result.logs.map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    return `
                        <div class="log-entry">
                            <span class="timestamp">[${timestamp}]</span>
                            <span class="action">${log.action}</span>:
                            ${JSON.stringify(log, null, 2).substring(0, 200)}...
                        </div>
                    `;
                }).join('');

                // æ»šåŠ¨åˆ°åº•éƒ¨
                logContainer.scrollTop = logContainer.scrollHeight;

            } catch (error) {
                console.error('åŠ è½½æ¨¡æ‹Ÿæ—¥å¿—å¤±è´¥:', error);
            }
        }

        // å¯åŠ¨å¹¿æ’­
        async function startBroadcast(event) {
            event.preventDefault();

            const title = document.getElementById('broadcastTitle').value;
            const level = parseInt(document.getElementById('broadcastLevel').value);
            const content = document.getElementById('broadcastContent').value;
            const duration = parseInt(document.getElementById('broadcastDuration').value);

            if (!confirm(`ç¡®å®šè¦å¯åŠ¨ Level ${level} å¹¿æ’­å—ï¼Ÿ\n\næ ‡é¢˜: ${title}\næ¨¡å¼: ${currentMode}`)) {
                return;
            }

            try {
                const response = await fetch('/api/broadcast/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: title,
                        level: level,
                        content_type: 'message',
                        content: content,
                        duration: duration
                    })
                });

                const result = await response.json();

                if (result.success || result.mode === 'simulation') {
                    alert(`âœ… å¹¿æ’­å·²å¯åŠ¨ï¼\n\nID: ${result.broadcast_id}\næ¨¡å¼: ${result.mode || currentMode}\n${result.message || ''}`);
                    loadStats();
                    loadActiveBroadcasts();
                    if (currentMode === 'simulation') {
                        loadSimulationLog();
                    }
                } else {
                    alert(`âŒ å¯åŠ¨å¹¿æ’­å¤±è´¥: ${result.error}`);
                }

            } catch (error) {
                console.error('å¯åŠ¨å¹¿æ’­å¤±è´¥:', error);
                alert('å¯åŠ¨å¹¿æ’­å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢å¹¿æ’­
        async function stopBroadcast(broadcastId) {
            if (!confirm(`ç¡®å®šè¦åœæ­¢å¹¿æ’­ ${broadcastId} å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/api/broadcast/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({broadcast_id: broadcastId})
                });

                const result = await response.json();

                if (result.success) {
                    alert(`âœ… å¹¿æ’­å·²åœæ­¢ï¼\n\næŒç»­æ—¶é—´: ${Math.floor(result.duration)}ç§’`);
                    loadStats();
                    loadActiveBroadcasts();
                    if (currentMode === 'simulation') {
                        loadSimulationLog();
                    }
                } else {
                    alert(`âŒ åœæ­¢å¹¿æ’­å¤±è´¥: ${result.error}`);
                }

            } catch (error) {
                console.error('åœæ­¢å¹¿æ’­å¤±è´¥:', error);
                alert('åœæ­¢å¹¿æ’­å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAll() {
            loadStats();
            loadActiveBroadcasts();
            loadClients();
            if (currentMode === 'simulation') {
                loadSimulationLog();
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('broadcastForm').addEventListener('submit', startBroadcast);
        document.getElementById('refreshLogBtn').addEventListener('click', loadSimulationLog);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();

            // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
            refreshInterval = setInterval(refreshAll, 5000);

            console.log('ğŸš€ å…¨çƒå¹¿æ’­ç³»ç»Ÿå·²å¯åŠ¨');
        });
    </script>
</body>
</html>
